<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rice Inventory Management System</title>
  <meta name="description" content="A simple, cloud-synced system for managing rice sales, inventory, and profit tracking.">
  
  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isBetween.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-dayjs-3@latest/dist/chartjs-adapter-dayjs-3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

  <!-- FIREBASE SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    /* Custom CSS Variables for easy theming */
    :root {
      --primary: #3b82f6; /* Blue-500 */
      --secondary: #10b981; /* Green-500 */
      --accent: #f59e0b; /* Amber-500 */
      --light: #f8fafc; /* Slate-50 */
      --dark: #1e293b; /* Slate-800 */
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background-color: var(--light); 
      color: #334155; /* Slate-700 */
      margin: 0;
    }
    
    /* View Transition Styling */
    .main-view { 
      display: none; 
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .main-view.active { 
      display: block; 
    }

    /* --- ENHANCED: Modern & Professional Table Styling --- */
    .professional-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      font-size: 14px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      border-radius: 8px;
      overflow: hidden;
    }

    .professional-table thead tr {
        background-color: #f8fafc; /* Slate-50 */
        color: #334155; /* Slate-700 */
        text-align: center;
        font-weight: 600;
        border-bottom: 2px solid #e2e8f0; /* Slate-200 */
    }
    
    /* --- Sticky Table Header --- */
    .professional-table thead th {
        position: sticky;
        top: 0;
        z-index: 20;
        background-color: #f8fafc;
    }

    .professional-table th,
    .professional-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #e2e8f0; /* Slate-200 */
    }
    
    /* Align numbers to the right for easier reading */
    .professional-table td:not(:first-child),
    .professional-table th:not(:first-child) {
        text-align: right;
    }

    .professional-table td:first-child,
    .professional-table th:first-child {
        text-align: left;
    }

    /* Remove bottom border from last row for cleaner look */
    .professional-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    /* --- Modern Category Header Styling --- */
    .category-header td {
        font-size: 1rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #fff;
        border: none;
        text-align: left;
        padding-left: 1.5rem;
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
    }
    
    .category-header-25-KG { background-color: #3b82f6; }
    .category-header-10-KG { background-color: #10b981; }
    .category-header-5-KG { background-color: #8b5cf6; }
    .category-header-Per-Kilo { background-color: #f59e0b; }

    /* --- Category Subheader for Alignment --- */
    .category-subheader th {
        background-color: #f1f5f9; /* Slate-100 */
        padding: 10px 15px;
        font-size: 12px;
        font-weight: 600;
        color: #475569; /* Slate-600 */
        text-transform: uppercase;
        border-bottom: 2px solid #e2e8f0;
    }

    /* --- ENHANCED: Footer Row Styling --- */
    .category-total-row {
        font-weight: 700;
        background-color: #f1f5f9; /* Slate-100 */
    }

    .grand-total-row {
        font-size: 1.125rem;
        font-weight: 700;
        background-color: #1e293b; /* Slate-800 */
        color: #fff;
        position: sticky;
        bottom: 0;
        z-index: 10;
    }
    .grand-total-row td {
        border-bottom: none;
    }


    /* Input Styling */
    input[type="number"], input[type="text"], input[type="password"], input[type="date"], input[type="month"], select { 
      width: 100%; 
      padding: 6px; 
      font-size: 13px; 
      box-sizing: border-box; 
      border-radius: 4px; 
      border: 1px solid #cbd5e1; /* Slate-300 */
      transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s;
    }
    
    input[type="number"]:focus, input[type="text"]:focus, input[type="password"]:focus, input[type="date"]:focus, input[type="month"]:focus, select:focus {
      outline: none;
    }
    
    /* --- Color-coded input boxes for easy identification --- */
    .new-stock-input {
        background-color: #eff6ff; /* Blue-50 */
        border-color: #93c5fd; /* Blue-300 */
    }
    .new-stock-input:focus {
        background-color: #ffffff; /* Revert to white on focus for better text visibility */
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
    
    .open-sacks-add-input {
        background-color: #fffbeb; /* Amber-50 */
        border-color: #fcd34d; /* Amber-300 */
    }
    .open-sacks-add-input:focus {
        background-color: #ffffff;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
    }

    .end-input {
        background-color: #f0fdf4; /* Green-50 */
        border-color: #86efac; /* Green-300 */
    }
    .end-input:focus {
        background-color: #ffffff;
        border-color: var(--secondary);
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
    }

    input.invalid {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2) !important;
    }
    
    input:disabled { 
      background-color: #f8fafc;
      color: #64748b;
      border: 1px solid #e2e8f0;
      cursor: not-allowed; 
    }
    
    /* Loader Animation */
    .loader { 
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary); 
      border-radius: 50%; 
      width: 30px; 
      height: 30px; 
      animation: spin 1s linear infinite; 
      margin: 0 auto; 
    }
    
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    
    /* Button loader */
    .btn-loader {
        border: 2px solid #f3f3f3;
        border-top: 2px solid var(--primary);
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 8px;
    }


    /* --- NEW: Full-page loader for initialization --- */
    #app-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      transition: opacity 0.3s ease-in-out;
    }
    #app-loader.hidden {
      opacity: 0;
      pointer-events: none;
    }
    #app-loader p {
      margin-top: 1rem;
      font-weight: 500;
      color: var(--dark);
    }
    
    #settings-panel { 
      transition: transform 0.3s ease-in-out; 
      transform: translateX(100%);
      box-shadow: -5px 0 15px rgba(0,0,0,0.1);
    }
    
    #settings-panel.open { 
      transform: translateX(0); 
    }
    
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px rgba(0,0,0,0.1);
    }
    
    .nav-tab {
      padding: 10px 16px;
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
      user-select: none;
    }
    
    .nav-tab.active {
      background-color: var(--primary);
      color: white;
    }
    
    .settings-tab {
      padding: 8px 14px;
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
      user-select: none;
      border: 1px solid #e2e8f0;
      background-color: #f8fafc;
      color: #475569;
    }

    .settings-tab:hover {
      background-color: #e2e8f0;
      color: #1e293b;
    }

    .settings-tab.active {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .analytics-tab {
        padding: 8px 14px;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.2s;
        cursor: pointer;
        user-select: none;
        border: 1px solid #e2e8f0;
        background-color: #f8fafc;
        color: #475569;
    }

    .analytics-tab:hover {
        background-color: #e2e8f0;
        color: #1e293b;
    }

    .analytics-tab.active {
        background-color: var(--primary);
        color: white;
        border-color: var(--primary);
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 500;
      transition: background-color 0.2s;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-primary:hover {
      background-color: #2563eb;
    }
    
    .btn-success {
      background-color: var(--secondary);
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 500;
      transition: background-color 0.2s;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-success:hover {
      background-color: #059669;
    }

    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    
    .stat-card {
      padding: 20px;
      border-left: 4px solid;
    }
    
    .category-25 { border-left-color: #3b82f6; }
    .category-10 { border-left-color: #10b981; }
    .category-5 { border-left-color: #8b5cf6; }
    .category-kg { border-left-color: #f59e0b; }

    .small-edit-btn {
        background-color: #64748b;
        color: white;
        padding: 2px 8px;
        font-size: 0.7rem;
        border-radius: 4px;
        transition: background-color 0.2s ease-in-out;
        border: none;
        cursor: pointer;
        font-weight: 500;
    }
    .small-edit-btn:hover {
        background-color: #475569;
    }
    
    .row-has-sales {
        background-color: #f0fdf4;
    }
    .row-has-sales:hover {
        background-color: #dcfce7;
    }

    .row-low-stock {
        background-color: #fff1f2 !important;
        border-left: 4px solid #f43f5e;
    }
    .row-low-stock:hover {
        background-color: #ffe4e6 !important;
    }

    .row-negative-stock {
        background-color: #fecaca !important;
        border-left: 4px solid #dc2626 !important;
        font-weight: 600;
    }
    .row-negative-stock:hover {
      background-color: #fca5a5 !important;
    }
    .row-negative-stock input {
        border-color: #dc2626 !important;
    }
    
    /* --- Style for rows with a calculation/logic error --- */
    .row-logic-error {
        background-color: #fffbeb !important; /* Amber-50 */
        border-left: 4px solid #f59e0b !important; /* Amber-500 */
    }
    .row-logic-error:hover {
        background-color: #fef3c7 !important; /* Amber-100 */
    }

    .active-row {
        background-color: #dbeafe !important;
        outline: 2px solid var(--primary);
        outline-offset: -2px;
    }
    
    /* --- Style for Cash Reconciliation --- */
    .cash-short {
        color: #dc2626; /* Red-600 */
    }
    .cash-over {
        color: #166534; /* Green-800 */
    }
    .cash-balanced {
        color: #1e293b; /* Slate-800 */
    }

    @media (max-width: 768px) {
      .professional-table {
        font-size: 12px;
      }
      
      .professional-table th, .professional-table td {
        padding: 6px 8px;
      }

      /* --- MOBILE OPTIMIZATION for Sales/Profit Columns --- */
      .total-sales-val, .profit-val {
        padding: 6px 4px !important; /* Reduce padding on mobile */
        font-size: 11px !important; /* Make font slightly smaller */
        word-break: break-word;
      }
      
      .card {
        margin-bottom: 16px;
      }
      .settings-tab, .analytics-tab {
        flex-grow: 1;
        text-align: center;
      }
    }
    
    /* --- PRINT STYLES --- */
    @media print {
        body {
            padding: 0;
            background-color: #fff;
        }
        .no-print {
            display: none !important;
        }
        .main-view {
            display: block !important;
            max-width: 100%;
            margin: 0;
        }
        .professional-table {
            box-shadow: none;
            border: 1px solid #ccc;
            font-size: 10pt;
        }
        .professional-table th, .professional-table td {
            padding: 8px 10px;
        }
        .grand-total-row {
            position: static;
            color: #000;
            background-color: #eee;
        }
        .grand-total-row td {
            border-bottom: 1px solid #ccc;
        }
        #report-title {
            text-align: center;
            width: 100%;
        }
        input:disabled { /* Make disabled inputs look like text for printing */
          background-color: transparent !important;
          border: none !important;
          color: #000 !important;
        }
    }
  </style>
</head>
<body class="p-4">

  <!-- NEW: Full-page loader -->
  <div id="app-loader">
    <div class="loader"></div>
    <p id="loader-status">Initializing System...</p>
  </div>

  <!-- Shared Header -->
  <div class="max-w-7xl mx-auto mb-6 flex flex-col sm:flex-row justify-between items-center gap-4 no-print" role="banner">
    <div>
      <h1 class="text-2xl font-bold text-slate-800">Rice Inventory Management</h1>
      <p class="text-sm text-slate-500" id="header-subtitle">Current Working Day</p>
    </div>
    <div class="flex items-center gap-4">
      <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
        <span id="current-date-display" aria-live="polite"></span>
      </div>
      <button onclick="showHistory()" title="Report History" aria-label="View Report History" class="text-slate-600 hover:text-blue-600 p-2 transition-colors rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
      </button>
      <button onclick="openSettingsWithPassword()" title="Settings" aria-label="Open Settings" class="text-slate-600 hover:text-blue-600 p-2 transition-colors rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <nav class="max-w-7xl mx-auto mb-6 bg-white rounded-lg p-1 shadow-sm flex no-print" aria-label="Main Navigation">
    <button class="nav-tab active" role="tab" aria-selected="true" aria-controls="dashboard-view" onclick="showView('dashboard-view')">Dashboard</button>
    <button class="nav-tab" role="tab" aria-selected="false" aria-controls="daily-report-view" onclick="showCurrentDayReport()">Daily Report</button>
    <button class="nav-tab" role="tab" aria-selected="false" aria-controls="expenses-view" onclick="showView('expenses-view')">Expenses</button>
  </nav>

  <!-- VIEW 1: Dashboard -->
  <main id="dashboard-view" class="main-view active max-w-7xl mx-auto" role="main">
      <div id="dashboard-header" class="mb-6">
        <h2 id="dashboard-title" class="text-xl font-bold text-slate-800">Dashboard</h2>
        <p class="text-sm text-slate-500" id="dashboard-date"></p>
      </div>
      <!-- ENHANCED Dashboard Grid with Skeleton UI -->
      <div id="dashboard-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Skeleton Card 1 -->
        <div class="card p-6 flex items-center gap-6 bg-blue-50 border-l-4 border-blue-500">
            <div class="bg-blue-100 p-4 rounded-full"><svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 6V5m0 14v-1m-7-7H4m16 0h-1m-1.61-5.61l.707-.707M6.343 17.657l-.707.707m12.02-12.02l.707.707M6.343 6.343l-.707-.707"></path></svg></div>
            <div>
                <p class="text-sm text-slate-500">Today's Total Sales</p>
                <div id="dashboard-total-sales" class="animate-pulse"><div class="h-8 bg-slate-200 rounded w-32 mt-1"></div></div>
            </div>
        </div>
        <!-- Skeleton Card 2 -->
        <div class="card p-6 flex items-center gap-6 bg-yellow-50 border-l-4 border-yellow-500">
            <div class="bg-yellow-100 p-4 rounded-full"><svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2z"></path></svg></div>
            <div>
                <p class="text-sm text-slate-500">Today's Expenses</p>
                <div id="dashboard-total-expenses" class="animate-pulse"><div class="h-8 bg-slate-200 rounded w-24 mt-1"></div></div>
            </div>
        </div>
        <!-- Skeleton Card 3 -->
        <div class="card p-6 flex items-center gap-6 bg-green-50 border-l-4 border-green-500">
            <div class="bg-green-100 p-4 rounded-full"><svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg></div>
            <div>
                <p class="text-sm text-slate-500">Today's Profit</p>
                <div id="dashboard-total-profit" class="animate-pulse"><div class="h-8 bg-slate-200 rounded w-28 mt-1"></div></div>
            </div>
        </div>
        <!-- Skeleton Card 4 -->
        <div class="card p-6 flex items-center gap-6 bg-teal-50 border-l-4 border-teal-500">
            <div class="bg-teal-100 p-4 rounded-full"><svg class="w-8 h-8 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5h2m-2 2h2m-2 2h2"></path></svg></div>
            <div>
                <p class="text-sm text-slate-500">Monthly Net Profit (To Date)</p>
                <div id="dashboard-monthly-net-profit" class="animate-pulse"><div class="h-8 bg-slate-200 rounded w-36 mt-1"></div></div>
            </div>
        </div>
        <!-- Skeleton Low Stock Card -->
        <div class="card p-6 bg-red-50 border-l-4 border-red-500 md:col-span-2 lg:col-span-4">
            <h3 class="font-bold text-lg text-slate-800 mb-3">Items Needing Restock</h3>
            <div id="low-stock-list" class="space-y-2 max-h-48 overflow-y-auto">
              <div class="animate-pulse flex justify-between items-center text-sm p-2 bg-white rounded">
                  <div class="h-4 bg-slate-200 rounded w-2/5"></div>
                  <div class="h-4 bg-slate-200 rounded w-1/5"></div>
              </div>
              <div class="animate-pulse flex justify-between items-center text-sm p-2 bg-white rounded">
                  <div class="h-4 bg-slate-200 rounded w-1/2"></div>
                  <div class="h-4 bg-slate-200 rounded w-1/6"></div>
              </div>
            </div>
        </div>
      </div>
  </main>


  <!-- VIEW 2: Daily Report / Inventory -->
  <div id="daily-report-view" class="main-view max-w-7xl mx-auto" role="main" aria-labelledby="report-title">
    <div class="mb-6 p-5 bg-white rounded-lg shadow-sm flex flex-wrap justify-between items-center gap-4">
      <div class="flex items-center gap-4">
        <h2 id="report-title" class="text-xl font-bold text-slate-800">Daily Inventory Report</h2>
      </div>
      <button onclick="window.print()" class="btn-primary no-print" aria-label="Print this report">
        Print Report
      </button>
    </div>
    
    <div class="overflow-hidden">
      <div class="overflow-x-auto">
        <table class="professional-table" aria-live="polite" aria-atomic="true">
          <thead>
            <tr>
              <th>PRODUCT</th>
              <th>BEGIN <br><button class="small-edit-btn mt-1 no-print" onclick="promptForCategoryThenEdit('begin')" aria-label="Edit all beginning stock">EDIT ALL</button></th>
              <th>NEW STOCK</th>
              <th>OPEN SACKS</th>
              <th>ENDING</th>
              <th>SOLD</th>
              <th>PRICE (₱) <br><button class="small-edit-btn mt-1 no-print" onclick="promptForCategoryThenEdit('price')" aria-label="Edit all prices">EDIT ALL</button></th>
              <th>TOTAL SALES (₱)</th>
              <th>PROFIT (₱)</th>
            </tr>
          </thead>
          <tbody id="inventory-tbody">
            <tr><td colspan="9" class="text-center p-4"><div class="loader" role="status" aria-label="Loading inventory report"></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- VIEW 3: Expenses -->
    <div id="expenses-view" class="main-view max-w-7xl mx-auto" role="main" aria-labelledby="expenses-title">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Left Side: Add Expense Form -->
            <div class="md:col-span-1">
                <div class="card p-6">
                    <h3 id="expense-form-title" class="text-lg font-bold text-slate-800 mb-4">Add Expense for Today</h3>
                    <div class="space-y-4">
                        <input type="hidden" id="expense-id">
                        <div>
                            <label for="expense-description" class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                            <input id="expense-description" type="text" placeholder="e.g., Transportation" class="border border-slate-300 p-2 w-full rounded-md" aria-required="true">
                        </div>
                        <div>
                            <label for="expense-amount" class="block text-sm font-medium text-slate-700 mb-1">Amount (₱)</label>
                            <input id="expense-amount" type="number" step="0.01" placeholder="e.g., 150.00" class="border border-slate-300 p-2 w-full rounded-md" oninput="validateNumberInput(this)" aria-required="true">
                        </div>
                        <div class="flex gap-2">
                            <button id="save-expense-btn" onclick="saveExpense()" class="btn-success flex-1">Save Expense</button>
                            <button onclick="clearExpenseForm()" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-md flex-1 hover:bg-slate-300 transition-colors">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Right Side: Expense List -->
            <div class="md:col-span-2">
                <div class="card p-6">
                    <h2 id="expenses-title" class="text-xl font-bold text-slate-800 mb-4">Today's Expenses</h2>
                    <div id="expense-list-container" class="space-y-2 max-h-96 overflow-y-auto" aria-live="polite" aria-atomic="true">
                        <p class="text-center text-slate-500 py-8">No expenses recorded for today.</p>
                    </div>
                    <div class="mt-4 pt-4 border-t font-bold text-lg flex justify-between">
                        <span>Total Expenses:</span>
                        <span id="total-expenses-display">₱0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

  <!-- VIEW 5: Report History -->
  <div id="history-view" class="main-view max-w-7xl mx-auto" role="region" aria-labelledby="history-title">
    <div class="mb-6 flex items-center gap-4">
      <h2 id="history-title" class="text-xl font-bold text-slate-700">Report History</h2>
    </div>
    
    <div class="mb-4 flex flex-col sm:flex-row items-center gap-4">
      <input type="text" id="history-search" placeholder="Search reports by date or content..." class="border border-slate-300 rounded-md py-2 px-3 flex-grow" oninput="filterHistory()" aria-label="Search report history">
      <select id="history-sort" class="border border-slate-300 rounded-md py-2 px-3" onchange="filterHistory()" aria-label="Sort report history">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
      </select>
    </div>
    
    <div id="history-list" class="bg-white rounded-lg shadow divide-y" aria-live="polite" aria-atomic="true">
      <div class="p-4 text-center text-slate-500"><div class="loader" role="status" aria-label="Loading reports"></div></div>
    </div>
  </div>
  
  <!-- Settings Panel -->
  <div id="settings-panel" class="fixed top-0 right-0 h-full w-full max-w-2xl bg-white shadow-lg z-50 p-6 overflow-y-auto no-print" role="dialog" aria-modal="true" aria-labelledby="settings-title" tabindex="-1">
    <div class="flex justify-between items-center mb-6">
      <h2 id="settings-title" class="text-2xl font-bold text-slate-800">Settings</h2>
      <button onclick="closeSettingsPanel()" class="text-slate-500 hover:text-red-500 text-3xl transition-colors rounded-full focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50" aria-label="Close settings panel">&times;</button>
    </div>
    
    <!-- Settings Tabs -->
    <div class="mb-6 flex flex-wrap gap-2" role="tablist">
      <button id="tab-product-management" class="settings-tab active" role="tab" aria-selected="true" aria-controls="settings-product-management-content" onclick="showSettingsTab('settings-product-management-content')">Product Management</button>
      <button id="tab-performance" class="settings-tab" role="tab" aria-selected="false" aria-controls="settings-performance-content" onclick="showSettingsTab('settings-performance-content')">Performance</button>
      <button id="tab-analytics" class="settings-tab" role="tab" aria-selected="false" aria-controls="settings-analytics-content" onclick="showSettingsTab('settings-analytics-content')">Analytics</button>
      <button id="tab-security" class="settings-tab" role="tab" aria-selected="false" aria-controls="settings-security-content" onclick="showSettingsTab('settings-security-content')">Security</button>
      <button id="tab-data-management" class="settings-tab" role="tab" aria-selected="false" aria-controls="settings-data-management-content" onclick="showSettingsTab('settings-data-management-content')">Data Management</button>
    </div>

    <!-- Settings Content Sections -->
    <div id="settings-product-management-content" class="settings-tab-content" role="tabpanel" aria-labelledby="tab-product-management">
      <div class="p-4 border rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-3 sr-only">Product Management</h3>
        <div id="product-list-container" class="space-y-2 mb-4 max-h-64 overflow-y-auto border p-2 rounded bg-slate-50" aria-live="polite" aria-atomic="true">
          <p class="text-center text-slate-500">No products added yet.</p>
        </div>
        
        <div class="p-3 bg-slate-50 rounded border">
          <h4 id="product-form-title" class="font-semibold mb-2">Add New Product</h4>
          <input type="hidden" id="product-id">
          <div class="space-y-3">
            <div>
              <label for="product-name" class="block text-sm font-medium text-slate-700 mb-1">Product Name</label>
              <input id="product-name" type="text" placeholder="e.g., Kylo" class="border border-slate-300 p-2 w-full rounded-md" aria-required="true">
            </div>
            <div>
              <label for="product-price" class="block text-sm font-medium text-slate-700 mb-1">Selling Price (₱)</label>
              <input id="product-price" type="number" step="0.01" placeholder="e.g., 1300.00" class="border border-slate-300 p-2 w-full rounded-md" oninput="validateNumberInput(this)" aria-required="true">
            </div>
            <div>
              <label for="product-cost" class="block text-sm font-medium text-slate-700 mb-1">Cost Price / Capital (₱)</label>
              <input id="product-cost" type="number" step="0.01" placeholder="e.g., 1150.00" class="border border-slate-300 p-2 w-full rounded-md" oninput="validateNumberInput(this)" aria-required="true">
            </div>
            <div>
              <label for="product-minstock" class="block text-sm font-medium text-slate-700 mb-1">Minimum Stock Level</label>
              <input id="product-minstock" type="number" placeholder="e.g., 5" class="border border-slate-300 p-2 w-full rounded-md" oninput="validateNumberInput(this, true)" aria-required="true">
            </div>
            <div>
              <label for="product-category" class="block text-sm font-medium text-slate-700 mb-1">Category</label>
              <select id="product-category" class="border border-slate-300 p-2 w-full rounded-md" aria-required="true">
                <option value="25 KG">25 KG</option>
                <option value="10 KG">10 KG</option>
                <option value="5 KG">5 KG</option>
                <option value="Per Kilo">Per Kilo</option>
              </select>
            </div>
            <div class="flex gap-2">
              <button id="save-product-btn" onclick="saveProduct()" class="btn-success flex-1">Save Product</button>
              <button onclick="clearProductForm()" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-md flex-1 hover:bg-slate-300 transition-colors">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- UPDATED: Performance Breakdown Content -->
    <div id="settings-performance-content" class="settings-tab-content hidden" role="tabpanel" aria-labelledby="tab-performance">
      <!-- NEW: Remaining Stock Value Card -->
      <div class="card p-6 mb-6" id="remaining-stock-summary">
        <h3 class="text-xl font-bold text-slate-700 mb-4">Today's Remaining Stock Value</h3>
        <div class="space-y-3" aria-live="polite">
            <div class="flex justify-between items-center text-blue-700"><span class="font-medium">25 KG</span><span id="stock-value-25-KG" class="font-semibold">₱0.00</span></div>
            <div class="flex justify-between items-center text-green-700"><span class="font-medium">10 KG</span><span id="stock-value-10-KG" class="font-semibold">₱0.00</span></div>
            <div class="flex justify-between items-center text-purple-700"><span class="font-medium">5 KG</span><span id="stock-value-5-KG" class="font-semibold">₱0.00</span></div>
            <div class="flex justify-between items-center text-amber-700"><span class="font-medium">Per Kilo</span><span id="stock-value-Per-Kilo" class="font-semibold">₱0.00</span></div>
            <hr class="my-2">
            <div class="flex justify-between items-center text-slate-800"><span class="font-bold text-lg">Grand Total</span><span id="stock-value-grand-total" class="font-bold text-lg">₱0.00</span></div>
        </div>
        <p class="text-xs text-slate-400 mt-3">This value updates in real-time as you edit the "Ending" stock in the Daily Report.</p>
      </div>
        
      <h3 class="text-xl font-bold text-slate-700 mb-4">Daily Performance Breakdown</h3>
      <input type="text" id="performance-search" placeholder="Search transactions by date (e.g., Sep 30)..." class="w-full border border-slate-300 rounded-md py-2 px-3 mb-4" oninput="filterPerformanceTable()">
      <div class="overflow-y-auto max-h-[60vh]">
        <table class="w-full text-sm text-left text-slate-500">
            <thead class="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0">
                <tr>
                    <th scope="col" class="py-3 px-6">Date</th>
                    <th scope="col" class="py-3 px-6 text-right">Total Sales</th>
                    <th scope="col" class="py-3 px-6 text-right">Cash on Hand</th>
                    <th scope="col" class="py-3 px-6 text-right">Difference</th>
                    <th scope="col" class="py-3 px-6 text-center">Actions</th>
                </tr>
            </thead>
            <tbody id="performance-tbody">
                <tr><td colspan="5" class="text-center p-4"><div class="loader"></div></td></tr>
            </tbody>
        </table>
      </div>
    </div>

    <div id="settings-security-content" class="settings-tab-content hidden" role="tabpanel" aria-labelledby="tab-security">
      <div class="p-4 border rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-3 sr-only">Security</h3>
        <div class="space-y-3">
          <div>
            <label for="currentPassword" class="block text-sm font-medium text-slate-700 mb-1">Current Password</label>
            <input id="currentPassword" type="password" class="border border-slate-300 p-2 w-full rounded-md" autocomplete="current-password">
          </div>
          <div>
            <label for="newPassword" class="block text-sm font-medium text-slate-700 mb-1">New Password</label>
            <input id="newPassword" type="password" class="border border-slate-300 p-2 w-full rounded-md" autocomplete="new-password">
          </div>
          <div>
            <label for="confirmPassword" class="block text-sm font-medium text-slate-700 mb-1">Confirm New Password</label>
            <input id="confirmPassword" type="password" class="border border-slate-300 p-2 w-full rounded-md" autocomplete="new-password">
          </div>
        </div>
        <button onclick="savePassword()" class="btn-primary w-full mt-4">Change Password</button>
      </div>
    </div>
    
    <!-- Analytics Content -->
    <div id="settings-analytics-content" class="settings-tab-content hidden" role="tabpanel" aria-labelledby="tab-analytics">
      <div class="mb-6 flex items-center gap-4">
        <h3 class="text-xl font-bold text-slate-700">Sales Analytics</h3>
      </div>

      <!-- Analytics Sub-Tabs -->
      <div class="mb-6 flex flex-wrap gap-2" role="tablist">
        <button id="tab-analytics-overview" class="analytics-tab active" role="tab" aria-selected="true" aria-controls="analytics-overview-content" onclick="showAnalyticsSubTab('analytics-overview-content')">Sales Overview</button>
        <button id="tab-analytics-financial-summary" class="analytics-tab" role="tab" aria-selected="false" aria-controls="analytics-financial-summary-content" onclick="showAnalyticsSubTab('analytics-financial-summary-content')">Financial Summary</button>
        <button id="tab-analytics-products" class="analytics-tab" role="tab" aria-selected="false" aria-controls="analytics-products-content" onclick="showAnalyticsSubTab('analytics-products-content')">Products</button>
      </div>
      
      <!-- Analytics Content: Overview Sub-Tab -->
      <div id="analytics-overview-content" class="analytics-tab-content" role="tabpanel" aria-labelledby="tab-analytics-overview">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="card p-6">
            <h4 class="text-lg font-bold text-slate-800 mb-4">Report Options</h4>
            <div class="space-y-3">
              <div>
                <label for="analytics-mode-select" class="block text-sm font-medium text-slate-700 mb-1">Select Report Type</label>
                <select id="analytics-mode-select" class="w-full border border-slate-300 rounded-md py-2 px-3" onchange="toggleAnalyticsDateInputs()">
                  <option value="daily">Daily Breakdown</option>
                  <option value="range">Date Range Report</option>
                </select>
              </div>

              <div id="daily-date-input">
                <label for="analytics-single-date" class="block text-sm font-medium text-slate-700 mb-1">Select Date</label>
                <input type="date" id="analytics-single-date" class="w-full border border-slate-300 rounded-md py-2 px-3">
              </div>

              <div id="range-date-inputs" class="hidden">
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label for="analytics-from-date" class="block text-sm font-medium text-slate-700 mb-1">From Date</label>
                    <input type="date" id="analytics-from-date" class="w-full border border-slate-300 rounded-md py-2 px-3">
                  </div>
                  <div>
                    <label for="analytics-to-date" class="block text-sm font-medium text-slate-700 mb-1">To Date</label>
                    <input type="date" id="analytics-to-date" class="w-full border border-slate-300 rounded-md py-2 px-3">
                  </div>
                </div>
              </div>
            </div>
            <button onclick="loadAnalytics()" class="w-full btn-primary mt-4">Generate Report</button>
          </div>
          
          <div class="card p-6" aria-live="polite" aria-atomic="true">
            <h4 class="text-lg font-bold text-slate-800 mb-4">Summary</h4>
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-slate-600">Total Sales</span>
                <span id="analytics-total-sales" class="font-semibold">₱0.00</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-slate-600">Total Profit</span>
                <span id="analytics-total-profit" class="font-semibold">₱0.00</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-slate-600">Average Daily Sales</span>
                <span id="analytics-avg-sales" class="font-semibold">₱0.00</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-slate-600">Average Profit Margin</span>
                <span id="analytics-avg-margin" class="font-semibold">0%</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- UPDATED: Financial Summary Sub-Tab -->
      <div id="analytics-financial-summary-content" class="analytics-tab-content hidden" role="tabpanel" aria-labelledby="tab-analytics-financial-summary">
        <div class="card p-6 mb-6">
            <h4 class="text-lg font-bold text-slate-800 mb-4">Monthly Financial Summary</h4>
            <div class="max-w-xs">
                <label for="financial-month-select" class="block text-sm font-medium text-slate-700 mb-1">Select Month</label>
                <input type="month" id="financial-month-select" class="w-full border border-slate-300 rounded-md py-2 px-3" onchange="loadFinancialSummary()">
            </div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6" aria-live="polite">
            <div class="card p-4 bg-blue-50"><p class="text-sm text-slate-500">Total Sales</p><p id="fs-total-sales" class="text-2xl font-bold text-slate-800">₱0.00</p></div>
            <div class="card p-4 bg-orange-50"><p class="text-sm text-slate-500">Cost of Goods Sold</p><p id="fs-total-cogs" class="text-2xl font-bold text-slate-800">₱0.00</p></div>
            <div class="card p-4 bg-cyan-50"><p class="text-sm text-slate-500">Gross Profit</p><p id="fs-gross-profit" class="text-2xl font-bold text-slate-800">₱0.00</p></div>
            <div class="card p-4 bg-yellow-50"><p class="text-sm text-slate-500">Expenses</p><p id="fs-total-expenses" class="text-2xl font-bold text-slate-800">₱0.00</p></div>
            <div class="card p-4 bg-purple-50"><p class="text-sm text-slate-500">Capital for New Stock</p><p id="fs-new-stock-cost" class="text-2xl font-bold text-slate-800">₱0.00</p></div>
            <div class="card p-4 bg-green-50"><p class="text-sm text-green-800 font-bold">Net Profit (Take-Home)</p><p id="fs-net-profit" class="text-3xl font-bold text-green-700">₱0.00</p></div>
        </div>
        <div class="card p-6">
            <h4 class="text-lg font-bold text-slate-800 mb-4">Daily Money Flow (Sales vs. Reinvestment & Profit)</h4>
            <canvas id="moneyFlowChart" height="250" role="img" aria-label="Daily Money Flow Chart"></canvas>
        </div>
      </div>
      
      <!-- Analytics Content: Products Sub-Tab -->
      <div id="analytics-products-content" class="analytics-tab-content hidden" role="tabpanel" aria-labelledby="tab-analytics-products">
          <div class="card p-6 mb-6">
            <h4 class="text-lg font-bold text-slate-800 mb-4">Top Performing Products</h4>
            <p class="text-sm text-slate-500">Use the "Sales Overview" tab to select a date range for this report.</p>
          </div>
          <div id="analytics-top-products" class="space-y-3">
            <p class="text-center text-slate-500 py-4">Generate a report in "Sales Overview" to see product performance.</p>
          </div>
      </div>
    </div>

    <div id="settings-data-management-content" class="settings-tab-content hidden" role="tabpanel" aria-labelledby="tab-data-management">
      <div class="p-4 border rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-3 sr-only">Data Management</h3>
        <p class="text-sm text-slate-500 mb-4">Data is now stored in the cloud. Backups can be managed within the Google Firebase console for your project.</p>
        <div class="space-y-3">
          <button onclick="resetData()" class="w-full bg-red-100 text-red-700 hover:bg-red-200 py-2 px-4 rounded transition">
            Reset All Data (DANGEROUS)
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- FIREBASE INITIALIZATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyAeu-G3dsrumVJxpXUa0TKtJbCnpxs5UBA",
      authDomain: "bigasan-e89a7.firebaseapp.com",
      projectId: "bigasan-e89a7",
      storageBucket: "bigasan-e89a7.firebasestorage.app",
      messagingSenderId: "346505786480",
      appId: "1:346505786480:web:c33250ea0975ff192970b5"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // --- Constants ---
    const APP_VERSION = 1.0;
    const RICE_CATEGORIES = ['25 KG', '10 KG', '5 KG', 'Per Kilo'];
    const HASH_SALT = 'rice-inventory-management-salt'; 
    
    dayjs.extend(dayjs_plugin_isBetween);

    const Toast = Swal.mixin({ 
        toast: true, 
        position: 'top-end', 
        showConfirmButton: false, 
        timer: 3000, 
        timerProgressBar: true 
    });

    // Global variables
    let shopProducts = [];
    let todayDateString;
    let moneyFlowChartInstance = null;
    let calculationTimeout;
    let reportListener = null;
    let expensesListener = null;
    let isTableRendered = false;

    // --- Utility Functions ---

    async function initializeApp() {
        try {
            await runMigrations();

            const settingsDoc = await db.collection('settings').doc('main').get();
            let workingDate;
            if (settingsDoc.exists && settingsDoc.data().workingDate) {
                workingDate = settingsDoc.data().workingDate;
            } else {
                workingDate = dayjs().format('YYYY-MM-DD');
                await db.collection('settings').doc('main').set({ workingDate: workingDate }, { merge: true });
            }
            todayDateString = workingDate;
            
            document.getElementById('current-date-display').textContent = dayjs(todayDateString).format('MMMM D, YYYY');
            document.getElementById('header-subtitle').textContent = `Current Working Day`;

            await loadProducts(); 
            renderProductList(); 

            document.getElementById('analytics-single-date').value = todayDateString;
            document.getElementById('analytics-from-date').value = dayjs(todayDateString).subtract(7, 'day').format('YYYY-MM-DD');
            document.getElementById('analytics-to-date').value = todayDateString;
            document.getElementById('financial-month-select').value = dayjs(todayDateString).format('YYYY-MM');
            toggleAnalyticsDateInputs(); 

            showView('dashboard-view');

            document.getElementById('app-loader').classList.add('hidden');
        } catch (error) {
            console.error("Critical Error during App Initialization:", error);
            document.getElementById('loader-status').textContent = 'Error: Could not start application.';
            Swal.fire({
                icon: 'error',
                title: 'Application Failed to Start',
                text: 'Could not connect to the database. Please check your internet connection and Firebase setup.',
                allowOutsideClick: false
            });
        }
    }

    function validateNumberInput(inputElement, allowZero = false) {
        if (inputElement.value.trim() === '') {
            inputElement.classList.remove('invalid');
            return true;
        }
        const value = parseFloat(inputElement.value);
        if (isNaN(value) || value < 0 || (!allowZero && value === 0)) {
            inputElement.classList.add('invalid');
            return false;
        } else {
            inputElement.classList.remove('invalid');
            return true;
        }
    }

    function formatCurrency(amount) {
        const num = parseFloat(amount);
        return isNaN(num) ? '0.00' : num.toFixed(2);
    }
    
    function hashPassword(password) {
        return CryptoJS.SHA256(password + HASH_SALT).toString();
    }


    // --- Data Management Functions (Firestore) ---

    async function runMigrations() {
        const loaderStatus = document.getElementById('loader-status');
        const settingsRef = db.collection('settings').doc('app_version');
        const doc = await settingsRef.get();
        const currentVersion = doc.exists ? doc.data().version : 0;

        if (currentVersion < APP_VERSION) {
            loaderStatus.textContent = 'Migrating data...';
            
            const productsSnapshot = await db.collection('products').get();
            if (productsSnapshot.empty) {
                const defaultProducts = [
                    {id: 'prod_1', name: 'KYLO', price: 1300, cost: 1150, category: '25 KG', minStock: 5}, {id: 'prod_2', name: 'HASMIN AROMA', price: 1350, cost: 1200, category: '25 KG', minStock: 5}, {id: 'prod_3', name: 'ALAS', price: 1250, cost: 1100, category: '25 KG', minStock: 5}, {id: 'prod_4', name: 'YOUNG MASTER', price: 1280, cost: 1130, category: '25 KG', minStock: 5}, {id: 'prod_5', name: 'BLUE HARVEST', price: 1320, cost: 1170, category: '25 KG', minStock: 5}, {id: 'prod_6', name: 'PRINCESS BEA', price: 1270, cost: 1120, category: '25 KG', minStock: 5}, {id: 'prod_7', name: 'ALAS', price: 550, cost: 480, category: '10 KG', minStock: 10}, {id: 'prod_8', name: 'HASMIN AROMA', price: 580, cost: 510, category: '10 KG', minStock: 10}, {id: 'prod_9', name: 'BLUE HARVEST', price: 570, cost: 500, category: '10 KG', minStock: 10}, {id: 'prod_10', name: 'YOUNG MASTER', price: 560, cost: 490, category: '10 KG', minStock: 10}, {id: 'prod_11', name: 'PRINCESS BEA', price: 540, cost: 470, category: '10 KG', minStock: 10}, {id: 'prod_12', name: 'YOUNG MASTER', price: 280, cost: 240, category: '5 KG', minStock: 15}, {id: 'prod_13', name: 'HASMIN AROMA', price: 290, cost: 250, category: '5 KG', minStock: 15}, {id: 'prod_14', name: 'ALAS', price: 270, cost: 230, category: '5 KG', minStock: 15}, {id: 'prod_15', name: 'BLUE HARVEST', price: 285, cost: 245, category: '5 KG', minStock: 15}, {id: 'prod_16', name: 'PRINCESS BEA', price: 260, cost: 220, category: '5 KG', minStock: 15}, {id: 'prod_17', name: 'KYLO', price: 55, cost: 48, category: 'Per Kilo', minStock: 20}, {id: 'prod_18', name: 'HASMIN AROMA', price: 60, cost: 52, category: 'Per Kilo', minStock: 20}, {id: 'prod_19', name: 'ALAS', price: 50, cost: 45, category: 'Per Kilo', minStock: 20}, {id: 'prod_20', name: 'YOUNG MASTER', price: 53, cost: 46, category: 'Per Kilo', minStock: 20}, {id: 'prod_21', name: 'BLUE HARVEST', price: 57, cost: 50, category: 'Per Kilo', minStock: 20}, {id: 'prod_22', name: 'PRINCESS BEA', price: 49, cost: 43, category: 'Per Kilo', minStock: 20}, {id: 'prod_23', name: 'JAZZY', price: 52, cost: 45, category: 'Per Kilo', minStock: 20}, {id: 'prod_24', name: 'BIGANTE', price: 48, cost: 41, category: 'Per Kilo', minStock: 20}, {id: 'prod_25', name: 'FARNALIZA', price: 51, cost: 44, category: 'Per Kilo', minStock: 20}, {id: 'prod_26', name: 'PILIT', price: 47, cost: 40, category: 'Per Kilo', minStock: 20}, {id: 'prod_27', name: 'BH YELLOW', price: 54, cost: 47, category: 'Per Kilo', minStock: 20}, {id: 'prod_28', name: 'SWEET RICE', price: 65, cost: 58, category: 'Per Kilo', minStock: 20}
                ];
                const batch = db.batch();
                defaultProducts.forEach(product => {
                    const docRef = db.collection('products').doc(product.id);
                    batch.set(docRef, product);
                });
                await batch.commit();
            }
            
            await settingsRef.set({ version: APP_VERSION });
            Toast.fire({ icon: 'success', title: 'Migration Successful!' });
        }
        loaderStatus.textContent = 'Loading application...';
    }


    async function loadProducts() {
        try {
            const productsSnapshot = await db.collection('products').get();
            let savedProducts = [];
            productsSnapshot.forEach(doc => savedProducts.push(doc.data()));
            shopProducts = savedProducts.map(p => ({ ...p, minStock: p.minStock !== undefined ? p.minStock : 0 }));
        } catch (error) {
            console.error("Error loading products:", error);
            throw new Error("Could not load product data from database.");
        }
    }

    async function startDay(dateString) {
        const reportRef = db.collection('reports').doc(dateString);
        let reportDoc = await reportRef.get();

        if (reportDoc.exists) {
            return reportDoc.data();
        }

        const lastReportDate = dayjs(dateString).subtract(1, 'day').format('YYYY-MM-DD');
        const lastReportDoc = await db.collection('reports').doc(lastReportDate).get();
        const lastReport = lastReportDoc.exists ? lastReportDoc.data() : null;
        
        const newReportData = {};
        shopProducts.forEach(p => {
            const lastEndStock = lastReport?.data[p.id]?.end || 0;
            newReportData[p.id] = { 
                begin: lastEndStock, 
                newStock: 0, 
                openedSacks: 0,
                end: lastEndStock, 
                price: p.price, 
                cost: p.cost 
            };
        });

        const report = { date: dateString, data: newReportData, cashOnHand: 0 };
        await reportRef.set(report);
        Toast.fire({ icon: 'info', title: `Started new report for ${dayjs(dateString).format('MMM D')}` });
        return report;
    }

    async function saveInventoryData(dateString, productId, data) {
        try {
            const reportRef = db.collection('reports').doc(dateString);
            const updatePayload = {};
            for (const key in data) {
                updatePayload[`data.${productId}.${key}`] = data[key];
            }
            await reportRef.update(updatePayload);
        } catch (error) {
            console.error("Error saving inventory data:", error);
            Toast.fire({ icon: 'error', title: 'Failed to save data. Check connection.' });
        }
    }

    async function finalizeReport() {
        try {
            const submittedDate = todayDateString;
            const reportRef = db.collection('reports').doc(submittedDate);
            const reportDoc = await reportRef.get();
            if (!reportDoc.exists) {
                Toast.fire({ icon: 'error', title: "No report to submit." });
                return;
            }
            
            const cashOnHand = parseFloat(document.getElementById('cash-on-hand')?.value) || 0;
            await reportRef.update({ cashOnHand: cashOnHand });
            
            const tomorrowDateString = dayjs(submittedDate).add(1, 'day').format('YYYY-MM-DD');
            await startDay(tomorrowDateString);
            
            await db.collection('settings').doc('main').update({ workingDate: tomorrowDateString });

            await Swal.fire({
                title: 'Report Saved!',
                text: `The app will now advance to the next day.`,
                icon: 'success',
                timer: 2000,
                showConfirmButton: false,
                allowOutsideClick: false
            });
            
            location.reload();
        } catch (error) {
            console.error("Error finalizing report:", error);
            Swal.fire('Error', 'An error occurred while finalizing the report.', 'error');
        }
    }


    // --- UI Rendering Functions ---

    function updateNavTabs(activeTabId) {
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.toggle('active', tab.getAttribute('aria-controls') === activeTabId);
            tab.setAttribute('aria-selected', tab.getAttribute('aria-controls') === activeTabId);
        });
    }

    function showView(viewId) {
        if (typeof reportListener === 'function') {
            reportListener();
            reportListener = null;
        }
        if (typeof expensesListener === 'function') {
            expensesListener();
            expensesListener = null;
        }

        document.querySelectorAll('.main-view').forEach(view => view.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        updateNavTabs(viewId);
        
        if (viewId === 'dashboard-view') {
            renderDashboard();
        } else if (viewId === 'expenses-view') {
            renderExpensesView(todayDateString);
        } else if (viewId === 'daily-report-view') {
            isTableRendered = false;
        }
    }
    
    function showCurrentDayReport() {
        showInventory(todayDateString);
    }
    
    async function showInventory(dateString) {
        showView('daily-report-view');
        
        if (dateString === todayDateString) {
            await startDay(dateString);
        }

        const reportRef = db.collection('reports').doc(dateString);
        if (reportListener) reportListener();
        
        reportListener = reportRef.onSnapshot((doc) => {
            if (doc.exists) {
                const reportData = doc.data();
                if (!isTableRendered) {
                    renderInventoryTable(dateString, reportData);
                    isTableRendered = true;
                } else {
                    updateInventoryTable(reportData);
                }
            } else {
                document.getElementById('inventory-tbody').innerHTML = `<tr><td colspan="9" class="text-center p-4 text-red-600">Report for ${dayjs(dateString).format('MMMM D, YYYY')} not found!</td></tr>`;
            }
        }, (error) => {
            console.error("Error listening to report changes:", error);
            Swal.fire('Connection Error', 'Could not listen for real-time updates.', 'error');
        });
    }

    async function getDailySummary(dateString) {
        const reportDoc = await db.collection('reports').doc(dateString).get();
        let totalSales = 0, totalProfit = 0;

        if (reportDoc.exists) {
            const report = reportDoc.data();
            for (const productId in report.data) {
                const item = report.data[productId];
                const sold = (item.begin + item.newStock) - (item.openedSacks || 0) - item.end;
                const sales = Math.max(0, sold) * item.price;
                const profit = sales - (Math.max(0, sold) * item.cost);
                totalSales += sales;
                totalProfit += profit;
            }
        }
        return { totalSales, totalProfit };
    }

    async function getMonthlySummary(dateString) {
        const startOfMonth = dayjs(dateString).startOf('month').format('YYYY-MM-DD');
        const endOfDay = dayjs(dateString).format('YYYY-MM-DD');
        let monthlySales = 0, monthlyProfit = 0, monthlyExpenses = 0;

        const reportsSnapshot = await db.collection('reports').where('date', '>=', startOfMonth).where('date', '<=', endOfDay).get();
        reportsSnapshot.forEach(doc => {
            const report = doc.data();
            for (const productId in report.data) {
                const item = report.data[productId];
                const sold = (item.begin + item.newStock) - (item.openedSacks || 0) - item.end;
                const sales = Math.max(0, sold) * item.price;
                const profit = sales - (Math.max(0, sold) * item.cost);
                monthlySales += sales;
                monthlyProfit += profit;
            }
        });
        
        const expensesSnapshot = await db.collection('expenses').where('date', '>=', startOfMonth).where('date', '<=', endOfDay).get();
        expensesSnapshot.forEach(doc => monthlyExpenses += doc.data().amount);

        const monthlyNetProfit = monthlyProfit - monthlyExpenses;
        return { monthlySales, monthlyNetProfit };
    }

    function renderInventoryTable(dateString, report) {
        const inventoryTbody = document.getElementById('inventory-tbody');
        try {
            const isEditable = (dateString === todayDateString);
            document.getElementById('report-title').textContent = `Daily Report - ${dayjs(dateString).format('MMMM D, YYYY')}`;
            
            const groupedProducts = {};
            RICE_CATEGORIES.forEach(cat => groupedProducts[cat] = []);
            shopProducts.forEach(p => groupedProducts[p.category]?.push(p));
            
            let tableHtml = '';
            RICE_CATEGORIES.forEach((cat, index) => {
                const productsInCategory = groupedProducts[cat].sort((a, b) => a.name.localeCompare(b.name));
                if (productsInCategory.length > 0) {
                    const cleanCatClass = cat.replace(/\s+/g, '-');
                    tableHtml += `<tr class="category-header category-header-${cleanCatClass}"><td colspan="9">${cat}</td></tr>`;
                    if(index > 0) {
                        tableHtml += `<tr class="category-subheader"><th>PRODUCT</th><th>BEGIN</th><th>NEW</th><th>OPEN SACKS</th><th>ENDING</th><th>SOLD</th><th>PRICE(₱)</th><th>SALES(₱)</th><th>PROFIT(₱)</th></tr>`;
                    }

                    productsInCategory.forEach(product => {
                        const isOpenSacksEditable = isEditable && product.category === '25 KG';
                        tableHtml += `<tr data-id="${product.id}">
                            <td class="font-medium product-name">${product.name}</td>
                            <td><input type="number" class="begin-val" disabled /></td>
                            <td><input type="number" class="new-stock-input" ${!isEditable ? 'disabled' : ''} oninput="validateNumberInput(this, true); debouncedCalculate(this, '${dateString}');"/></td>
                            <td class="!p-1">
                                ${isOpenSacksEditable ? `<div class="flex items-center gap-1"><input type="number" placeholder="Add" class="open-sacks-add-input flex-grow" oninput="validateNumberInput(this, true);"/><button class="p-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs no-print" onclick="submitOpenSack(this, '${product.id}', '${dateString}')" title="Add to Per Kilo">➔</button></div>` : `<span class="text-slate-400">-</span>`}
                            </td>
                            <td><input type="number" class="end-input" ${!isEditable ? 'disabled' : ''} oninput="validateNumberInput(this, true); debouncedCalculate(this, '${dateString}');"/></td>
                            <td><input type="number" class="sold-val" disabled /></td>
                            <td><input type="number" step="0.01" class="price-input" ${!isEditable ? 'disabled' : ''} oninput="validateNumberInput(this); debouncedUpdatePrice(this, '${dateString}');" /></td>
                            <td class="total-sales-val font-semibold" aria-live="polite"></td>
                            <td class="profit-val font-semibold text-green-600" aria-live="polite"></td>
                        </tr>`;
                    });
                    const cleanCat = cat.replace(' ', '-');
                    tableHtml += `<tr class="category-total-row" data-category-total="${cleanCat}"><td colspan="5" class="text-right p-3">Total for ${cat}</td><td class="category-total-sold p-3"></td><td></td><td class="category-total-sales p-3"></td><td class="category-total-profit p-3 text-green-600"></td></tr>`;
                }
            });
            tableHtml += `<tr class="grand-total-row"><td colspan="5" class="text-right p-4">OVERALL GRAND TOTAL</td><td id="overall-total-sold" class="p-4"></td><td></td><td id="overall-total-sales" class="p-4"></td><td id="overall-total-profit" class="p-4 text-green-400"></td></tr>`;
            tableHtml += `<tr><td colspan="9" class="p-2 bg-white"><div class="max-w-4xl mx-auto p-4 bg-slate-50 border-t-4 border-blue-500 rounded-b-lg shadow-inner"><div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4 items-center"><div class="flex justify-between items-center p-2 rounded"><span class="text-sm font-medium text-slate-600">Expected Sales:</span><span id="expected-cash" class="font-bold text-slate-800 text-lg"></span></div><div class="flex justify-between items-center p-2 rounded"><label for="cash-on-hand" class="text-sm font-medium text-slate-600 mr-2">Cash on Hand:</label><input type="number" id="cash-on-hand" placeholder="0.00" class="w-32 text-right font-bold border-slate-300 p-1 rounded" oninput="validateNumberInput(this, true); calculateCashDifference();" ${!isEditable ? 'disabled' : ''} /></div><div class="flex justify-between items-center p-2 rounded"><span class="text-sm font-medium text-slate-600">Difference:</span><span id="cash-difference-display" class="font-bold text-lg">-</span></div></div></div></td></tr>`;
            if (isEditable) {
                tableHtml += `<tr class="no-print"><td colspan="9" class="p-4 bg-white"><div class="flex justify-center"><button onclick="showReviewModal()" class="btn-success">Save Today & Start Next Day</button></div></td></tr>`;
            } else {
                tableHtml += `<tr class="no-print"><td colspan="9" class="p-4 bg-slate-50 text-center"><p class="font-medium text-slate-600">Viewing a past report. Click the Daily Report tab for the current day.</p></td></tr>`;
            }
            inventoryTbody.innerHTML = tableHtml;
            updateInventoryTable(report);

        } catch (error) {
            console.error("Error rendering inventory table:", error);
            inventoryTbody.innerHTML = `<tr><td colspan="9" class="text-center p-4 text-red-600 font-semibold">An error occurred while loading the report.</td></tr>`;
        }
    }

    function updateInventoryTable(report) {
        const reportData = report.data;
        const categoryTotals = {};
        RICE_CATEGORIES.forEach(cat => categoryTotals[cat] = { sold: 0, sales: 0, profit: 0 });

        shopProducts.forEach(product => {
            const row = document.querySelector(`#inventory-tbody tr[data-id="${product.id}"]`);
            if (!row) return;

            const data = reportData[product.id] || { begin: 0, newStock: 0, openedSacks: 0, end: 0, price: product.price, cost: product.cost };
            const sold = (data.begin + data.newStock) - (data.openedSacks || 0) - data.end;
            const totalSales = Math.max(0, sold) * data.price;
            const profit = totalSales - (Math.max(0, sold) * data.cost);

            categoryTotals[product.category].sold += sold > 0 ? sold : 0;
            categoryTotals[product.category].sales += totalSales;
            categoryTotals[product.category].profit += profit;

            updateInputValue(row, '.begin-val', data.begin);
            updateInputValue(row, '.new-stock-input', data.newStock);
            updateInputValue(row, '.end-input', data.end);
            updateInputValue(row, '.sold-val', sold);
            updateInputValue(row, '.price-input', formatCurrency(data.price));
            updateTextContent(row, '.total-sales-val', formatCurrency(totalSales));
            updateTextContent(row, '.profit-val', formatCurrency(profit));

            row.classList.toggle('row-has-sales', sold > 0);
            row.classList.toggle('row-logic-error', sold < 0);
            row.classList.toggle('row-negative-stock', data.end < 0);
            row.classList.toggle('row-low-stock', product.minStock > 0 && data.end >= 0 && data.end <= product.minStock);
        });
        
        updateTotalsFromData(categoryTotals);
        
        const cashInput = document.getElementById('cash-on-hand');
        if (cashInput && report.cashOnHand > 0 && cashInput.value !== report.cashOnHand) {
            cashInput.value = report.cashOnHand;
        }
        calculateCashDifference();
    }

    function updateInputValue(row, selector, value) {
        const el = row.querySelector(selector);
        if (el && el.value != value && document.activeElement !== el) {
            el.value = value;
        }
    }

    function updateTextContent(row, selector, value) {
        const el = row.querySelector(selector);
        if (el && el.textContent != value) {
            el.textContent = value;
        }
    }

    function updateTotalsFromData(categoryTotals) {
        let overallTotalSold = 0, overallTotalSales = 0, overallTotalProfit = 0;

        for(const cat in categoryTotals) {
            const totals = categoryTotals[cat];
            const cleanCat = cat.replace(' ', '-');
            const totalRow = document.querySelector(`tr[data-category-total="${cleanCat}"]`);
            if (totalRow) {
                updateTextContent(totalRow, '.category-total-sold', totals.sold);
                updateTextContent(totalRow, '.category-total-sales', `₱${formatCurrency(totals.sales)}`);
                updateTextContent(totalRow, '.category-total-profit', `₱${formatCurrency(totals.profit)}`);
            }
            overallTotalSold += totals.sold;
            overallTotalSales += totals.sales;
            overallTotalProfit += totals.profit;
        }

        updateTextContent(document, '#overall-total-sold', overallTotalSold);
        updateTextContent(document, '#overall-total-sales', `₱${formatCurrency(overallTotalSales)}`);
        updateTextContent(document, '#overall-total-profit', `₱${formatCurrency(overallTotalProfit)}`);
        updateTextContent(document, '#expected-cash', `₱${formatCurrency(overallTotalSales)}`);
    }

    function calculateCashDifference() {
        const totalSalesEl = document.getElementById('overall-total-sales');
        const cashInput = document.getElementById('cash-on-hand');
        const differenceDisplay = document.getElementById('cash-difference-display');
        
        if (!totalSalesEl || !cashInput || !differenceDisplay) return;

        const totalSales = parseFloat(totalSalesEl.textContent.replace(/[₱,]/g, '')) || 0;
        if (cashInput.value.trim() === '') {
            differenceDisplay.textContent = '-';
            differenceDisplay.className = 'font-bold text-lg';
            return;
        }

        const cashOnHand = parseFloat(cashInput.value) || 0;
        const difference = cashOnHand - totalSales;
        differenceDisplay.className = 'font-bold text-lg';
        
        if (difference < 0) {
            differenceDisplay.textContent = `(₱${formatCurrency(Math.abs(difference))})`;
            differenceDisplay.classList.add('cash-short');
        } else if (difference > 0) {
            differenceDisplay.textContent = `+₱${formatCurrency(difference)}`;
            differenceDisplay.classList.add('cash-over');
        } else {
            differenceDisplay.textContent = 'Balanced';
            differenceDisplay.classList.add('cash-balanced');
        }
    }

    async function calculate(inputElement, dateString) {
        if (inputElement.classList.contains('invalid')) return;
        const row = inputElement.closest('tr');
        if (!row || !row.dataset.id) return;
        const productId = row.dataset.id;
        const newStock = parseFloat(row.querySelector('.new-stock-input').value) || 0;
        const end = parseFloat(row.querySelector('.end-input').value) || 0;
        await saveInventoryData(dateString, productId, { newStock, end });
        renderRemainingStockSummary();
    }
    
    function debouncedCalculate(inputElement, dateString) {
        clearTimeout(calculationTimeout);
        calculationTimeout = setTimeout(() => calculate(inputElement, dateString), 400);
    }
    
    async function submitOpenSack(buttonElement, productId, dateString) {
        const parentDiv = buttonElement.parentElement;
        const addSacksInput = parentDiv.querySelector('.open-sacks-add-input');
        const sacksToAdd = parseInt(addSacksInput.value) || 0;

        if (sacksToAdd <= 0) {
            return Toast.fire({ icon: 'info', title: 'Enter a positive number.' });
        }

        const sourceProduct = shopProducts.find(p => p.id === productId);
        if (!sourceProduct || sourceProduct.category !== '25 KG') return;

        try {
            const reportRef = db.collection('reports').doc(dateString);
            await db.runTransaction(async (transaction) => {
                const reportDoc = await transaction.get(reportRef);
                if (!reportDoc.exists) throw "Report not found!";
                
                const report = reportDoc.data();
                const sourceData = report.data[sourceProduct.id] || { end: 0 };
                const availableStock = sourceData.end;

                if (availableStock < sacksToAdd) {
                    throw `Insufficient stock for ${sourceProduct.name}. Only ${availableStock} available.`;
                }

                const targetProduct = shopProducts.find(p => p.name === sourceProduct.name && p.category === 'Per Kilo');
                if (!targetProduct) throw `No corresponding "Per Kilo" product found for ${sourceProduct.name}.`;

                const kilosToAdd = sacksToAdd * 25;
                
                const updatePayload = {};
                updatePayload[`data.${sourceProduct.id}.openedSacks`] = firebase.firestore.FieldValue.increment(sacksToAdd);
                updatePayload[`data.${targetProduct.id}.begin`] = firebase.firestore.FieldValue.increment(kilosToAdd);
                updatePayload[`data.${targetProduct.id}.end`] = firebase.firestore.FieldValue.increment(kilosToAdd);
                transaction.update(reportRef, updatePayload);
                addSacksInput.value = '';
            });
            Toast.fire({ icon: 'success', title: 'Stock transferred!' });
        } catch (error) {
            console.error("Error submitting open sack:", error);
            Swal.fire('Error', typeof error === 'string' ? error : 'An unexpected error occurred.', 'error');
        }
    }


    async function updatePrice(priceInputElement, dateString) {
        if (priceInputElement.classList.contains('invalid')) return;
        const row = priceInputElement.closest('tr');
        if (!row) return;

        const productId = row.dataset.id;
        const newPrice = parseFloat(priceInputElement.value) || 0;
        
        try {
            await db.collection('products').doc(productId).update({ price: newPrice });
            await db.collection('reports').doc(dateString).update({ [`data.${productId}.price`]: newPrice });
            await loadProducts();
        } catch (error) {
            console.error("Error updating price:", error);
            Toast.fire({ icon: 'error', title: 'Could not save price change.' });
        }
    }

    function debouncedUpdatePrice(inputElement, dateString) {
        clearTimeout(calculationTimeout);
        calculationTimeout = setTimeout(() => updatePrice(inputElement, dateString), 400);
    }
    
    async function showReviewModal() {
        const { isConfirmed } = await Swal.fire({
            title: `Finalize Report for Today?`,
            text: `This action will save today's report and advance the system to the next working day. It cannot be undone.`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#10b981',
            confirmButtonText: 'Yes, Finalize It!',
            showLoaderOnConfirm: true,
            preConfirm: () => {
                return finalizeReport().catch(err => {
                    Swal.showValidationMessage(`Request failed: ${err}`);
                });
            },
            allowOutsideClick: () => !Swal.isLoading()
        });
    }

    // --- History View Functions ---

    async function showHistory() {
        showView('history-view');
        const historyList = document.getElementById('history-list');
        historyList.innerHTML = '<div class="p-4 text-center"><div class="loader" role="status"></div></div>';
        try {
            const reportsSnapshot = await db.collection('reports').orderBy('date', 'desc').get();
            const reportDates = [];
            reportsSnapshot.forEach(doc => reportDates.push(doc.id));
            renderHistoryList(reportDates);
        } catch (error) {
             console.error("Error loading history:", error);
             historyList.innerHTML = '<p class="p-4 text-center text-red-500">Could not load report history.</p>';
        }
    }
    
    function renderHistoryList(reportDates) {
        const listEl = document.getElementById('history-list');
        if(reportDates.length === 0) {
            listEl.innerHTML = '<p class="text-center text-slate-500 p-8">No saved reports found.</p>';
            return;
        }
        listEl.innerHTML = reportDates.map(dateString => `
            <div class="p-4 hover:bg-slate-50 transition-colors history-item" data-date="${dateString}">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div>
                        <div class="font-medium">${dayjs(dateString).format('dddd, MMMM D, YYYY')}</div>
                        <div class="text-sm text-slate-500" aria-hidden="true">${dateString}</div>
                    </div>
                    <div class="flex gap-2 mt-2 sm:mt-0">
                        <button onclick="viewPastReport('${dateString}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">View Report</button>
                        <button onclick="deleteReport('${dateString}')" class="text-red-600 hover:text-red-800 text-sm font-medium no-print">Delete</button>
                    </div>
                </div>
            </div>`).join('');
    }

    async function viewPastReport(dateString) {
        isTableRendered = false;
        showInventory(dateString);
    }
    
    function filterHistory() {
        const searchTerm = document.getElementById('history-search').value.toLowerCase();
        const historyItems = document.querySelectorAll('#history-list .history-item');
        historyItems.forEach(item => {
            const dateText = item.textContent.toLowerCase();
            item.style.display = dateText.includes(searchTerm) ? '' : 'none';
        });
    }
    
    async function deleteReport(dateString) {
        if (dateString === todayDateString) {
            return Swal.fire('Action Denied', 'You cannot delete the report for the current working day.', 'error');
        }
        const { isConfirmed } = await Swal.fire({ 
            title: 'Delete Report?', 
            text: `This will permanently delete the report for ${dayjs(dateString).format('MMMM D, YYYY')}.`, 
            icon: 'warning', showCancelButton: true, confirmButtonText: 'Yes, delete it!' 
        });
        if (isConfirmed) {
            try {
                await db.collection('reports').doc(dateString).delete();
                Toast.fire({ icon: 'success', title: 'Report deleted!' });
                showHistory();
            } catch (error) {
                Swal.fire('Error', 'Could not delete the report.', 'error');
            }
        }
    }

    // --- Analytics Functions ---
    function showAnalyticsSubTab(contentId) { document.querySelectorAll('#settings-analytics-content .analytics-tab-content').forEach(content => { content.classList.add('hidden'); content.setAttribute('aria-hidden', 'true'); }); document.querySelectorAll('#settings-analytics-content .analytics-tab').forEach(tab => { tab.classList.remove('active'); tab.setAttribute('aria-selected', 'false'); }); const selectedContent = document.getElementById(contentId); if (selectedContent) { selectedContent.classList.remove('hidden'); selectedContent.setAttribute('aria-hidden', 'false'); const correspondingTab = document.querySelector(`#settings-analytics-content [aria-controls="${contentId}"]`); if (correspondingTab) { correspondingTab.classList.add('active'); correspondingTab.setAttribute('aria-selected', 'true'); } } if (contentId === 'analytics-overview-content' || contentId === 'analytics-products-content') { loadAnalytics(); } else if (contentId === 'analytics-financial-summary-content') { loadFinancialSummary(); } }
    function toggleAnalyticsDateInputs() { const mode = document.getElementById('analytics-mode-select').value; document.getElementById('daily-date-input').classList.toggle('hidden', mode !== 'daily'); document.getElementById('range-date-inputs').classList.toggle('hidden', mode !== 'range'); }
    async function loadAnalytics() { const mode = document.getElementById('analytics-mode-select').value; let startDate, endDate; if (mode === 'daily') { startDate = document.getElementById('analytics-single-date').value; endDate = startDate; } else { startDate = document.getElementById('analytics-from-date').value; endDate = document.getElementById('analytics-to-date').value; } if (!startDate || !endDate || dayjs(startDate).isAfter(dayjs(endDate))) { return; } try { const reportsSnapshot = await db.collection('reports') .where('date', '>=', startDate) .where('date', '<=', endDate) .get(); let totalSales = 0; let totalProfit = 0; let numDays = reportsSnapshot.size; const productPerformance = {}; shopProducts.forEach(p => productPerformance[p.id] = { sold: 0, sales: 0, profit: 0, name: p.name, category: p.category }); reportsSnapshot.forEach(doc => { const report = doc.data(); for (const productId in report.data) { const product = shopProducts.find(p => p.id === productId); if (!product) continue; const item = report.data[productId]; const sold = (item.begin + item.newStock) - (item.openedSacks || 0) - item.end; if(sold <= 0) continue; const sales = sold * item.price; const profit = sales - (sold * item.cost); totalSales += sales; totalProfit += profit; if (productPerformance[productId]) { productPerformance[productId].sold += sold; productPerformance[productId].sales += sales; productPerformance[productId].profit += profit; } } }); numDays = numDays || 1; document.getElementById('analytics-total-sales').textContent = `₱${formatCurrency(totalSales)}`; document.getElementById('analytics-total-profit').textContent = `₱${formatCurrency(totalProfit)}`; document.getElementById('analytics-avg-sales').textContent = `₱${formatCurrency(totalSales / numDays)}`; document.getElementById('analytics-avg-margin').textContent = `${formatCurrency((totalSales > 0 ? (totalProfit / totalSales) * 100 : 0))}%`; renderTopPerformingProducts(productPerformance); } catch (error) { console.error("Error loading sales overview analytics:", error); } }
    function renderTopPerformingProducts(productPerformance) { const container = document.getElementById('analytics-top-products'); const topProducts = Object.values(productPerformance).filter(p => p.sales > 0).sort((a, b) => b.sales - a.sales).slice(0, 10); if (topProducts.length === 0) { container.innerHTML = '<p class="text-center text-slate-500 py-4">No sales data found for the selected period.</p>'; return; } container.innerHTML = topProducts.map((p, i) => `<div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full flex items-center justify-center ${i === 0 ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-600'}">${i + 1}</div><div><div class="font-medium">${p.name} <span class="text-sm text-slate-400">(${p.category})</span></div><div class="text-sm text-slate-500">${p.sold} sold</div></div></div><div class="text-right"><div class="font-semibold">₱${formatCurrency(p.sales)}</div><div class="text-sm text-green-600">₱${formatCurrency(p.profit)} profit</div></div></div>`).join(''); }
    async function loadFinancialSummary() { const monthValue = document.getElementById('financial-month-select').value; if (!monthValue) return; const startDate = dayjs(monthValue).startOf('month').format('YYYY-MM-DD'); const endDate = dayjs(monthValue).endOf('month').format('YYYY-MM-DD'); let totalSales = 0, totalCOGS = 0, totalExpenses = 0, totalNewStockCost = 0; const dailyFlow = {}; try { const reportsSnapshot = await db.collection('reports') .where('date', '>=', startDate).where('date', '<=', endDate).get(); const expensesSnapshot = await db.collection('expenses') .where('date', '>=', startDate).where('date', '<=', endDate).get(); reportsSnapshot.forEach(doc => { const report = doc.data(); if (!report || !report.data) return; let dailyNetProfit = 0; let dailyNewStockCost = 0; for (const productId in report.data) { const product = shopProducts.find(p => p.id === productId); if (!product) continue; const item = report.data[productId]; const sold = (item.begin + item.newStock) - (item.openedSacks || 0) - item.end; if (sold > 0) { const sales = sold * item.price; const cogs = sold * item.cost; totalSales += sales; totalCOGS += cogs; dailyNetProfit += (sales - cogs); } if (item.newStock > 0) { const newStockCost = item.newStock * item.cost; totalNewStockCost += newStockCost; dailyNewStockCost += newStockCost; } } dailyFlow[report.date] = { profit: dailyNetProfit, reinvested: dailyNewStockCost }; }); expensesSnapshot.forEach(doc => { const expense = doc.data(); totalExpenses += expense.amount; if (dailyFlow[expense.date]) { dailyFlow[expense.date].profit -= expense.amount; } }); const grossProfit = totalSales - totalCOGS; const netProfit = grossProfit - totalExpenses; document.getElementById('fs-total-sales').textContent = `₱${formatCurrency(totalSales)}`; document.getElementById('fs-total-cogs').textContent = `₱${formatCurrency(totalCOGS)}`; document.getElementById('fs-gross-profit').textContent = `₱${formatCurrency(grossProfit)}`; document.getElementById('fs-total-expenses').textContent = `₱${formatCurrency(totalExpenses)}`; document.getElementById('fs-new-stock-cost').textContent = `₱${formatCurrency(totalNewStockCost)}`; document.getElementById('fs-net-profit').textContent = `₱${formatCurrency(netProfit)}`; renderMoneyFlowChart(dailyFlow); } catch (error) { console.error("Error loading financial summary:", error); Swal.fire('Error', 'Could not load financial summary data.', 'error'); } }
    function renderMoneyFlowChart(data) { if (moneyFlowChartInstance) moneyFlowChartInstance.destroy(); const ctx = document.getElementById('moneyFlowChart').getContext('2d'); const sortedDates = Object.keys(data).sort(); const labels = sortedDates.map(date => dayjs(date).format('MMM D')); const profitData = sortedDates.map(date => data[date].profit); const reinvestedData = sortedDates.map(date => data[date].reinvested); moneyFlowChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Net Profit', data: profitData, backgroundColor: 'rgba(16, 185, 129, 0.7)', }, { label: 'Capital Reinvested', data: reinvestedData, backgroundColor: 'rgba(59, 130, 246, 0.7)', }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { callback: value => `₱${value.toLocaleString()}` } } }, plugins: { tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ₱${formatCurrency(c.raw)}` } } } } }); }
    
    // ENHANCED Dashboard Renderer
    async function renderDashboard() {
      try {
        const dateToRender = todayDateString;
        document.getElementById('dashboard-title').textContent = "Today's Overview";
        document.getElementById('dashboard-date').textContent = dayjs(dateToRender).format('MMMM D, YYYY');
        
        let reportDoc = await db.collection('reports').doc(dateToRender).get();
        if (!reportDoc.exists) {
            await startDay(dateToRender);
            reportDoc = await db.collection('reports').doc(dateToRender).get();
        }
        const report = reportDoc.data();
        const { totalSales, totalProfit } = await getDailySummary(dateToRender);
        const { monthlyNetProfit } = await getMonthlySummary(dateToRender);
        const expensesSnapshot = await db.collection('expenses').where('date', '==', dateToRender).get();
        let totalExpenses = 0;
        expensesSnapshot.forEach(doc => totalExpenses += doc.data().amount);

        const lowStockItems = shopProducts
            .map(p => ({ ...p, stock: report.data[p.id]?.end }))
            .filter(p => p.minStock > 0 && p.stock !== undefined && p.stock <= p.minStock);

        // Populate skeleton UI
        document.getElementById('dashboard-total-sales').outerHTML = `<p id="dashboard-total-sales" class="text-3xl font-bold text-slate-800">₱${formatCurrency(totalSales)}</p>`;
        document.getElementById('dashboard-total-expenses').outerHTML = `<p id="dashboard-total-expenses" class="text-3xl font-bold text-slate-800">₱${formatCurrency(totalExpenses)}</p>`;
        document.getElementById('dashboard-total-profit').outerHTML = `<p id="dashboard-total-profit" class="text-3xl font-bold text-green-700">₱${formatCurrency(totalProfit)}</p>`;
        document.getElementById('dashboard-monthly-net-profit').outerHTML = `<p id="dashboard-monthly-net-profit" class="text-3xl font-bold text-teal-700">₱${formatCurrency(monthlyNetProfit)}</p>`;
        
        const lowStockList = document.getElementById('low-stock-list');
        if (lowStockItems.length > 0) {
            lowStockList.innerHTML = lowStockItems.map(item => 
                `<div class="flex justify-between items-center text-sm p-2 bg-white rounded"><span class="font-semibold">${item.name} <span class="font-normal text-slate-500">(${item.category})</span></span><span class="font-semibold text-red-600">${item.stock} left (Min: ${item.minStock})</span></div>`
            ).join('');
        } else {
            lowStockList.innerHTML = '<p class="text-slate-500 text-center py-4">All stock levels are good!</p>';
        }
      } catch(error) {
        console.error("Error rendering dashboard:", error);
        document.getElementById('dashboard-content').innerHTML = '<div class="col-span-full card p-6 text-center text-red-600"><h3 class="font-bold">Dashboard Error</h3><p>Could not load dashboard data.</p></div>';
      }
    }
    
    // --- Expense Functions ---
    async function renderExpensesView(dateString) { document.getElementById('expenses-title').textContent = `Expenses for ${dayjs(dateString).format('MMMM D, YYYY')}`; document.getElementById('expense-form-title').textContent = `Add Expense for Today`; clearExpenseForm(); const container = document.getElementById('expense-list-container'); container.innerHTML = '<div class="loader"></div>'; const query = db.collection('expenses').where('date', '==', dateString); if (typeof expensesListener === 'function') expensesListener(); expensesListener = query.onSnapshot(snapshot => { const expenses = []; snapshot.forEach(doc => expenses.push(doc.data())); if (expenses.length === 0) { container.innerHTML = '<p class="text-center text-slate-500 py-8">No expenses recorded for today.</p>'; } else { container.innerHTML = expenses.map(expense => ` <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg"> <div> <p class="font-medium">${expense.description}</p> <p class="text-sm text-slate-500">₱${formatCurrency(expense.amount)}</p> </div> <div class="no-print"> <button onclick="editExpense('${expense.id}')" class="text-xs text-blue-600 mr-2 hover:underline">Edit</button> <button onclick="deleteExpense('${expense.id}')" class="text-xs text-red-600 hover:underline">Delete</button> </div> </div> `).join(''); } const totalExpenses = expenses.reduce((acc, expense) => acc + expense.amount, 0); document.getElementById('total-expenses-display').textContent = `₱${formatCurrency(totalExpenses)}`; }, error => { console.error("Error fetching expenses: ", error); container.innerHTML = '<p class="text-center text-red-500 py-8">Could not load expenses.</p>'; }); }
    async function saveExpense() {
        const saveBtn = document.getElementById('save-expense-btn');
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = `<span class="btn-loader"></span> Saving...`;

        try {
            const descriptionInput = document.getElementById('expense-description'); const amountInput = document.getElementById('expense-amount'); const expenseId = document.getElementById('expense-id').value; const description = descriptionInput.value.trim(); const amount = parseFloat(amountInput.value); if (!description || isNaN(amount) || amount <= 0) { Toast.fire({ icon: 'error', title: 'Please enter a valid description and amount.' }); return; } const docId = expenseId || 'exp_' + Date.now(); const expenseData = { id: docId, description: description, amount: amount, date: todayDateString };
            await db.collection('expenses').doc(docId).set(expenseData);
            Toast.fire({ icon: 'success', title: expenseId ? 'Expense updated!' : 'Expense added!' });
            clearExpenseForm();
            renderDashboard();
        } catch (error) {
            console.error("Error saving expense:", error);
            Swal.fire('Error', 'Could not save the expense.', 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    }
    function clearExpenseForm() { document.getElementById('expense-id').value = ''; document.getElementById('expense-description').value = ''; document.getElementById('expense-amount').value = ''; document.getElementById('expense-form-title').textContent = `Add Expense for Today`; }
    async function editExpense(id) { const expenseDoc = await db.collection('expenses').doc(id).get(); if (expenseDoc.exists) { const expense = expenseDoc.data(); document.getElementById('expense-id').value = expense.id; document.getElementById('expense-description').value = expense.description; document.getElementById('expense-amount').value = expense.amount; document.getElementById('expense-form-title').textContent = 'Edit Expense'; document.getElementById('expense-description').focus(); } }
    async function deleteExpense(expenseId) { const { isConfirmed } = await Swal.fire({ title: 'Delete Expense?', text: 'This cannot be undone.', icon: 'warning', showCancelButton: true, confirmButtonText: 'Yes, delete it' }); if (isConfirmed) { try { await db.collection('expenses').doc(expenseId).delete(); Toast.fire({ icon: 'success', title: 'Expense deleted!' }); renderDashboard(); } catch (error) { Swal.fire('Error', 'Could not delete the expense.', 'error'); } } }
    
    // --- Settings Panel Functions ---
    function showSettingsTab(contentId) { document.querySelectorAll('.settings-tab-content').forEach(c => c.classList.add('hidden')); document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active')); document.getElementById(contentId).classList.remove('hidden'); document.querySelector(`[aria-controls="${contentId}"]`).classList.add('active'); if (contentId === 'settings-analytics-content') { showAnalyticsSubTab('analytics-overview-content'); } if (contentId === 'settings-performance-content') { renderPerformanceBreakdown(); renderRemainingStockSummary(); } }
    async function openSettingsPanel() { document.getElementById('settings-panel').classList.add('open'); document.getElementById('settings-panel').focus(); showSettingsTab('settings-product-management-content'); }
    function closeSettingsPanel() { document.getElementById('settings-panel').classList.remove('open'); document.querySelector('[onclick="openSettingsWithPassword()"]')?.focus(); }
    async function openSettingsWithPassword() { const securityDoc = await db.collection('settings').doc('security').get(); const storedPasswordHash = securityDoc.exists ? securityDoc.data().passwordHash : null; if (!storedPasswordHash) { const { value: password } = await Swal.fire({ title: 'Set Your Settings Password', input: 'password', inputPlaceholder: 'Minimum 4 characters', inputAttributes: { minlength: 4 }, showCancelButton: true, validationMessage: 'Password must be at least 4 characters long.' }); if (password && password.length >= 4) { await db.collection('settings').doc('security').set({ passwordHash: hashPassword(password) }); Toast.fire({ icon: 'success', title: 'Password set!' }); openSettingsPanel(); } else if (password) { Swal.fire('Password Not Set', 'Password must be at least 4 characters long.', 'error'); } } else { const { value: password } = await Swal.fire({ title: 'Enter Password to Access Settings', input: 'password', showCancelButton: true, inputAttributes: { autocomplete: 'current-password' } }); if (password && hashPassword(password) === storedPasswordHash) openSettingsPanel(); else if (password) Swal.fire('Incorrect Password', '', 'error'); } }
    function renderProductList() { const container = document.getElementById('product-list-container'); if (shopProducts.length === 0) { container.innerHTML = '<p class="text-center text-slate-500 py-4">No products added yet.</p>'; return; } container.innerHTML = shopProducts.sort((a,b) => a.name.localeCompare(b.name)).map(p => `<div class="flex justify-between items-center p-2 bg-slate-100 rounded"><div><span class="font-medium">${p.name}</span> <span class="text-xs text-slate-500">(${p.category})</span> <span class="text-xs text-slate-400">Min: ${p.minStock}</span></div><div><button onclick="editProduct('${p.id}')" class="text-xs text-blue-600 mr-2 hover:underline">Edit</button><button onclick="deleteProduct('${p.id}')" class="text-xs text-red-600 hover:underline">Delete</button></div></div>`).join(''); }
    function clearProductForm() { document.getElementById('product-form-title').textContent = 'Add New Product'; ['product-id', 'product-name', 'product-price', 'product-cost', 'product-minstock'].forEach(id => document.getElementById(id).value = ''); document.getElementById('product-category').value = '25 KG'; ['product-name', 'product-price', 'product-cost', 'product-minstock'].forEach(id => document.getElementById(id).classList.remove('invalid')); }
    async function saveProduct() {
        const saveBtn = document.getElementById('save-product-btn');
        const originalText = saveBtn.textContent;
        saveBtn.disabled = true;
        saveBtn.innerHTML = `<span class="btn-loader"></span> Saving...`;

        try {
            const nameInput = document.getElementById('product-name'); const priceInput = document.getElementById('product-price'); const costInput = document.getElementById('product-cost'); const minStockInput = document.getElementById('product-minstock'); const isValid = [validateNumberInput(priceInput), validateNumberInput(costInput), validateNumberInput(minStockInput, true), nameInput.value.trim() !== ''].every(Boolean); if (!nameInput.value.trim()) nameInput.classList.add('invalid'); else nameInput.classList.remove('invalid'); if (!isValid) { Toast.fire({ icon: 'error', title: 'Please correct invalid inputs!' }); return; } const productId = document.getElementById('product-id').value; const docId = productId || 'prod_' + Date.now(); const productData = { id: docId, name: nameInput.value.trim().toUpperCase(), price: parseFloat(priceInput.value), cost: parseFloat(costInput.value), category: document.getElementById('product-category').value, minStock: parseInt(minStockInput.value) || 0 }; const existingProduct = shopProducts.find(p => p.name === productData.name && p.category === productData.category && p.id !== productData.id); if (existingProduct) { Swal.fire('Duplicate Product', `A product named "${productData.name}" already exists in the "${productData.category}" category.`, 'error'); return; }
            await db.collection('products').doc(docId).set(productData);
            Toast.fire({ icon: 'success', title: productId ? 'Product updated!' : 'Product added!' });
            await loadProducts();
            renderProductList();
            clearProductForm();
        } catch (error) {
            Swal.fire('Error', 'Could not save the product.', 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
        }
    }
    function editProduct(id) { const product = shopProducts.find(p => p.id === id); if (!product) return; document.getElementById('product-form-title').textContent = `Edit Product: ${product.name}`; document.getElementById('product-id').value = product.id; document.getElementById('product-name').value = product.name; document.getElementById('product-price').value = product.price; document.getElementById('product-cost').value = product.cost; document.getElementById('product-minstock').value = product.minStock; document.getElementById('product-category').value = product.category; ['product-name', 'product-price', 'product-cost', 'product-minstock'].forEach(id => document.getElementById(id).classList.remove('invalid')); }
    async function deleteProduct(id) { const productToDelete = shopProducts.find(p => p.id === id); if (!productToDelete) return; const { isConfirmed } = await Swal.fire({ title: 'Are you sure?', html: `Delete <strong>${productToDelete.name} (${productToDelete.category})</strong>? This is irreversible.`, icon: 'warning', showCancelButton: true, confirmButtonText: 'Yes, delete it!', confirmButtonColor: '#d33' }); if (isConfirmed) { try { await db.collection('products').doc(id).delete(); Toast.fire({ icon: 'success', title: 'Product deleted!' }); await loadProducts(); renderProductList(); } catch (error) { Swal.fire('Error', 'Could not delete the product.', 'error'); } } }
    async function savePassword() { const current = document.getElementById('currentPassword').value; const newPass = document.getElementById('newPassword').value; const confirm = document.getElementById('confirmPassword').value; const securityDoc = await db.collection('settings').doc('security').get(); const storedPasswordHash = securityDoc.exists ? securityDoc.data().passwordHash : null; if (hashPassword(current) !== storedPasswordHash) return Swal.fire('Error', 'Current password incorrect.', 'error'); if (newPass.length < 4) return Swal.fire('Error', 'New password must be at least 4 characters long.', 'error'); if (newPass !== confirm) return Swal.fire('Error', 'New passwords do not match.', 'error'); await db.collection('settings').doc('security').set({ passwordHash: hashPassword(newPass) }); Swal.fire('Success', 'Password changed successfully!', 'success'); ['currentPassword', 'newPassword', 'confirmPassword'].forEach(id => document.getElementById(id).value = ''); }
    async function promptForCategoryThenEdit(editType) { const { value: selectedCategory } = await Swal.fire({ title: 'Select a Category to Edit', html: `<select id="swal-category-select" class="swal2-select"><option value="all">All Categories</option>${RICE_CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('')}</select>`, focusConfirm: false, showCancelButton: true, confirmButtonText: 'Next &rarr;', preConfirm: () => document.getElementById('swal-category-select').value }); if (selectedCategory) { const categoryFilter = selectedCategory === 'all' ? null : selectedCategory; if (editType === 'begin') editBeginningStock(categoryFilter); else if (editType === 'price') editPrices(categoryFilter); } }
    async function editBeginningStock(categoryFilter = null) { const dateToEdit = todayDateString; const reportDoc = await db.collection('reports').doc(dateToEdit).get(); if (!reportDoc.exists) return Swal.fire('Cannot Edit', 'Can only edit beginning stock for the current day.', 'error'); const initialReport = reportDoc.data(); const securityDoc = await db.collection('settings').doc('security').get(); const storedPasswordHash = securityDoc.exists ? securityDoc.data().passwordHash : null; if (storedPasswordHash) { const { value: password } = await Swal.fire({ title: 'Enter Password to Edit Beginning Stock', input: 'password', showCancelButton: true }); if (!password || hashPassword(password) !== storedPasswordHash) return password && Swal.fire('Incorrect Password', '', 'error'); } const products = (categoryFilter ? shopProducts.filter(p => p.category === categoryFilter) : shopProducts).sort((a, b) => a.category.localeCompare(b.category) || a.name.localeCompare(b.name)); if (products.length === 0) return Swal.fire('No Products', 'No products found in this category.', 'info'); let modalHtml = '<div class="text-left max-h-[60vh] overflow-y-auto p-2 border rounded">'; let currentCategory = ''; products.forEach(p => { if (p.category !== currentCategory && !categoryFilter) { currentCategory = p.category; modalHtml += `<div class="font-bold text-lg p-2 bg-slate-100 rounded my-2">${currentCategory}</div>`; } modalHtml += `<div class="grid grid-cols-2 gap-4 items-center mb-2 p-2 border-b" data-product-id="${p.id}"><label for="begin-stock-${p.id}" class="font-medium">${p.name}</label><input type="number" id="begin-stock-${p.id}" value="${initialReport.data[p.id]?.begin || 0}" class="border p-1 w-full rounded" oninput="validateNumberInput(this, true)"></div>`; }); modalHtml += '</div>'; const { isConfirmed } = await Swal.fire({ title: `Edit Beginning Stock ${categoryFilter ? `for ${categoryFilter}` : ''}`, html: modalHtml, width: '90%', maxWidth: '600px', showCancelButton: true, preConfirm: () => { if (Array.from(document.querySelectorAll('.swal2-html-container input.invalid')).length > 0) { Swal.showValidationMessage('Please correct invalid inputs.'); return false; } } }); if (isConfirmed) { const reportRef = db.collection('reports').doc(dateToEdit); const updatePayload = {}; document.querySelectorAll('.swal2-html-container [data-product-id]').forEach(row => { const productId = row.dataset.productId; const newBegin = parseInt(row.querySelector('input').value) || 0; const diff = newBegin - (initialReport.data[productId]?.begin || 0); updatePayload[`data.${productId}.begin`] = newBegin; updatePayload[`data.${productId}.end`] = firebase.firestore.FieldValue.increment(diff); }); await reportRef.update(updatePayload); Toast.fire({ icon: 'success', title: 'Beginning stock updated!' }); } }
    async function editPrices(categoryFilter = null) { const products = (categoryFilter ? shopProducts.filter(p => p.category === categoryFilter) : shopProducts).sort((a, b) => a.category.localeCompare(b.category) || a.name.localeCompare(b.name)); if (products.length === 0) return Swal.fire('No Products Found', '', 'info'); let modalHtml = '<div class="text-left max-h-[60vh] overflow-y-auto p-2 border rounded">'; let currentCategory = ''; products.forEach(p => { if (p.category !== currentCategory && !categoryFilter) { currentCategory = p.category; modalHtml += `<div class="font-bold text-lg p-2 bg-slate-100 rounded my-2">${currentCategory}</div>`; } modalHtml += `<div class="grid grid-cols-2 gap-4 items-center mb-2 p-2 border-b" data-product-id="${p.id}"><label for="price-input-${p.id}" class="font-medium">${p.name}</label><input type="number" id="price-input-${p.id}" step="0.01" value="${p.price.toFixed(2)}" class="border p-1 w-full rounded" oninput="validateNumberInput(this)"></div>`; }); modalHtml += '</div>'; const { isConfirmed } = await Swal.fire({ title: `Edit Selling Prices ${categoryFilter ? `for ${categoryFilter}` : ''}`, html: modalHtml, width: '90%', maxWidth: '600px', showCancelButton: true, preConfirm: () => { if (Array.from(document.querySelectorAll('.swal2-html-container input.invalid')).length > 0) { Swal.showValidationMessage('Please correct invalid inputs.'); return false; } } }); if (isConfirmed) { const batch = db.batch(); const reportRef = db.collection('reports').doc(todayDateString); const reportUpdatePayload = {}; document.querySelectorAll('.swal2-html-container [data-product-id]').forEach(row => { const productId = row.dataset.productId; const newPrice = parseFloat(row.querySelector('input').value) || 0; const productRef = db.collection('products').doc(productId); batch.update(productRef, { price: newPrice }); reportUpdatePayload[`data.${productId}.price`] = newPrice; }); batch.update(reportRef, reportUpdatePayload); await batch.commit(); await loadProducts(); Toast.fire({ icon: 'success', title: 'Prices updated!' }); } }
    async function resetData() { const { isConfirmed } = await Swal.fire({ title: 'ARE YOU SURE?', html: `This will permanently delete ALL data. Type <strong>RESET</strong> to confirm.`, icon: 'warning', input: 'text', showCancelButton: true, confirmButtonColor: '#d33', preConfirm: (v) => v.toUpperCase() !== 'RESET' && Swal.showValidationMessage('You must type "RESET" to confirm.') }); if (isConfirmed) { try { const collections = ['products', 'reports', 'expenses', 'settings']; for (const collectionName of collections) { const snapshot = await db.collection(collectionName).get(); const batch = db.batch(); snapshot.docs.forEach(doc => batch.delete(doc.ref)); await batch.commit(); } await Swal.fire('Data Reset', 'All data has been deleted. The page will reload.', 'success'); location.reload(); } catch(error) { Swal.fire('Reset Failed', 'Could not clear all data.', 'error'); } } }
    async function renderPerformanceBreakdown() { const tbody = document.getElementById('performance-tbody'); tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4"><div class="loader"></div></td></tr>'; try { const reportsSnapshot = await db.collection('reports').orderBy('date', 'desc').get(); let tableHtml = ''; for (const doc of reportsSnapshot.docs) { const report = doc.data(); const dateObj = dayjs(report.date); const summary = await getDailySummary(report.date); const cashOnHand = report.cashOnHand || 0; const difference = cashOnHand - summary.totalSales; let differenceHtml; if (cashOnHand === 0 && summary.totalSales > 0) { differenceHtml = `<span>-</span>`; } else if (difference < 0) { differenceHtml = `<span class="cash-short font-semibold">(₱${formatCurrency(Math.abs(difference))})</span>`; } else if (difference > 0) { differenceHtml = `<span class="cash-over font-semibold">+₱${formatCurrency(difference)}</span>`; } else { differenceHtml = `<span class="cash-balanced font-semibold">Balanced</span>`; } tableHtml += ` <tr class="bg-white border-b performance-row" data-date="${dateObj.format('MMM D, YYYY')}"> <td class="py-4 px-6 font-medium text-slate-900">${dateObj.format('MMM D, YYYY')}</td> <td class="py-4 px-6 text-right">₱${formatCurrency(summary.totalSales)}</td> <td class="py-4 px-6 text-right">₱${formatCurrency(cashOnHand)}</td> <td class="py-4 px-6 text-right">${differenceHtml}</td> <td class="py-4 px-6 text-center"> <button class="text-blue-600 hover:underline text-xs font-medium" onclick="setWorkingDay('${report.date}')">Set as Working Day</button> </td> </tr>`; } tbody.innerHTML = tableHtml || '<tr><td colspan="5" class="text-center p-4">No reports found.</td></tr>'; } catch(error) { tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-red-500">Could not load performance data.</td></tr>'; } }
    async function renderRemainingStockSummary() { try { const reportDoc = await db.collection('reports').doc(todayDateString).get(); if (!reportDoc.exists) return; const report = reportDoc.data(); const categoryValues = { '25 KG': 0, '10 KG': 0, '5 KG': 0, 'Per Kilo': 0 }; let grandTotal = 0; for (const product of shopProducts) { const itemData = report.data[product.id]; if (itemData) { const remainingStock = Math.max(0, itemData.end); const value = remainingStock * itemData.cost; categoryValues[product.category] += value; grandTotal += value; } } for (const category of RICE_CATEGORIES) { const cleanCatId = category.replace(/\s+/g, '-'); const el = document.getElementById(`stock-value-${cleanCatId}`); if (el) el.textContent = `₱${formatCurrency(categoryValues[category])}`; } document.getElementById('stock-value-grand-total').textContent = `₱${formatCurrency(grandTotal)}`; } catch (error) { console.error("Error rendering stock value summary:", error); } }
    function filterPerformanceTable() { const searchTerm = document.getElementById('performance-search').value.toLowerCase(); document.querySelectorAll('#performance-tbody .performance-row').forEach(row => { const dateText = row.dataset.date.toLowerCase(); row.style.display = dateText.includes(searchTerm) ? '' : 'none'; }); }
    async function setWorkingDay(dateString) { if(dateString === todayDateString) return; const { isConfirmed } = await Swal.fire({ title: 'Change Working Day?', html: `This will set your active working day to <strong>${dayjs(dateString).format('MMMM D, YYYY')}</strong>.`, icon: 'warning', showCancelButton: true, confirmButtonText: 'Yes, change it!', confirmButtonColor: '#3085d6' }); if (isConfirmed) { await db.collection('settings').doc('main').update({ workingDate: dateString }); await Swal.fire('Working Day Changed', 'The application will now reload.', 'success'); location.reload(); } }
    
    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', initializeApp);

    const inventoryTbody = document.getElementById('inventory-tbody');
    inventoryTbody.addEventListener('focusin', (event) => { if (event.target.matches('input')) { inventoryTbody.querySelectorAll('.active-row').forEach(row => row.classList.remove('active-row')); event.target.closest('tr')?.classList.add('active-row'); } });
    inventoryTbody.addEventListener('focusout', (event) => { if (event.target.matches('input')) { event.target.closest('tr')?.classList.remove('active-row'); } });
    
    inventoryTbody.addEventListener('keydown', (event) => { const target = event.target; if (!target.matches('.new-stock-input, .end-input')) return; const currentTR = target.closest('tr'); if (!currentTR) return; let nextTR = null; let targetClass = target.classList.contains('new-stock-input') ? '.new-stock-input' : '.end-input'; if (event.key === 'ArrowDown' || event.key === 'Enter') { event.preventDefault(); nextTR = currentTR.nextElementSibling; while(nextTR && !nextTR.querySelector(targetClass)) { nextTR = nextTR.nextElementSibling; } } else if (event.key === 'ArrowUp') { event.preventDefault(); nextTR = currentTR.previousElementSibling; while(nextTR && !nextTR.querySelector(targetClass)) { nextTR = nextTR.previousElementSibling; } } if (nextTR) { const nextInput = nextTR.querySelector(targetClass); if (nextInput && !nextInput.disabled) { nextInput.focus(); nextInput.select(); } } });
  </script>
</body>
</html>
``````
