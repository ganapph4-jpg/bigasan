
<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rice Inventory Management System</title>
  <meta name="description" content="A simple, cloud-synced system for managing rice sales, inventory, and profit tracking.">
  
  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isBetween.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-dayjs-3@latest/dist/chartjs-adapter-dayjs-3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

  <!-- FIREBASE SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    /* Custom CSS Variables for easy theming */
    :root {
      --primary: #3b82f6; /* Blue-500 */
      --secondary: #10b981; /* Green-500 */
      --accent: #f59e0b; /* Amber-500 */
      --light: #f8fafc; /* Slate-50 */
      --dark: #1e293b; /* Slate-800 */
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background-color: var(--light); 
      color: #334155; /* Slate-700 */
      margin: 0;
    }
    
    /* View Transition Styling */
    .main-view { 
      display: none; 
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .main-view.active { 
      display: block; 
    }

    /* --- ENHANCED: Modern & Professional Table Styling --- */
    .professional-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      font-size: 14px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      border-radius: 8px;
      overflow: hidden;
    }

    /* --- Daily Report - Header & Category Styling (White Backgrounds) --- */
    .professional-table thead tr {
        background-color: white; /* Changed to white */
        color: #334155; /* Slate-700 */
        text-align: center;
        font-weight: 600;
        border-bottom: 2px solid #e2e8f0; /* Slate-200 */
    }
    
    /* --- Sticky Table Header --- */
    .professional-table thead th {
        position: sticky;
        top: 0;
        z-index: 20;
        background-color: white; /* Changed to white */
    }

    .professional-table th,
    .professional-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #e2e8f0; /* Slate-200 */
    }
    
    /* Align numbers to the right for easier reading */
    .professional-table td:not(:first-child),
    .professional-table th:not(:first-child) {
        text-align: right;
    }

    .professional-table td:first-child,
    .professional-table th:first-child {
        text-align: left;
    }

    /* Remove bottom border from last row for cleaner look */
    .professional-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    /* --- Modern Category Header Styling --- */
    .category-header td {
        font-size: 1rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #fff; /* Keep text color white for contrast with colored backgrounds */
        border: none;
        text-align: left;
        padding: 0; /* Adjust padding for clickable div */
    }
    
    /* Original category colors restored for header backgrounds */
    .category-header-25-KG { background-color: #3b82f6; } /* Blue-500 */
    .category-header-10-KG { background-color: #10b981; } /* Green-500 */
    .category-header-5-KG { background-color: #8b5cf6; } /* Purple-500 */
    .category-header-Per-Kilo { background-color: #f59e0b; } /* Amber-500 */

    /* Style for the clickable div inside category header */
    .category-header-clickable {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-left: 1.5rem;
        padding-right: 1.5rem; /* Added right padding for icon */
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
        cursor: pointer;
        /* Ensure text color is applied to the clickable div for visibility */
        color: white; 
    }

    /* Toggle icon styling */
    .toggle-icon {
        transition: transform 0.2s ease-in-out;
        color: white; /* White icon for visibility on colored backgrounds */
    }
    .toggle-icon.rotated {
        transform: rotate(-90deg); /* Adjust for your icon orientation */
    }


    /* --- Category Subheader for Alignment --- */
    .sub-header {
        background-color: white; /* Changed to white */
        font-weight: 700;
        border-top: 1px solid #e2e8f0; /* Subtle top border for separation */
    }
    .sub-header th {
        padding: 6px 15px; /* Consistent padding with other th/td */
        border-bottom: 1px solid #e2e8f0; /* Use a slightly lighter slate border */
        font-size: 0.9rem; /* 90% of 1rem */
        color: #475569; /* Slate-600 */
        text-transform: uppercase;
    }
    .sub-header th:first-child {
        text-align: left;
    }
    .sub-header th:not(:first-child) {
        text-align: right;
    }


    /* --- ENHANCED: Footer Row Styling --- */
    .category-total-row {
        font-weight: 700;
        background-color: white; /* Changed to white */
        border-top: 1px solid #e2e8f0; /* Add a top border for separation */
    }

    .grand-total-row {
        font-size: 1.125rem;
        font-weight: 700;
        background-color: white; /* Changed to white */
        color: #1e293b; /* Changed to dark text for visibility on white */
        position: sticky;
        bottom: 0;
        z-index: 10;
        border-top: 2px solid #e2e8f0; /* Stronger border for emphasis */
        border-bottom: 2px solid #e2e8f0; /* Stronger border for emphasis */
    }
    .grand-total-row td {
        border-bottom: none; /* Remove redundant bottom border on cells */
    }


    /* Input Styling */
    input[type="number"], input[type="text"], input[type="password"], input[type="date"], input[type="month"], select { 
      width: 100%; 
      padding: 6px; 
      font-size: 13px; 
      box-sizing: border-box; 
      border-radius: 4px; 
      border: 1px solid #cbd5e1; /* Slate-300 */
      transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s;
    }
    
    input[type="number"]:focus, input[type="text"]:focus, input[type="password"]:focus, input[type="date"]:focus, input[type="month"]:focus, select:focus {
      outline: none;
    }
    
    /* --- Color-coded input boxes for easy identification --- */
    .new-stock-input {
        background-color: #eff6ff; /* Blue-50 */
        border-color: #93c5fd; /* Blue-300 */
    }
    .new-stock-input:focus {
        background-color: #ffffff; /* Revert to white on focus for better text visibility */
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
    
    .open-sacks-add-input {
        background-color: #fffbeb; /* Amber-50 */
        border-color: #fcd34d; /* Amber-300 */
    }
    .open-sacks-add-input:focus {
        background-color: #ffffff;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
    }

    .end-input {
        background-color: #f0fdf4; /* Green-50 */
        border-color: #86efac; /* Green-300 */
    }
    .end-input:focus {
        background-color: #ffffff;
        border-color: var(--secondary);
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
    }

    /* New: Discount input styling */
    .discount-input {
        background-color: #fef2f2; /* Red-50 */
        border-color: #fca5a5; /* Red-300 */
    }
    .discount-input:focus {
        background-color: #ffffff;
        border-color: #ef4444; /* Red-500 */
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
    }

    /* New: Profit Margin Input styling */
    .profit-margin-input {
        background-color: #ecfdf5; /* Teal-50 */
        border-color: #5eead4; /* Teal-300 */
    }
    .profit-margin-input:focus {
        background-color: #ffffff;
        border-color: #14b8a6; /* Teal-500 */
        box-shadow: 0 0 0 2px rgba(20, 184, 166, 0.2);
    }

    /* New: Cost Input styling */
    .cost-input {
        background-color: #f0f9ff; /* Blue-50 */
        border-color: #93c5fd; /* Blue-300 */
    }
    .cost-input:focus {
        background-color: #ffffff;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }


    input.invalid {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2) !important;
    }
    
    input:disabled { 
      background-color: #f8fafc;
      color: #64748b;
      border: 1px solid #e2e8f0;
      cursor: not-allowed; 
    }
    
    /* Loader Animation */
    .loader { 
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary); 
      border-radius: 50%; 
      width: 30px; 
      height: 30px; 
      animation: spin 1s linear infinite; 
      margin: 0 auto; 
    }
    
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    
    /* Button loader */
    .btn-loader {
        border: 2px solid #f3f3f3;
        border-top: 2px solid var(--primary);
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin: 0 8px 0 0;
    }


    /* --- NEW: Full-page loader for initialization --- */
    #app-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      transition: opacity 0.3s ease-in-out;
    }
    #app-loader.hidden {
      opacity: 0;
      pointer-events: none;
    }
    #app-loader p {
      margin-top: 1rem;
      font-weight: 500;
      color: var(--dark);
    }
    
    #settings-panel { 
      transition: transform 0.3s ease-in-out; 
      transform: translateX(100%);
      box-shadow: -5px 0 15px rgba(0,0,0,0.1);
    }
    
    #settings-panel.open { 
      transform: translateX(0); 
    }
    
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px rgba(0,0,0,0.1);
    }
    
    .nav-tab {
      padding: 10px 16px;
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
      user-select: none;
    }
    
    .nav-tab.active {
      background-color: var(--primary);
      color: white;
    }
    
    .settings-tab {
      padding: 8px 14px;
      border-radius: 6px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
      user-select: none;
      border: 1px solid #e2e8f0;
      background-color: #f8fafc;
      color: #475569;
    }

    .settings-tab:hover {
      background-color: #e2e8f0;
      color: #1e293b;
    }

    .settings-tab.active {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .analytics-tab {
        padding: 8px 14px;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.2s;
        cursor: pointer;
        user-select: none;
        border: 1px solid #e2e8f0;
        background-color: #f8fafc;
        color: #475569;
    }

    .analytics-tab:hover {
        background-color: #e2e8f0;
        color: #1e293b;
    }

    .analytics-tab.active {
        background-color: var(--primary);
        color: white;
        border-color: var(--primary);
    }
    
    .btn-primary {
      background-color: var(--primary);
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 500;
      transition: background-color 0.2s;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-primary:hover {
      background-color: #2563eb;
    }

    .btn-secondary {
      background-color: #64748b;
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 500;
      transition: background-color 0.2s;
      border: none;
      cursor: pointer;
    }
    .btn-secondary:hover {
        background-color: #475569;
    }
    
    .btn-success {
      background-color: var(--secondary);
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 500;
      transition: background-color 0.2s;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-success:hover {
      background-color: #059669;
    }

    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    
    .stat-card {
      padding: 20px;
      border-left: 4px solid;
    }
    
    .category-25 { border-left-color: #3b82f6; }
    .category-10 { border-left-color: #10b981; }
    .category-5 { border-left-color: #8b5cf6; }
    .category-kg { border-left-color: #f59e0b; }

    .small-edit-btn {
        background-color: #64748b;
        color: white;
        padding: 2px 8px;
        font-size: 0.7rem;
        border-radius: 4px;
        transition: background-color 0.2s ease-in-out;
        border: none;
        cursor: pointer;
        font-weight: 500;
    }
    .small-edit-btn:hover {
        background-color: #475569;
    }
    
    /* New: Style for rows where New Stock and End inputs are filled */
    .row-complete {
        background-color: white; /* Changed to white */
    }
    .row-complete:hover {
        background-color: #f8fafc; /* Subtle hover on white */
    }

    .row-has-sales {
        background-color: white; /* Changed to white */
    }
    .row-has-sales:hover {
        background-color: #f8fafc; /* Subtle hover on white */
    }

    .row-low-stock {
        background-color: white !important; /* Changed to white */
        border-left: 4px solid #f43f5e; /* Keep red border for visual cue */
    }
    .row-low-stock:hover {
        background-color: #f8fafc !important; /* Subtle hover on white */
    }

    .row-negative-stock {
        background-color: white !important; /* Changed to white */
        border-left: 4px solid #dc2626 !important; /* Keep strong red border */
        font-weight: 600;
    }
    .row-negative-stock:hover {
      background-color: #f8fafc !important; /* Subtle hover on white */
    }
    .row-negative-stock input {
        border-color: #dc2626 !important;
    }
    
    /* --- Style for rows with a calculation/logic error --- */
    .row-logic-error {
        background-color: white !important; /* Changed to white */
        border-left: 4px solid #f59e0b !important; /* Keep amber border */
    }
    .row-logic-error:hover {
        background-color: #f8fafc !important; /* Subtle hover on white */
    }

    .active-row {
        background-color: white !important; /* Changed to white */
        outline: 2px solid var(--primary);
        outline-offset: -2px;
    }
    
    /* --- Style for Cash Reconciliation --- */
    .cash-short {
        color: #dc2626; /* Red-600 */
    }
    .cash-over {
        color: #166534; /* Green-800 */
    }
    .cash-balanced {
        color: #1e293b; /* Slate-800 */
    }

    /* NEW: Quick Modal Styling */
    .quick-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      transition: opacity 0.3s ease-in-out;
      opacity: 0;
      pointer-events: none;
    }
    .quick-modal-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .quick-modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 600px;
      transform: translateY(-20px);
      transition: transform 0.3s ease-in-out;
      max-height: 90vh;
      overflow-y: auto;
    }
    .quick-modal-overlay.open .quick-modal-content {
      transform: translateY(0);
    }


    @media (max-width: 768px) {
      .professional-table {
        font-size: 12px;
      }
      
      .professional-table th, .professional-table td {
        padding: 6px 8px;
      }

      /* --- MOBILE OPTIMIZATION for Sales/Profit Columns --- */
      .total-sales-val, .profit-val {
        padding: 6px 4px !important; /* Reduce padding on mobile */
        font-size: 11px !important; /* Make font slightly smaller */
        word-break: break-word;
      }
      
      .card {
        margin-bottom: 16px;
      }
      .settings-tab, .analytics-tab {
        flex-grow: 1;
        text-align: center;
      }
    }
    
    /* --- PRINT STYLES --- */
    @media print {
        body {
            padding: 0;
            background-color: #fff;
        }
        .no-print {
            display: none !important;
        }
        .main-view {
            display: block !important;
            max-width: 100%;
            margin: 0;
        }
        .professional-table {
            box-shadow: none;
            border: 1px solid #ccc;
            font-size: 10pt;
        }
        .professional-table th, .professional-table td {
            padding: 8px 10px;
        }
        .grand-total-row {
            position: static;
            color: #000;
            background-color: #eee;
        }
        .grand-total-row td {
            border-bottom: 1px solid #ccc;
        }
        #report-title {
            text-align: center;
            width: 100%;
        }
        input:disabled { /* Make disabled inputs look like text for printing */
          background-color: transparent !important;
          border: none !important;
          color: #000 !important;
        }
    }
  </style>
</head>
<body class="p-4">

  <!-- Full-page loader -->
  <div id="app-loader">
    <div class="loader"></div>
    <p id="loader-status">Initializing System...</p>
  </div>

  <!-- Shared Header -->
  <div class="max-w-7xl mx-auto mb-6 flex flex-col sm:flex-row justify-between items-center gap-4 no-print" role="banner">
    <div>
      <h1 class="text-2xl font-bold text-slate-800">Rice Inventory Management</h1>
      <p class="text-sm text-slate-500" id="header-subtitle">Today is</p>
    </div>
    <div class="flex items-center gap-4">
      <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
        <span id="current-date-display" aria-live="polite"></span>
      </div>
      <button onclick="showHistory()" title="Report History" aria-label="View Report History" class="text-slate-600 hover:text-blue-600 p-2 transition-colors rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
      </button>
      <button onclick="openSettingsWithPassword()" title="Settings" aria-label="Open Settings" class="text-slate-600 hover:text-blue-600 p-2 transition-colors rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924-1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0 3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826 3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <nav class="max-w-7xl mx-auto mb-6 bg-white rounded-lg p-1 shadow-sm flex no-print" aria-label="Main Navigation">
    <button class="nav-tab active" role="tab" aria-selected="true" aria-controls="dashboard-view" onclick="showView('dashboard-view')">Dashboard</button>
    <button class="nav-tab" role="tab" aria-selected="false" aria-controls="daily-report-view" onclick="showCurrentDayReport()">Daily Report</button>
    <button class="nav-tab" role="tab" aria-selected="false" aria-controls="expenses-view" onclick="showView('expenses-view')">Expenses</button>
  </nav>

  <!-- VIEW 1: Dashboard -->
  <main id="dashboard-view" class="main-view active max-w-7xl mx-auto" role="main">
      <div id="dashboard-header" class="mb-6">
        <h2 id="dashboard-title" class="text-xl font-bold text-slate-800">Dashboard Overview</h2>
        <p class="text-sm text-slate-500" id="dashboard-date"></p>
      </div>
      <!-- UPDATED Dashboard Grid with new labels and Skeleton UI -->
      <div id="dashboard-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Skeleton Card 1 -->
        <div class="card p-6 flex items-center gap-6 bg-blue-50 border-l-4 border-blue-500">
            <div class="bg-blue-100 p-4 rounded-full"><svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 6V5m0 14v-1m-7-7H4m16 0h-1m-1.61-5.61l.707-.707M6.343 17.657l-.707.707m12.02-12.02l.707.707M6.343 6.343l-.707-.707"></path></svg></div>
            <div>
                <p class="text-sm text-slate-500">Yesterday's Total Sales</p>
                <div id="dashboard-total-sales" class="animate-pulse"><div class="h-8 bg-slate-200 rounded w-32 mt-1"></div></div>
            </div>
        </div>
        <!-- Skeleton Card 2 -->
        <div class="card p-6 flex items-center gap-6 bg-yellow-50 border-l-4 border-yellow-500">
            <div class="bg-yellow-100 p-4 rounded-full"><svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2z"></path></svg></div>
            <div>
                <p class="text-sm text-slate-500">Yesterday's Expenses</p>
                <div id="dashboard-total-expenses" class="animate-pulse"><div class="h-8 bg-slate-200 rounded w-24 mt-1"></div></div>
            </div>
        </div>
        <!-- Skeleton Card 3 -->
        <div class="card p-6 flex items-center gap-6 bg-green-50 border-l-4 border-green-500">
            <div class="bg-green-100 p-4 rounded-full"><svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg></div>
            <div>
                <p class="text-sm text-slate-500">Yesterday's Profit</p>
                <div id="dashboard-total-profit" class="animate-pulse"><div class="h-8 bg-slate-200 rounded w-28 mt-1"></div></div>
            </div>
        </div>
        <!-- Skeleton Card 4 -->
        <div class="card p-6 flex items-center gap-6 bg-teal-50 border-l-4 border-teal-500">
            <div class="bg-teal-100 p-4 rounded-full"><svg class="w-8 h-8 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5h2m-2 2h2m-2 2h2"></path></svg></div>
            <div>
                <p class="text-sm text-slate-500">Monthly Net Profit (To Date)</p>
                <div id="dashboard-monthly-net-profit" class="animate-pulse"><div class="h-8 bg-slate-200 rounded w-36 mt-1"></div></div>
            </div>
        </div>
        <!-- Update Profit Margins Button -->
        <div class="lg:col-span-2">
            <button onclick="openQuickProfitMarginModal()" class="btn-primary w-full py-3 text-lg font-semibold flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                </svg>
                Quick Update Prices
            </button>
        </div>
        <!-- Skeleton Low Stock Card -->
        <div class="card p-6 bg-red-50 border-l-4 border-red-500 md:col-span-2 lg:col-span-2">
            <h3 class="font-bold text-lg text-slate-800 mb-3">Items Needing Restock (Live)</h3>
            <div id="low-stock-list" class="space-y-2 max-h-48 overflow-y-auto">
              <div class="animate-pulse flex justify-between items-center text-sm p-2 bg-white rounded">
                  <div class="h-4 bg-slate-200 rounded w-2/5"></div>
                  <div class="h-4 bg-slate-200 rounded w-1/5"></div>
              </div>
              <div class="animate-pulse flex justify-between items-center text-sm p-2 bg-white rounded">
                  <div class="h-4 bg-slate-200 rounded w-1/2"></div>
                  <div class="h-4 bg-slate-200 rounded w-1/6"></div>
              </div>
            </div>
        </div>
      </div>
  </main>


  <!-- VIEW 2: Daily Report / Inventory -->
  <div id="daily-report-view" class="main-view max-w-7xl mx-auto" role="main" aria-labelledby="report-title">
    <div class="mb-6 p-5 bg-white rounded-lg shadow-sm flex flex-wrap justify-between items-center gap-4">
      <div class="flex items-center gap-4">
        <h2 id="report-title" class="text-xl font-bold text-slate-800">Daily Inventory Report</h2>
      </div>
      <div id="report-actions" class="flex gap-2">
        <button onclick="window.print()" class="btn-primary no-print" aria-label="Print this report">
            Print Report
        </button>
      </div>
    </div>
    
    <div id="editing-past-banner" class="hidden max-w-7xl mx-auto mb-4 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-md no-print">
        <p class="font-bold">You are editing a past report.</p>
        <p class="text-sm">Changes saved here will NOT automatically update the beginning stock for subsequent days. Please review future reports if you change an "Ending" value.</p>
    </div>
    
    <div class="overflow-hidden">
      <div class="overflow-x-auto">
        <table class="professional-table" aria-live="polite" aria-atomic="true">
          <thead>
            <tr>
              <th>PRODUCT</th>
              <th>BEGIN <br><button class="small-edit-btn mt-1 no-print" onclick="promptForCategoryThenEdit('begin')" aria-label="Edit all beginning stock">EDIT ALL</button></th>
              <th>NEW STOCK</th>
              <th>OPEN SACKS</th>
              <th>ENDING</th>
              <th>SOLD</th>
              <th>SELLING PRICE (₱) <br><button class="small-edit-btn mt-1 no-print" onclick="promptForCategoryThenEdit('price')" aria-label="Edit all prices">EDIT ALL</button></th> <!-- Modified this button to open quick profit modal -->
              <th>TOTAL SALES (₱)</th>
              <th>PROFIT (₱)</th>
            </tr>
          </thead>
          <tbody id="inventory-tbody">
            <tr><td colspan="9" class="text-center p-4"><div class="loader" role="status" aria-label="Loading inventory report"></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- VIEW 3: Expenses -->
    <div id="expenses-view" class="main-view max-w-7xl mx-auto" role="main" aria-labelledby="expenses-title">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Left Side: Add Expense Form -->
            <div class="md:col-span-1">
                <div class="card p-6">
                    <h3 id="expense-form-title" class="text-lg font-bold text-slate-800 mb-4">Add Expense for Today</h3>
                    <div class="space-y-4">
                        <input type="hidden" id="expense-id">
                        <div>
                            <label for="expense-description" class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                            <input id="expense-description" type="text" placeholder="e.g., Transportation" class="border border-slate-300 p-2 w-full rounded-md" aria-required="true">
                        </div>
                        <div>
                            <label for="expense-amount" class="block text-sm font-medium text-slate-700 mb-1">Amount (₱)</label>
                            <input id="expense-amount" type="number" step="0.01" placeholder="e.g., 150.00" class="border border-slate-300 p-2 w-full rounded-md" oninput="validateNumberInput(this)" aria-required="true">
                        </div>
                        <div class="flex gap-2">
                            <button id="save-expense-btn" onclick="saveExpense()" class="btn-success flex-1">Save Expense</button>
                            <button id="cancel-expense-btn" onclick="clearExpenseForm()" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-md flex-1 hover:bg-slate-300 transition-colors">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Right Side: Expense List -->
            <div class="md:col-span-2">
                <div class="card p-6">
                    <h2 id="expenses-title" class="text-xl font-bold text-slate-800 mb-4">Today's Expenses</h2>
                    <div id="expense-list-container" class="space-y-2 max-h-96 overflow-y-auto" aria-live="polite" aria-atomic="true">
                        <p class="text-center text-slate-500 py-8">No expenses recorded for today.</p>
                    </div>
                    <div class="mt-4 pt-4 border-t font-bold text-lg flex justify-between">
                        <span>Total Expenses:</span>
                        <span id="total-expenses-display">₱0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

  <!-- VIEW 5: Report History -->
  <div id="history-view" class="main-view max-w-7xl mx-auto" role="region" aria-labelledby="history-title">
    <div class="mb-6 flex items-center gap-4">
      <h2 id="history-title" class="text-xl font-bold text-slate-700">Report History</h2>
    </div>
    
    <div id="history-list" class="bg-white rounded-lg shadow divide-y" aria-live="polite" aria-atomic="true">
      <div class="p-4 text-center text-slate-500"><div class="loader" role="status" aria-label="Loading reports"></div></div>
    </div>
  </div>
  
  <!-- Settings Panel -->
  <div id="settings-panel" class="fixed top-0 right-0 h-full w-full max-w-2xl bg-white shadow-lg z-50 p-6 overflow-y-auto no-print" role="dialog" aria-modal="true" aria-labelledby="settings-title" tabindex="-1">
    <div class="flex justify-between items-center mb-6">
      <h2 id="settings-title" class="text-2xl font-bold text-slate-800">Settings</h2>
      <button onclick="closeSettingsPanel()" class="text-slate-500 hover:text-red-500 text-3xl transition-colors rounded-full focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50" aria-label="Close settings panel">&times;</button>
    </div>
    
    <!-- Settings Tabs -->
    <div class="mb-6 flex flex-wrap gap-2" role="tablist">
      <button id="tab-product-management" class="settings-tab active" role="tab" aria-selected="true" aria-controls="settings-product-management-content" onclick="showSettingsTab('settings-product-management-content')">Product Management</button>
      <button id="tab-profit-margin-management" class="settings-tab" role="tab" aria-selected="false" aria-controls="settings-profit-margin-content" onclick="showSettingsTab('settings-profit-margin-content')">Profit Margins</button> <!-- NEW TAB -->
      <button id="tab-performance" class="settings-tab" role="tab" aria-selected="false" aria-controls="settings-performance-content" onclick="showSettingsTab('settings-performance-content')">Performance</button>
      <button id="tab-analytics" class="settings-tab" role="tab" aria-selected="false" aria-controls="settings-analytics-content" onclick="showSettingsTab('settings-analytics-content')">Analytics</button>
      <button id="tab-security" class="settings-tab" role="tab" aria-selected="false" aria-controls="settings-security-content" onclick="showSettingsTab('settings-security-content')">Security</button>
      <button id="tab-data-management" class="settings-tab" role="tab" aria-selected="false" aria-controls="settings-data-management-content" onclick="showSettingsTab('settings-data-management-content')">Data Management</button>
    </div>

    <!-- Settings Content Sections -->
    <div id="settings-product-management-content" class="settings-tab-content" role="tabpanel" aria-labelledby="tab-product-management">
      <div class="p-4 border rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-3 sr-only">Product Management</h3>
        <div id="product-list-container" class="space-y-2 mb-4 max-h-64 overflow-y-auto border p-2 rounded bg-slate-50" aria-live="polite" aria-atomic="true">
          <p class="text-center text-slate-500 py-4">No products yet.</p>
        </div>
        
        <div class="p-3 bg-slate-50 rounded border">
          <h4 id="product-form-title" class="font-semibold mb-2">Add New Product</h4>
          <input type="hidden" id="product-id">
          <div class="space-y-3">
            <div>
              <label for="product-name" class="block text-sm font-medium text-slate-700 mb-1">Product Name</label>
              <input id="product-name" type="text" placeholder="e.g., Kylo" class="border border-slate-300 p-2 w-full rounded-md" aria-required="true">
            </div>
            <div>
              <label for="product-cost" class="block text-sm font-medium text-slate-700 mb-1">Cost Price / Capital (₱)</label>
              <input id="product-cost" type="number" step="0.01" placeholder="e.g., 1150.00" class="border border-slate-300 p-2 w-full rounded-md" oninput="validateNumberInput(this)" aria-required="true">
            </div>
            <div>
              <label for="product-profit-margin" class="block text-sm font-medium text-slate-700 mb-1">Profit Margin (₱)</label> <!-- Changed from Selling Price -->
              <input id="product-profit-margin" type="number" step="0.01" placeholder="e.g., 50.00" class="border border-slate-300 p-2 w-full rounded-md profit-margin-input" oninput="validateNumberInput(this)" aria-required="true">
            </div>
            <div>
              <label for="product-minstock" class="block text-sm font-medium text-slate-700 mb-1">Minimum Stock Level</label>
              <input id="product-minstock" type="number" placeholder="e.g., 5" class="border border-slate-300 p-2 w-full rounded-md" oninput="validateNumberInput(this, true)" aria-required="true">
            </div>
            <div>
              <label for="product-category" class="block text-sm font-medium text-slate-700 mb-1">Category</label>
              <select id="product-category" class="border border-slate-300 p-2 w-full rounded-md" aria-required="true">
                <option value="25 KG">25 KG</option>
                <option value="10 KG">10 KG</option>
                <option value="5 KG">5 KG</option>
                <option value="Per Kilo">Per Kilo</option>
              </select>
            </div>
            <div class="flex gap-2">
              <button id="save-product-btn" onclick="saveProduct()" class="btn-success flex-1">Save Product</button>
              <button id="cancel-product-btn" onclick="clearProductForm()" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-md flex-1 hover:bg-slate-300 transition-colors">Cancel</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- NEW: Profit Margin Management Content -->
    <div id="settings-profit-margin-content" class="settings-tab-content hidden" role="tabpanel" aria-labelledby="tab-profit-margin-management">
        <h3 class="text-xl font-bold text-slate-700 mb-4">Manage Profit Margins by Category</h3>
        <p class="text-sm text-slate-500 mb-4">Adjust the profit amount added to the cost price for each product. The selling price will be calculated automatically.</p>

        <div id="profit-margin-list-container" class="space-y-6">
            <!-- Profit margins will be rendered here -->
            <div class="text-center p-4"><div class="loader"></div></div>
        </div>
        <button onclick="saveAllProfitMargins()" class="btn-primary w-full mt-6">Save All Profit Margins</button>
    </div>
    
    <!-- Performance Breakdown Content -->
    <div id="settings-performance-content" class="settings-tab-content hidden" role="tabpanel" aria-labelledby="tab-performance">
        
      <h3 class="text-xl font-bold text-slate-700 mb-4">Daily Performance History</h3>
      <div class="overflow-y-auto max-h-[80vh]">
        <table class="w-full text-sm text-left text-slate-500">
            <thead class="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0">
                <tr>
                    <th scope="col" class="py-3 px-6">Date</th>
                    <th scope="col" class="py-3 px-6 text-right">Total Sales</th>
                    <th scope="col" class="py-3 px-6 text-right">Profit</th> <!-- Added Profit column -->
                    <th scope="col" class="py-3 px-6 text-right">Cash on Hand</th>
                    <th scope="col" class="py-3 px-6 text-right">Difference</th>
                </tr>
            </thead>
            <tbody id="performance-tbody">
                <tr><td colspan="5" class="text-center p-4"><div class="loader"></div></td></tr> <!-- Updated colspan -->
            </tbody>
        </table>
      </div>
    </div>

    <div id="settings-security-content" class="settings-tab-content hidden" role="tabpanel" aria-labelledby="tab-security">
      <div class="p-4 border rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-3 sr-only">Security</h3>
        <div class="space-y-3">
          <div>
            <label for="currentPassword" class="block text-sm font-medium text-slate-700 mb-1">Current Password</label>
            <input id="currentPassword" type="password" class="border border-slate-300 p-2 w-full rounded-md" autocomplete="current-password">
          </div>
          <div>
            <label for="newPassword" class="block text-sm font-medium text-slate-700 mb-1">New Password</label>
            <input id="newPassword" type="password" class="border border-slate-300 p-2 w-full rounded-md" autocomplete="new-password">
          </div>
          <div>
            <label for="confirmPassword" class="block text-sm font-medium text-slate-700 mb-1">Confirm New Password</label>
            <input id="confirmPassword" type="password" class="border border-slate-300 p-2 w-full rounded-md" autocomplete="new-password">
          </div>
        </div>
        <button id="save-password-btn" onclick="savePassword()" class="btn-primary w-full mt-4">Change Password</button>
      </div>
    </div>
    
    <!-- Analytics Content -->
    <div id="settings-analytics-content" class="settings-tab-content hidden" role="tabpanel" aria-labelledby="tab-analytics">
      <div class="mb-6 flex items-center gap-4">
        <h3 class="text-xl font-bold text-slate-700">Sales Analytics</h3>
      </div>

      <!-- Analytics Sub-Tabs -->
      <div class="mb-6 flex flex-wrap gap-2" role="tablist">
        <button id="tab-analytics-overview" class="analytics-tab active" role="tab" aria-selected="true" aria-controls="analytics-overview-content" onclick="showAnalyticsSubTab('analytics-overview-content')">Sales Overview</button>
        <button id="tab-analytics-financial-summary" class="analytics-tab" role="tab" aria-selected="false" aria-controls="analytics-financial-summary-content" onclick="showAnalyticsSubTab('analytics-financial-summary-content')">Financial Summary</button>
        <button id="tab-analytics-products" class="analytics-tab" role="tab" aria-selected="false" aria-controls="analytics-products-content" onclick="showAnalyticsSubTab('analytics-products-content')">Products</button>
      </div>
      
      <!-- Analytics Content: Overview Sub-Tab -->
      <div id="analytics-overview-content" class="analytics-tab-content" role="tabpanel" aria-labelledby="tab-analytics-overview">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="card p-6">
            <h4 class="text-lg font-bold text-slate-800 mb-4">Report Options</h4>
            <div class="space-y-3">
              <div>
                <label for="analytics-mode-select" class="block text-sm font-medium text-slate-700 mb-1">Select Report Type</label>
                <select id="analytics-mode-select" class="w-full border border-slate-300 rounded-md py-2 px-3" onchange="toggleAnalyticsDateInputs()">
                  <option value="daily">Daily Breakdown</option>
                  <option value="range">Date Range Report</option>
                  <option value="monthly">Monthly Report</option>
                </select>
              </div>

              <div id="daily-date-input">
                <label for="analytics-single-date" class="block text-sm font-medium text-slate-700 mb-1">Select Date</label>
                <input type="date" id="analytics-single-date" class="w-full border border-slate-300 rounded-md py-2 px-3">
              </div>

              <div id="range-date-inputs" class="hidden">
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label for="analytics-from-date" class="block text-sm font-medium text-slate-700 mb-1">From Date</label>
                    <input type="date" id="analytics-from-date" class="w-full border border-slate-300 rounded-md py-2 px-3">
                  </div>
                  <div>
                    <label for="analytics-to-date" class="block text-sm font-medium text-slate-700 mb-1">To Date</label>
                    <input type="date" id="analytics-to-date" class="w-full border border-slate-300 rounded-md py-2 px-3">
                  </div>
                </div>
              </div>
            </div>
            <button onclick="loadAnalytics()" class="w-full btn-primary mt-4">Generate Report</button>
          </div>
          
          <div class="card p-6" aria-live="polite" aria-atomic="true">
            <h4 class="text-lg font-bold text-slate-800 mb-4">Summary</h4>
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-slate-600">Total Sales</span>
                <span id="analytics-total-sales" class="font-semibold">₱0.00</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-slate-600">Total Profit</span>
                <span id="analytics-total-profit" class="font-semibold">₱0.00</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-slate-600">Average Daily Sales</span>
                <span id="analytics-avg-sales" class="font-semibold">₱0.00</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-slate-600">Average Profit Margin</span>
                <span id="analytics-avg-margin" class="font-semibold">0%</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Financial Summary Sub-Tab -->
      <div id="analytics-financial-summary-content" class="analytics-tab-content hidden" role="tabpanel" aria-labelledby="tab-analytics-financial-summary">
        <div class="card p-6 mb-6">
            <h4 class="text-lg font-bold text-slate-800 mb-4">Monthly Financial Summary</h4>
            <div class="max-w-xs">
                <label for="financial-month-select" class="block text-sm font-medium text-slate-700 mb-1">Select Month</label>
                <input type="month" id="financial-month-select" class="w-full border border-slate-300 rounded-md py-2 px-3" onchange="loadFinancialSummary()">
            </div>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6" aria-live="polite">
            <div class="card p-4 bg-blue-50"><p class="text-sm text-slate-500">Total Sales</p><p id="fs-total-sales" class="text-2xl font-bold text-slate-800">₱0.00</p></div>
            <div class="card p-4 bg-orange-50"><p class="text-sm text-slate-500">Cost of Goods Sold</p><p id="fs-total-cogs" class="text-2xl font-bold text-slate-800">₱0.00</p></div>
            <div class="card p-4 bg-cyan-50"><p class="text-sm text-slate-500">Gross Profit</p><p id="fs-gross-profit" class="text-2xl font-bold text-slate-800">₱0.00</p></div>
            <div class="card p-4 bg-yellow-50"><p class="text-sm text-slate-500">Expenses</p><p id="fs-total-expenses" class="text-2xl font-bold text-slate-800">₱0.00</p></div>
            <div class="card p-4 bg-purple-50"><p class="text-sm text-slate-500">Capital for New Stock</p><p id="fs-new-stock-cost" class="text-2xl font-bold text-slate-800">₱0.00</p></div>
            <div class="card p-4 bg-green-50"><p class="text-sm text-green-800 font-bold">Net Profit (Take-Home)</p><p id="fs-net-profit" class="text-3xl font-bold text-green-700">₱0.00</p></div>
        </div>
        <div class="card p-6">
            <h4 class="text-lg font-bold text-slate-800 mb-4">Daily Money Flow (Sales vs. Reinvestment & Profit)</h4>
            <canvas id="moneyFlowChart" height="250" role="img" aria-label="Daily Money Flow Chart"></canvas>
        </div>
      </div>
      
      <!-- Analytics Content: Products Sub-Tab -->
      <div id="analytics-products-content" class="analytics-tab-content hidden" role="tabpanel" aria-labelledby="tab-analytics-products">
          <div class="card p-6 mb-6">
            <h4 class="text-lg font-bold text-slate-800 mb-4">Top Performing Products</h4>
            <p class="text-sm text-slate-500">Use the "Sales Overview" tab to select a date range for this report.</p>
          </div>
          <div id="analytics-top-products" class="space-y-3">
            <p class="text-center text-slate-500 py-4">No sales data for this period.</p>
          </div>
      </div>
    </div>

    <!-- Data Management Content -->
    <div id="settings-data-management-content" class="settings-tab-content hidden" role="tabpanel" aria-labelledby="tab-data-management">
      <div class="p-4 border rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-3">Backup & Restore</h3>
        <p class="text-sm text-slate-500 mb-4">Save a local copy of all data or restore the application from a backup file.</p>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <button onclick="backupAllData()" class="w-full bg-blue-100 text-blue-700 hover:bg-blue-200 py-2 px-4 rounded transition">
            Backup All Data to File
          </button>
          <button onclick="restoreDataFromFile()" class="w-full bg-slate-100 text-slate-700 hover:bg-slate-200 py-2 px-4 rounded transition">
            Restore Data from File
          </button>
        </div>
      </div>
      <div class="p-4 border border-red-200 bg-red-50 rounded-lg mb-6">
        <h3 class="text-lg font-semibold mb-3 text-red-800">Danger Zone</h3>
        <div class="space-y-3">
          <div>
            <button onclick="resetSalesData()" class="w-full bg-yellow-100 text-yellow-800 hover:bg-yellow-200 py-2 px-4 rounded transition">
              Reset Sales Data
            </button>
            <p class="text-xs text-slate-500 mt-1 pl-1">Deletes all `reports` and `expenses`. Products and settings are kept.</p>
          </div>
          <div>
            <button onclick="factoryReset()" class="w-full bg-red-100 text-red-700 hover:bg-red-200 py-2 px-4 rounded transition">
              Factory Reset
            </button>
            <p class="text-xs text-slate-500 mt-1 pl-1">Deletes EVERYTHING from the database. This cannot be undone.</p>
          </div>
        </div>
      </div>
    </div>
    <input type="file" id="import-file-input" class="hidden" accept=".json" onchange="handleFileSelect(event)">
  </div>

  <!-- NEW: Quick Profit Margin Update Modal -->
  <div id="quick-profit-modal-overlay" class="quick-modal-overlay no-print">
    <div class="quick-modal-content">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-slate-800">Quick Update Prices</h3>
        <button onclick="closeQuickProfitMarginModal()" class="text-slate-500 hover:text-red-500 text-3xl transition-colors rounded-full focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50" aria-label="Close quick profit margin modal">&times;</button>
      </div>

      <div class="mb-4">
        <label for="quick-profit-category-select" class="block text-sm font-medium text-slate-700 mb-1">Select Category:</label>
        <select id="quick-profit-category-select" class="w-full border border-slate-300 p-2 rounded-md" onchange="renderQuickProfitMarginProducts(this.value)">
          <option value="">-- Select a Category --</option>
          <option value="25 KG">25 KG</option>
          <option value="10 KG">10 KG</option>
          <option value="5 KG">5 KG</option>
          <option value="Per Kilo">Per Kilo</option>
        </select>
      </div>

      <div id="quick-profit-products-container" class="space-y-3 mb-6 max-h-64 overflow-y-auto border p-3 rounded bg-slate-50">
        <p class="text-center text-slate-500">Select a category to view products.</p>
      </div>

      <div class="flex justify-center gap-2"> <!-- Added justify-center here -->
        <button onclick="saveQuickProfitMarginsFromModal()" class="btn-primary">Save Changes</button>
        <button onclick="closeQuickProfitMarginModal()" class="btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // --- FIREBASE & APP INITIALIZATION ---

    const firebaseConfig = {
      apiKey: "AIzaSyAeu-G3dsrumVJxpXUa0TKtJbCnpxs5UBA",
      authDomain: "bigasan-e89a7.firebaseapp.com",
      projectId: "bigasan-e89a7",
      storageBucket: "bigasan-e89a7.firebasestorage.app",
      messagingSenderId: "346505786480",
      appId: "1:346505786480:web:c33250ea0975ff192970b5"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // --- NEW: Enable Firestore offline persistence ---
    // This allows the app to work offline and syncs changes when the connection is back.
    db.enablePersistence().catch((err) => {
      if (err.code == 'failed-precondition') {
        // Multiple tabs open, persistence can only be enabled in one.
        console.warn('Firestore persistence failed: multiple tabs open.');
      } else if (err.code == 'unimplemented') {
        // The current browser does not support this feature.
        console.warn('Firestore persistence is not available in this browser.');
      }
    });


    // --- GLOBAL CONSTANTS & VARIABLES ---

    const APP_VERSION = 1.3; // Updated version
    const RICE_CATEGORIES = ['25 KG', '10 KG', '5 KG', 'Per Kilo'];
    const HASH_SALT = 'rice-inventory-management-salt'; 
    const COLLECTIONS_TO_BACKUP = ['products', 'reports', 'expenses', 'settings'];
    
    dayjs.extend(dayjs_plugin_isBetween);

    const Toast = Swal.mixin({ 
        toast: true, 
        position: 'top-end', 
        showConfirmButton: false, 
        timer: 3000, 
        timerProgressBar: true 
    });

    let shopProducts = [];
    let todayDateString;
    let moneyFlowChartInstance = null;
    let calculationTimeout;
    let reportListener = null;
    let expensesListener = null;
    let dashboardListeners = [];
    
    
    // --- UTILITY & HELPER FUNCTIONS ---

    /**
     * Toggles the loading state of a button, showing a spinner.
     * @param {HTMLElement} button The button element.
     * @param {boolean} isLoading True to show loader, false to restore text.
     */
    function toggleButtonLoading(button, isLoading) {
        if (!button) return;
        if (isLoading) {
            button.disabled = true;
            button.dataset.originalText = button.innerHTML;
            button.innerHTML = `<span class="btn-loader"></span> Processing...`;
        } else {
            button.disabled = false;
            button.innerHTML = button.dataset.originalText || 'Save';
        }
    }

    /**
     * Handles Firestore errors and returns a user-friendly message.
     * @param {Error} error The Firestore error object.
     * @returns {string} A user-friendly error message.
     */
    function handleFirestoreError(error) {
        console.error("Firestore Error:", error.code, error.message);
        switch (error.code) {
            case 'permission-denied':
                return 'Error: You do not have permission to perform this action.';
            case 'unavailable':
                return 'The service is currently unavailable. Please check your internet connection and try again.';
            case 'not-found':
                return 'Could not find the requested document.';
            default:
                return 'An unexpected error occurred. Please try again.';
        }
    }

    async function initializeApp() {
        try {
            await runMigrations();
            
            todayDateString = dayjs().format('YYYY-MM-DD');
            document.getElementById('current-date-display').textContent = dayjs(todayDateString).format('MMMM D, YYYY');
            document.getElementById('header-subtitle').textContent = `Today is`;

            await loadProducts(); 
            renderProductList(); 

            document.getElementById('analytics-single-date').value = todayDateString;
            document.getElementById('analytics-from-date').value = dayjs(todayDateString).subtract(7, 'day').format('YYYY-MM-DD');
            document.getElementById('analytics-to-date').value = todayDateString;
            document.getElementById('financial-month-select').value = dayjs(todayDateString).format('YYYY-MM');
            
            showView('dashboard-view');

            document.getElementById('app-loader').classList.add('hidden');
        } catch (error) {
            // --- ENHANCED: Graceful initialization failure ---
            console.error("Critical Error during App Initialization:", error);
            const loader = document.getElementById('app-loader');
            loader.classList.remove('hidden'); // Ensure loader is visible
            loader.innerHTML = `
                <div class="text-center p-4">
                    <h2 class="text-xl font-bold text-red-600 mb-2">Application Failed to Start</h2>
                    <p class="text-slate-600">${handleFirestoreError(error)}</p>
                    <p class="text-slate-500 text-sm mt-1">Please check your internet connection and refresh the page.</p>
                    <button onclick="location.reload()" class="btn-primary mt-4">Retry</button>
                </div>`;
        }
    }

    function validateNumberInput(inputElement, allowZero = true) {
        if (inputElement.value.trim() === '') {
            inputElement.classList.remove('invalid');
            return true;
        }
        const value = parseFloat(inputElement.value);
        if (isNaN(value) || value < 0) {
            inputElement.classList.add('invalid');
            return false;
        } else {
            inputElement.classList.remove('invalid');
            return true;
        }
    }

    function formatCurrency(amount) {
        const num = parseFloat(amount);
        return isNaN(num) ? '0.00' : num.toFixed(2);
    }
    
    function hashPassword(password) {
        return CryptoJS.SHA256(password + HASH_SALT).toString();
    }


    // --- DATA MANAGEMENT FUNCTIONS (FIRESTORE) ---
    
    async function runMigrations() {
        const loaderStatus = document.getElementById('loader-status');
        const localVersion = localStorage.getItem('app_version');

        if (parseFloat(localVersion) !== APP_VERSION) {
            loaderStatus.textContent = 'Checking for updates...';
            const settingsRef = db.collection('settings').doc('app_version');
            const doc = await settingsRef.get();
            const dbVersion = doc.exists ? doc.data().version : 0;

            if (dbVersion < APP_VERSION) {
                // Migration logic for old products to add profitMargin if they only have price
                const productsSnapshot = await db.collection('products').get();
                const batch = db.batch();
                productsSnapshot.docs.forEach(doc => {
                    const productData = doc.data();
                    if (productData.price !== undefined && productData.profitMargin === undefined) {
                        // Estimate profitMargin if possible, or set a default
                        // For now, let's set profitMargin = price - cost, or 0 if cost is missing/negative
                        const calculatedProfitMargin = (productData.price || 0) - (productData.cost || 0);
                        batch.update(doc.ref, { profitMargin: Math.max(0, calculatedProfitMargin) });
                    }
                });
                await batch.commit();

                await settingsRef.set({ version: APP_VERSION });
                Toast.fire({ icon: 'info', title: 'Application updated successfully!' });
            }
            localStorage.setItem('app_version', APP_VERSION);
        }
        loaderStatus.textContent = 'Loading application...';
    }

    async function loadProducts() {
        try {
            const productsSnapshot = await db.collection('products').orderBy('name').get();
            // Ensure products have a default profitMargin if missing (e.g., from old data or a new product creation without it)
            shopProducts = productsSnapshot.docs.map(doc => {
                const data = doc.data();
                if (data.profitMargin === undefined) {
                    // Fallback: if profitMargin is missing, try to calculate from price - cost, or default to 0
                    const calculatedProfitMargin = (data.price || 0) - (data.cost || 0);
                    data.profitMargin = Math.max(0, calculatedProfitMargin);
                    // Optionally, you might want to save this back to Firestore
                }
                return data;
            });
        } catch (error) {
            console.error("Error loading products:", error);
            throw error;
        }
    }

    async function startDay(dateString) {
        const reportRef = db.collection('reports').doc(dateString);
        let reportDoc = await reportRef.get();

        if (reportDoc.exists) {
            return reportDoc.data();
        }

        const lastReportDate = dayjs(dateString).subtract(1, 'day').format('YYYY-MM-DD');
        const lastReportDoc = await db.collection('reports').doc(lastReportDate).get();
        const lastReport = lastReportDoc.exists ? lastReportDoc.data() : null;
        
        const newReportData = {};
        shopProducts.forEach(p => {
            const lastEndStock = lastReport?.data[p.id]?.end || 0;
            newReportData[p.id] = { 
                begin: lastEndStock, 
                newStock: 0, 
                openedSacks: 0,
                end: lastEndStock, 
                // Store profitMargin, not price, in the report data
                profitMargin: p.profitMargin !== undefined ? p.profitMargin : 0, 
                cost: p.cost 
            };
        });

        const report = { date: dateString, data: newReportData, cashOnHand: 0, discountAmount: 0, isFinalized: false };
        await reportRef.set(report);
        Toast.fire({ icon: 'info', title: `Started new report for ${dayjs(dateString).format('MMM D')}` });
        return report;
    }

    async function saveInventoryData(dateString, productId, data) {
        try {
            const reportRef = db.collection('reports').doc(dateString);
            const updatePayload = {};
            for (const key in data) {
                updatePayload[`data.${productId}.${key}`] = data[key];
            }
            await reportRef.update(updatePayload);
            recalculateAndRenderAllTotals();
        } catch (error) {
            Toast.fire({ icon: 'error', title: handleFirestoreError(error) });
        }
    }

    async function finalizeReport() {
        // Step 1: Perform global validation check before proceeding
        let hasLogicErrors = false;
        const errorMessages = [];

        document.querySelectorAll('#inventory-tbody tr[data-id]').forEach(row => {
            const productName = row.querySelector('.product-name').textContent;
            const beginInput = row.querySelector('.begin-val');
            const newStockInput = row.querySelector('.new-stock-input');
            const endInput = row.querySelector('.end-input');

            const begin = parseFloat(beginInput.value) || 0;
            const newStock = parseFloat(newStockInput.value) || 0;
            const end = parseFloat(endInput.value) || 0;

            const availableStockIncludingNew = begin + newStock;

            if (end > availableStockIncludingNew) {
                hasLogicErrors = true;
                endInput.classList.add('invalid'); // Highlight invalid field
                errorMessages.push(`Ending stock for "${productName}" (${end}) is greater than available stock (${availableStockIncludingNew}).`);
            } else {
                endInput.classList.remove('invalid'); // Ensure no highlight if fixed
            }
        });

        if (hasLogicErrors) {
            Swal.fire({
                icon: 'error',
                title: 'Inventory Logic Errors Found!',
                html: `Please correct the following errors before finalizing the report:<br><ul>${errorMessages.map(msg => `<li>${msg}</li>`).join('')}</ul>`,
                confirmButtonText: 'Understood'
            });
            return; // Stop the finalization process
        }

        // If no logic errors, proceed with finalization
        try {
            const reportRef = db.collection('reports').doc(todayDateString);
            const cashOnHand = parseFloat(document.getElementById('cash-on-hand')?.value) || 0;
            const discountAmount = parseFloat(document.getElementById('discount-given')?.value) || 0; 
            await reportRef.update({ cashOnHand: cashOnHand, discountAmount: discountAmount, isFinalized: true }); 

            await Swal.fire({
                title: 'Report Finalized!',
                text: `The report for ${dayjs(todayDateString).format('MMMM D')} is now locked.`,
                icon: 'success',
                timer: 2000,
                showConfirmButton: false,
                allowOutsideClick: false
            });
        } catch (error) {
            console.error("Error finalizing report:", error);
            Swal.fire('Error', handleFirestoreError(error), 'error');
        }
    }


    // --- UI RENDERING & VIEW MANAGEMENT ---

    function updateNavTabs(activeTabId) {
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.classList.toggle('active', tab.getAttribute('aria-controls') === activeTabId);
            tab.setAttribute('aria-selected', tab.getAttribute('aria-controls') === activeTabId);
        });
    }

    function showView(viewId) {
        // Detach ALL old listeners to prevent memory leaks
        if (typeof reportListener === 'function') { reportListener(); reportListener = null; }
        if (typeof expensesListener === 'function') { expensesListener(); expensesListener = null; }
        dashboardListeners.forEach(unsubscribe => unsubscribe());
        dashboardListeners = [];

        document.querySelectorAll('.main-view').forEach(view => view.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        updateNavTabs(viewId);
        
        if (viewId === 'dashboard-view') {
            listenForDashboardData();
        } else if (viewId === 'expenses-view') {
            renderExpensesView(todayDateString);
        }
    }
    
    function showCurrentDayReport() {
        showInventory(todayDateString);
    }
    
    async function showInventory(dateString, options = {}) {
        showView('daily-report-view');
        try {
            await startDay(dateString);

            const isEditingPast = options.isEditingPast || false;
            document.getElementById('editing-past-banner').classList.toggle('hidden', !isEditingPast);

            const reportRef = db.collection('reports').doc(dateString);
            if (reportListener) reportListener();
            
            reportListener = reportRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const reportData = doc.data();
                    const isFinalized = reportData.isFinalized || false;
                    const isToday = dateString === todayDateString;
                    const isEditable = (isToday && !isFinalized) || isEditingPast;

                    renderInventoryTable(dateString, reportData, { isEditable, isFinalized, isEditingPast, isToday });
                    updateInventoryTable(reportData);
                } else {
                    document.getElementById('inventory-tbody').innerHTML = `<tr><td colspan="9" class="text-center p-4 text-red-600">Report not found!</td></tr>`;
                }
            }, (error) => {
                console.error("Error listening to report changes:", error);
                Swal.fire('Connection Error', handleFirestoreError(error), 'error');
            });
        } catch (error) {
            Swal.fire('Error', handleFirestoreError(error), 'error');
        }
    }

    function renderInventoryTable(dateString, report, options) {
        const { isEditable, isFinalized, isEditingPast, isToday } = options;
        const inventoryTbody = document.getElementById('inventory-tbody');
        document.getElementById('report-title').textContent = `Daily Report - ${dayjs(dateString).format('MMMM D, YYYY')}`;
            
        const groupedProducts = {};
        RICE_CATEGORIES.forEach(cat => groupedProducts[cat] = []);
        shopProducts.forEach(p => {
            if (!groupedProducts[p.category]) groupedProducts[p.category] = [];
            groupedProducts[p.category].push(p)
        });
            
        let tableHtml = '';
        RICE_CATEGORIES.forEach(cat => {
            const productsInCategory = groupedProducts[cat]?.sort((a, b) => a.name.localeCompare(b.name));
            if (productsInCategory && productsInCategory.length > 0) {
                const cleanCatClass = cat.replace(/\s+/g, '-');
                tableHtml += `<tr class="category-header category-header-${cleanCatClass}" data-category-id="${cat}">
                                <td colspan="9" class="font-bold uppercase text-lg">
                                    <div class="category-header-clickable" onclick="toggleCategoryRows('${cat}')">
                                        ${cat}
                                        <svg class="w-5 h-5 toggle-icon" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                </td>
                              </tr>`;
                
                // Add sub-header only if not '25 KG'
                // The main table header already serves this purpose for the first category.
                if (cat !== '25 KG') {
                    tableHtml += `
                    <tr class="sub-header no-print" data-category-child-of="${cat}">
                        <th>PRODUCT</th>
                        <th>BEGIN <br><button class="small-edit-btn mt-1 no-print" onclick="promptForCategoryThenEdit('begin', '${cat}')" aria-label="Edit all beginning stock in ${cat}">EDIT ALL</button></th>
                        <th>NEW STOCK</th>
                        <th>OPEN SACKS</th>
                        <th>ENDING</th>
                        <th>SOLD</th>
                        <th>SELLING PRICE (₱) <br><button class="small-edit-btn mt-1 no-print" onclick="openQuickProfitMarginModal('${cat}')" aria-label="Quick update prices in ${cat}">EDIT ALL</button></th>
                        <th>TOTAL SALES (₱)</th>
                        <th>PROFIT (₱)</th>
                    </tr>`;
                }

                productsInCategory.forEach(product => {
                    // Get profit margin and cost from the report or fallback to product defaults
                    const itemData = report.data[product.id] || {};
                    const effectiveProfitMargin = itemData.profitMargin !== undefined ? itemData.profitMargin : product.profitMargin;
                    const effectiveCost = itemData.cost !== undefined ? itemData.cost : product.cost;
                    const calculatedSellingPrice = effectiveCost + effectiveProfitMargin;

                    tableHtml += `<tr data-id="${product.id}" data-category="${product.category}" data-category-child-of="${cat}">
                        <td class="font-bold product-name">${product.name}</td>
                        <td><input type="number" class="begin-val" disabled /></td>
                        <td><input type="number" class="new-stock-input" ${!isEditable ? 'disabled' : ''} oninput="validateNumberInput(this); debouncedCalculate(this, '${dateString}'); checkRowCompletion(this.closest('tr'));"/></td>
                        <td class="!p-1">
                            ${product.category === '25 KG' ? `<div class="flex items-center gap-1"><input type="number" placeholder="Add" class="open-sacks-add-input flex-grow" ${!isEditable ? 'disabled' : ''} oninput="validateNumberInput(this);"/><button class="p-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs no-print" ${!isEditable ? 'disabled' : ''} onclick="submitOpenSack(this, '${product.id}', '${dateString}')" title="Add to Per Kilo">➔</button></div>` : `<span class="text-slate-400">-</span>`}
                        </td>
                        <td><input type="number" class="end-input" ${!isEditable ? 'disabled' : ''} oninput="validateNumberInput(this); debouncedCalculate(this, '${dateString}'); checkRowCompletion(this.closest('tr'));"/></td>
                        <td><input type="number" class="sold-val" disabled /></td>
                        <!-- Display calculated selling price, not an input -->
                        <td class="selling-price-display font-medium">₱${formatCurrency(calculatedSellingPrice)}</td> 
                        <td class="total-sales-val font-semibold" aria-live="polite"></td>
                        <td class="profit-val font-semibold text-green-600" aria-live="polite"></td>
                    </tr>`;
                });
                tableHtml += `<tr class="category-total-row" data-category-total="${cat}" data-category-child-of="${cat}"><td colspan="5" class="text-right p-3">Total for ${cat}</td><td class="category-total-sold p-3"></td><td></td><td class="category-total-sales p-3"></td><td class="category-total-profit p-3 text-green-600"></td></tr>`;
            }
        });
        
        tableHtml += `<tr class="grand-total-row"><td colspan="5" class="text-right p-4">OVERALL GRAND TOTAL</td><td id="overall-total-sold" class="p-4"></td><td></td><td id="overall-total-sales" class="p-4"></td><td id="overall-total-profit" class="p-4 text-green-400"></td></tr>`;
        // Updated cash reconciliation section with Discount Given
        tableHtml += `<tr><td colspan="9" class="p-2 bg-white"><div class="max-w-4xl mx-auto p-4 bg-white border-t-4 border-blue-500 rounded-b-lg shadow-inner"><div class="grid grid-cols-1 md:grid-cols-4 gap-x-6 gap-y-4 items-center"><div class="flex justify-between items-center p-2 rounded"><span class="text-sm font-medium text-slate-600">Expected Sales:</span><span id="expected-cash" class="font-bold text-slate-800 text-lg"></span></div><div class="flex justify-between items-center p-2 rounded"><label for="discount-given" class="text-sm font-medium text-slate-600 mr-2">Discount Given:</label><input type="number" id="discount-given" placeholder="0.00" class="w-32 text-right font-bold border-slate-300 p-1 rounded discount-input" oninput="validateNumberInput(this); calculateCashDifference();" ${!isEditable ? 'disabled' : ''} /></div><div class="flex justify-between items-center p-2 rounded"><label for="cash-on-hand" class="text-sm font-medium text-slate-600 mr-2">Cash on Hand:</label><input type="number" id="cash-on-hand" placeholder="0.00" class="w-32 text-right font-bold border-slate-300 p-1 rounded" oninput="validateNumberInput(this); calculateCashDifference();" ${!isEditable ? 'disabled' : ''} /></div><div class="flex justify-between items-center p-2 rounded"><span class="text-sm font-medium text-slate-600">Difference:</span><span id="cash-difference-display" class="font-bold text-lg">-</span></div></div></div></td></tr>`;
        
        let footerHtml = '';
        if(isEditingPast) {
            footerHtml = `<tr class="no-print"><td colspan="9" class="p-4 bg-white text-center"><button onclick="savePastReportChanges('${dateString}')" class="btn-primary">Save Changes</button></td></tr>`;
        } else if (isToday && !isFinalized) {
            footerHtml = `<tr class="no-print"><td colspan="9" class="p-4 bg-white text-center"><button onclick="showFinalizeModal()" class="btn-success">Finalize Today's Report</button></td></tr>`;
        } else {
            const message = isToday ? "Today's report is finalized and locked." : "This is a past report and is read-only.";
            footerHtml = `<tr class="no-print"><td colspan="9" class="p-4 bg-white text-center"><p class="font-medium text-slate-600">${message}</p></td></tr>`;
        }
        tableHtml += footerHtml;
        
        inventoryTbody.innerHTML = tableHtml;
    }

    function updateInventoryTable(report) {
        const reportData = report.data;
        shopProducts.forEach(product => {
            const row = document.querySelector(`#inventory-tbody tr[data-id="${product.id}"]`);
            if (!row) return;
            
            const data = reportData[product.id] || { begin: 0, newStock: 0, openedSacks: 0, end: 0, profitMargin: product.profitMargin, cost: product.cost };
            
            const effectiveProfitMargin = data.profitMargin !== undefined ? data.profitMargin : (product ? product.profitMargin : 0);
            const effectiveCost = data.cost !== undefined ? data.cost : (product ? product.cost : 0);
            const calculatedSellingPrice = effectiveCost + effectiveProfitMargin;
            
            updateInputValue(row, '.begin-val', data.begin);
            updateInputValue(row, '.new-stock-input', data.newStock);
            updateInputValue(row, '.end-input', data.end);
            
            // Display calculated selling price
            updateTextContent(row, '.selling-price-display', `₱${formatCurrency(calculatedSellingPrice)}`);

            const sold = (data.begin + data.newStock) - (data.openedSacks || 0) - data.end;
            const totalSales = Math.max(0, sold) * calculatedSellingPrice; 
            const profit = totalSales - (Math.max(0, sold) * effectiveCost); 

            updateInputValue(row, '.sold-val', sold);
            updateTextContent(row, '.total-sales-val', formatCurrency(totalSales));
            updateTextContent(row, '.profit-val', formatCurrency(profit));
            row.classList.toggle('row-has-sales', sold > 0);
            row.classList.toggle('row-logic-error', sold < 0);
            row.classList.toggle('row-negative-stock', data.end < 0);
            row.classList.toggle('row-low-stock', (product.minStock || 0) > 0 && data.end >= 0 && data.end <= product.minStock);
            
            checkRowCompletion(row); 
        });
        recalculateAndRenderAllTotals();
        const cashInput = document.getElementById('cash-on-hand');
        if (cashInput && report.cashOnHand != null && cashInput.value !== String(report.cashOnHand)) {
            cashInput.value = report.cashOnHand;
        }
        const discountInput = document.getElementById('discount-given');
        if (discountInput && report.discountAmount != null && discountInput.value !== String(report.discountAmount)) {
            discountInput.value = report.discountAmount;
        }
        calculateCashDifference();
    }
    
    function updateInputValue(row, selector, value) {
        const el = row.querySelector(selector);
        if (el && el.value != value && document.activeElement !== el) {
            el.value = value;
        }
    }

    function updateTextContent(row, selector, value) {
        const el = row.querySelector(selector);
        if (el && el.textContent != value) {
            el.textContent = value;
        }
    }
    

    // --- CALCULATIONS & EVENT HANDLERS ---

    /**
     * Checks if a row's required inputs (newStock, end) are filled and applies/removes .row-complete class.
     * @param {HTMLElement} row The table row element.
     */
    function checkRowCompletion(row) {
        if (!row || !row.dataset.id) return;

        const newStockInput = row.querySelector('.new-stock-input');
        const endInput = row.querySelector('.end-input');

        const isNewStockFilled = newStockInput && newStockInput.value.trim() !== '';
        const isEndFilled = endInput && endInput.value.trim() !== '';

        if (isNewStockFilled && isEndFilled) {
            row.classList.add('row-complete');
        } else {
            row.classList.remove('row-complete');
        }
    }

    function recalculateAndRenderAllTotals() {
        const categoryTotals = {};
        RICE_CATEGORIES.forEach(cat => categoryTotals[cat] = { sold: 0, sales: 0, profit: 0 });

        document.querySelectorAll('#inventory-tbody tr[data-id]').forEach(row => {
            const category = row.dataset.category;
            const sold = parseFloat(row.querySelector('.sold-val')?.value) || 0;
            const sales = parseFloat(row.querySelector('.total-sales-val')?.textContent) || 0;
            const profit = parseFloat(row.querySelector('.profit-val')?.textContent) || 0;

            if (categoryTotals[category]) {
                categoryTotals[category].sold += sold > 0 ? sold : 0;
                categoryTotals[category].sales += sales;
                categoryTotals[category].profit += profit;
            }
        });

        updateTotalsFromData(categoryTotals);
    }

    function updateTotalsFromData(categoryTotals) {
        let overallTotalSold = 0, overallTotalSales = 0, overallTotalProfit = 0;

        for(const cat in categoryTotals) {
            const totals = categoryTotals[cat];
            const totalRow = document.querySelector(`tr[data-category-total="${cat}"]`);
            if (totalRow) {
                updateTextContent(totalRow, '.category-total-sold', totals.sold);
                updateTextContent(totalRow, '.category-total-sales', `₱${formatCurrency(totals.sales)}`);
                updateTextContent(totalRow, '.category-total-profit', `₱${formatCurrency(totals.profit)}`);
            }
            overallTotalSold += totals.sold;
            overallTotalSales += totals.sales;
            overallTotalProfit += totals.profit;
        }

        updateTextContent(document, '#overall-total-sold', overallTotalSold);
        updateTextContent(document, '#overall-total-sales', `₱${formatCurrency(overallTotalSales)}`);
        updateTextContent(document, '#overall-total-profit', `₱${formatCurrency(overallTotalProfit)}`);
        document.getElementById('expected-cash').textContent = `₱${formatCurrency(overallTotalSales)}`;
        calculateCashDifference();
    }

    function calculateCashDifference() {
        const totalSalesEl = document.getElementById('overall-total-sales');
        const cashInput = document.getElementById('cash-on-hand');
        const discountInput = document.getElementById('discount-given');
        const differenceDisplay = document.getElementById('cash-difference-display');
        
        if (!totalSalesEl || !cashInput || !discountInput || !differenceDisplay) return;

        const totalSales = parseFloat(totalSalesEl.textContent.replace(/[₱,]/g, '')) || 0;
        const discountAmount = parseFloat(discountInput.value) || 0;
        
        if (cashInput.value.trim() === '' && discountInput.value.trim() === '') {
            differenceDisplay.textContent = '-';
            differenceDisplay.className = 'font-bold text-lg';
            return;
        }

        const cashOnHand = parseFloat(cashInput.value) || 0;
        const adjustedTotalSales = totalSales - discountAmount; 
        const difference = cashOnHand - adjustedTotalSales;
        differenceDisplay.className = 'font-bold text-lg';
        
        if (difference < 0) {
            differenceDisplay.textContent = `(₱${formatCurrency(Math.abs(difference))})`;
            differenceDisplay.classList.add('cash-short');
        } else if (difference > 0) {
            differenceDisplay.textContent = `+₱${formatCurrency(difference)}`;
            differenceDisplay.classList.add('cash-over');
        } else {
            differenceDisplay.textContent = 'Balanced';
            differenceDisplay.classList.add('cash-balanced');
        }
    }

    function debouncedCalculate(inputElement, dateString) {
        clearTimeout(calculationTimeout);
        calculationTimeout = setTimeout(() => calculate(inputElement, dateString), 400);
    }

    async function calculate(inputElement, dateString) {
        // First, check if the input itself is invalid (NaN or negative)
        if (inputElement.classList.contains('invalid')) {
            // Already invalid due to direct number validation, just return and let the user correct it
            return;
        }

        const row = inputElement.closest('tr');
        if (!row || !row.dataset.id) return;
        const productId = row.dataset.id;

        const begin = parseFloat(row.querySelector('.begin-val').value) || 0;
        const newStock = parseFloat(row.querySelector('.new-stock-input').value) || 0;
        const end = parseFloat(row.querySelector('.end-input').value) || 0;

        const availableStockIncludingNew = begin + newStock;

        // --- NEW: Error handling for illogical stock values ---
        if (end > availableStockIncludingNew) {
            Swal.fire({
                icon: 'error',
                title: 'Inventory Logic Error',
                html: `For product: <strong>${row.querySelector('.product-name').textContent}</strong><br>
                       Ending stock (${end}) cannot be greater than the sum of Beginning stock (${begin}) and New Stock (${newStock}).<br>
                       Please correct the "Ending" value.`,
                confirmButtonText: 'Understood'
            });
            inputElement.classList.add('invalid'); // Highlight the invalid input
            // Do NOT save to Firestore if there's a logic error
            recalculateAndRenderAllTotals(); // Still update totals based on current (potentially incorrect) display
            return; 
        } else {
            inputElement.classList.remove('invalid'); // Remove highlight if corrected
            // Proceed to save only if valid
            await saveInventoryData(dateString, productId, { newStock, end });
        }
    }
    
    async function submitOpenSack(buttonElement, productId, dateString) {
        const parentDiv = buttonElement.parentElement;
        const addSacksInput = parentDiv.querySelector('.open-sacks-add-input');
        const sacksToAdd = parseInt(addSacksInput.value) || 0;

        if (sacksToAdd <= 0) {
            return Toast.fire({ icon: 'info', title: 'Enter a positive number.' });
        }

        const sourceProduct = shopProducts.find(p => p.id === productId);
        if (!sourceProduct || sourceProduct.category !== '25 KG') return;

        const targetProduct = shopProducts.find(p => p.name === sourceProduct.name && p.category === 'Per Kilo');
        if (!targetProduct) {
            return Swal.fire('Error', `No corresponding "Per Kilo" product found for ${sourceProduct.name}. Please add it in Settings.`, 'error');
        }
        
        const { isConfirmed } = await Swal.fire({
            title: 'Confirm Transfer',
            html: `Are you sure you want to open <b>${sacksToAdd}</b> sack(s) of <b>${sourceProduct.name}</b>?<br><br>This will add <b>${sacksToAdd * 25} kg</b> to the "Per Kilo" inventory.`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3b82f6',
            confirmButtonText: 'Yes, transfer it!'
        });

        if (!isConfirmed) return;

        try {
            const reportRef = db.collection('reports').doc(dateString);
            await db.runTransaction(async (transaction) => {
                const reportDoc = await transaction.get(reportRef);
                if (!reportDoc.exists) throw "Report not found!";
                
                const report = reportDoc.data();
                const sourceData = report.data[sourceProduct.id] || { end: 0 };
                const availableStock = (sourceData.begin + sourceData.newStock) - (sourceData.openedSacks || 0) - sourceData.end;

                if (availableStock < sacksToAdd) {
                    throw `Insufficient stock for ${sourceProduct.name}. Only ${availableStock} available to open.`;
                }

                const kilosToAdd = sacksToAdd * 25;
                
                const updatePayload = {};
                updatePayload[`data.${sourceProduct.id}.openedSacks`] = firebase.firestore.FieldValue.increment(sacksToAdd);
                updatePayload[`data.${targetProduct.id}.begin`] = firebase.firestore.FieldValue.increment(kilosToAdd);
                updatePayload[`data.${targetProduct.id}.end`] = firebase.firestore.FieldValue.increment(kilosToAdd);
                transaction.update(reportRef, updatePayload);
                addSacksInput.value = '';
            });
            Toast.fire({ icon: 'success', title: 'Stock transferred!' });
        } catch (error) {
            const errorMessage = typeof error === 'string' ? error : handleFirestoreError(error);
            Swal.fire('Error', errorMessage, 'error');
        }
    }
    
    async function getPassword() {
        const securityDoc = await db.collection('settings').doc('security').get();
        const storedPasswordHash = securityDoc.exists ? securityDoc.data().passwordHash : null;
        if (!storedPasswordHash) return { success: true }; 
        const { value: password } = await Swal.fire({
            title: 'Enter Password to Proceed',
            input: 'password',
            inputPlaceholder: 'Enter your password',
            inputAttributes: { autocapitalize: 'off', autocorrect: 'off' },
            showCancelButton: true
        });
        if (password && hashPassword(password) === storedPasswordHash) {
            return { success: true, password: password }; 
        } else if (password) {
            Swal.fire('Incorrect Password', '', 'error');
            return { success: false };
        }
        return { success: false };
    }
    
    async function editPastReport(dateString) {
        const password = await getPassword();
        if (!password.success) return;

        const { isConfirmed } = await Swal.fire({
            title: 'Warning: Editing Past Report',
            html: `You are about to edit the report for <strong>${dayjs(dateString).format('MMMM D, YYYY')}</strong>. <br><br>Changes to "Ending" stock will <strong>NOT</strong> automatically update the "Beginning" stock of future days.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#f59e0b',
            confirmButtonText: 'I understand, proceed'
        });

        if (isConfirmed) {
            showInventory(dateString, { isEditingPast: true });
        }
    }

    async function savePastReportChanges(dateString) {
        const cashOnHand = parseFloat(document.getElementById('cash-on-hand')?.value) || 0;
        const discountAmount = parseFloat(document.getElementById('discount-given')?.value) || 0;
        try {
            await db.collection('reports').doc(dateString).update({ cashOnHand, discountAmount });
            Toast.fire({ icon: 'success', title: 'Changes saved successfully!' });
            showHistory();
        } catch (error) {
            Swal.fire('Error', handleFirestoreError(error), 'error');
        }
    }

    async function showFinalizeModal() {
        // Step 1: Perform global validation check before proceeding
        let hasLogicErrors = false;
        const errorMessages = [];

        document.querySelectorAll('#inventory-tbody tr[data-id]').forEach(row => {
            const productName = row.querySelector('.product-name').textContent;
            const beginInput = row.querySelector('.begin-val');
            const newStockInput = row.querySelector('.new-stock-input');
            const endInput = row.querySelector('.end-input');

            const begin = parseFloat(beginInput.value) || 0;
            const newStock = parseFloat(newStockInput.value) || 0;
            const end = parseFloat(endInput.value) || 0;

            const availableStockIncludingNew = begin + newStock;

            if (end > availableStockIncludingNew) {
                hasLogicErrors = true;
                endInput.classList.add('invalid'); // Highlight invalid field
                errorMessages.push(`Ending stock for "${productName}" (${end}) is greater than available stock (${availableStockIncludingNew}).`);
            } else {
                endInput.classList.remove('invalid'); // Ensure no highlight if fixed
            }
        });

        if (hasLogicErrors) {
            Swal.fire({
                icon: 'error',
                title: 'Inventory Logic Errors Found!',
                html: `Please correct the following errors before finalizing the report:<br><ul>${errorMessages.map(msg => `<li>${msg}</li>`).join('')}</ul>`,
                confirmButtonText: 'Understood'
            });
            return; // Stop the finalization process
        }

        // If no logic errors, proceed with original finalization logic
        const { isConfirmed } = await Swal.fire({
            title: `Finalize Report for Today?`,
            text: `This will lock today's report from further edits. You can still make corrections later from the History page (password required).`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#10b981',
            confirmButtonText: 'Yes, Finalize It!',
            showLoaderOnConfirm: true,
            preConfirm: () => finalizeReport().catch(err => Swal.showValidationMessage(`Request failed: ${err}`)), // This preConfirm is now internal to original finalizeReport
            allowOutsideClick: () => !Swal.isLoading()
        });

        if (isConfirmed) {
            // Only proceed if the internal logic check in preConfirm also passes
            // The preConfirm returns a promise that resolves on success or rejects on failure
            // If it rejects, the Swal.showValidationMessage is displayed.
            // If it resolves, the main `finalizeReport` function is considered successful.
        }
    }

    // --- HISTORY VIEW FUNCTIONS ---

    async function showHistory() {
        showView('history-view');
        const historyList = document.getElementById('history-list');
        historyList.innerHTML = '<div class="p-4 text-center"><div class="loader"></div></div>';
        try {
            const reportsSnapshot = await db.collection('reports').orderBy('date', 'desc').get();
            renderHistoryList(reportsSnapshot.docs);
        } catch (error) {
             console.error("Error loading history:", error);
             historyList.innerHTML = `<p class="p-4 text-center text-red-500">${handleFirestoreError(error)}</p>`;
        }
    }
    
    function renderHistoryList(reportDocs) {
        const listEl = document.getElementById('history-list');
        if(reportDocs.length === 0) {
            listEl.innerHTML = '<p class="text-center text-slate-500 p-8">No saved reports found.</p>';
            return;
        }
        listEl.innerHTML = reportDocs.map(doc => {
            const report = doc.data();
            const dateString = report.date;
            const isFinalized = report.isFinalized;
            return `
            <div class="p-4 hover:bg-slate-50 transition-colors history-item" data-date="${dateString}">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div class="flex items-center gap-3">
                        ${isFinalized ? '<svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>' : '<svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 102 0V6zm-1 9a1 1 0 110-2 1 1 0 010 2z" clip-rule="evenodd"></path></svg>'}
                        <div>
                            <div class="font-medium">${dayjs(dateString).format('dddd, MMMM D, YYYY')}</div>
                            <div class="text-sm text-slate-500">${isFinalized ? 'Finalized' : 'In Progress'}</div>
                        </div>
                    </div>
                    <div class="flex gap-4 mt-2 sm:mt-0">
                        <button onclick="showInventory('${dateString}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">View</button>
                        <button onclick="editPastReport('${dateString}')" class="text-amber-600 hover:text-amber-800 text-sm font-medium">Edit</button>
                        <button onclick="deleteReport('${dateString}')" class="text-red-600 hover:text-red-800 text-sm font-medium no-print">Delete</button>
                    </div>
                </div>
            </div>`
        }).join('');
    }
    
    async function deleteReport(dateString) {
        if (dateString === todayDateString) {
            return Swal.fire('Action Denied', 'You cannot delete the active report for today.', 'error');
        }
        const password = await getPassword();
        if(!password.success) return;

        const { isConfirmed } = await Swal.fire({ 
            title: 'Delete Report?', 
            text: `This will permanently delete the report for ${dayjs(dateString).format('MMMM D, YYYY')}. This cannot be undone.`, 
            icon: 'warning', showCancelButton: true, confirmButtonText: 'Yes, delete it!' 
        });
        if (isConfirmed) {
            try {
                await db.collection('reports').doc(dateString).delete();
                await db.collection('expenses').where('date', '==', dateString).get().then(snap => {
                    const batch = db.batch();
                    snap.forEach(doc => batch.delete(doc.ref));
                    return batch.commit();
                });
                Toast.fire({ icon: 'success', title: 'Report deleted!' });
                showHistory();
            } catch (error) {
                Swal.fire('Error', handleFirestoreError(error), 'error');
            }
        }
    }

    // --- DASHBOARD, EXPENSES, ANALYTICS ---
    
    function listenForDashboardData() {
        renderDashboardPlaceholders();

        const todayReportRef = db.collection('reports').doc(todayDateString);
        const todayReportListener = todayReportRef.onSnapshot(doc => {
            const reportData = doc.exists ? doc.data() : null;
            updateDashboardLowStock(reportData);
            updateDashboardMonthlyProfit();
        }, (error) => console.error("Dashboard listener error (today's report):", error));

        const todayExpensesQuery = db.collection('expenses').where('date', '==', todayDateString);
        const todayExpensesListener = todayExpensesQuery.onSnapshot(() => {
            updateDashboardMonthlyProfit();
        }, (error) => console.error("Dashboard listener error (today's expenses):", error));

        const yesterday = dayjs(todayDateString).subtract(1, 'day').format('YYYY-MM-DD');
        const yesterdayReportRef = db.collection('reports').doc(yesterday);
        const yesterdayReportListener = yesterdayReportRef.onSnapshot(async (doc) => {
            const reportData = doc.exists ? doc.data() : null;
            const summary = calculateDailySummaryFromData(reportData); 
            const expenses = await getExpensesForDate(yesterday);
            updateDashboardCards(summary.totalSales, expenses, summary.totalProfit);
        }, (error) => console.error("Dashboard listener error (yesterday's report):", error));

        dashboardListeners.push(todayReportListener, todayExpensesListener, yesterdayReportListener);
    }
    
    function calculateDailySummaryFromData(report) {
        let totalSales = 0, totalProfit = 0;
        if (report && report.data) {
            for (const productId in report.data) {
                const item = report.data[productId];
                const product = shopProducts.find(p => p.id === productId); 
                const effectiveCost = item.cost !== undefined ? item.cost : (product ? product.cost : 0);

                const sold = (item.begin + item.newStock) - (item.openedSacks || 0) - item.end;
                if (sold > 0) {
                    const effectiveProfitMargin = item.profitMargin !== undefined ? item.profitMargin : (product ? product.profitMargin : 0);
                    const calculatedSellingPrice = effectiveCost + effectiveProfitMargin;
                    
                    const sales = sold * calculatedSellingPrice;
                    const profit = sales - (sold * effectiveCost);
                    totalSales += sales;
                    totalProfit += profit;
                }
            }
        }
        const discount = report?.discountAmount || 0;
        
        return { totalSales: totalSales - discount, totalProfit: totalProfit - discount };
    }

    function renderDashboardPlaceholders() {
        const yesterday = dayjs(todayDateString).subtract(1, 'day').format('YYYY-MM-DD');
        document.getElementById('dashboard-date').textContent = `Showing final numbers for yesterday, ${dayjs(yesterday).format('MMMM D, YYYY')}`;
        document.getElementById('dashboard-total-sales').outerHTML = `<div id="dashboard-total-sales" class="animate-pulse"><div class="h-8 bg-slate-200 rounded w-32 mt-1"></div></div>`;
        document.getElementById('dashboard-total-expenses').outerHTML = `<div id="dashboard-total-expenses" class="animate-pulse"><div class="h-8 bg-slate-200 rounded w-24 mt-1"></div></div>`;
        document.getElementById('dashboard-total-profit').outerHTML = `<div id="dashboard-total-profit" class="animate-pulse"><div class="h-8 bg-slate-200 rounded w-28 mt-1"></div></div>`;
        document.getElementById('dashboard-monthly-net-profit').outerHTML = `<div id="dashboard-monthly-net-profit" class="animate-pulse"><div class="h-8 bg-slate-200 rounded w-36 mt-1"></div></div>`;
    }

    function updateDashboardCards(totalSales, totalExpenses, totalProfit) {
        document.getElementById('dashboard-total-sales').outerHTML = `<p id="dashboard-total-sales" class="text-3xl font-bold text-slate-800">₱${formatCurrency(totalSales)}</p>`;
        document.getElementById('dashboard-total-expenses').outerHTML = `<p id="dashboard-total-expenses" class="text-3xl font-bold text-slate-800">₱${formatCurrency(totalExpenses)}</p>`;
        document.getElementById('dashboard-total-profit').outerHTML = `<p id="dashboard-total-profit" class="text-3xl font-bold text-green-700">₱${formatCurrency(totalProfit)}</p>`;
    }

    async function updateDashboardMonthlyProfit() {
        const { monthlyNetProfit } = await getMonthlySummary(todayDateString);
        document.getElementById('dashboard-monthly-net-profit').outerHTML = `<p id="dashboard-monthly-net-profit" class="text-3xl font-bold text-teal-700">₱${formatCurrency(monthlyNetProfit)}</p>`;
    }
    
    function updateDashboardLowStock(report) {
        const lowStockList = document.getElementById('low-stock-list');
        let lowStockItems = [];
        if (report && report.data) {
             lowStockItems = shopProducts
                .map(p => ({ ...p, stock: report.data[p.id]?.end }))
                .filter(p => (p.minStock || 0) > 0 && p.stock !== undefined && p.stock <= p.minStock);
        }

        if (lowStockItems.length > 0) {
            lowStockList.innerHTML = lowStockItems.map(item => `<div class="flex justify-between items-center text-sm p-2 bg-white rounded"><span class="font-semibold">${item.name} <span class="font-normal text-slate-500">(${item.category})</span></span><span class="font-semibold text-red-600">${item.stock} left (Min: ${item.minStock})</span></div>`).join('');
        } else {
            lowStockList.innerHTML = '<p class="text-slate-500 text-center py-4">All stock levels are good!</p>';
        }
    }

    function showAnalyticsSubTab(contentId) { document.querySelectorAll('#settings-analytics-content .analytics-tab-content').forEach(content => content.classList.add('hidden')); document.querySelectorAll('#settings-analytics-content .analytics-tab').forEach(tab => tab.classList.remove('active')); const selectedContent = document.getElementById(contentId); if (selectedContent) { selectedContent.classList.remove('hidden'); const correspondingTab = document.querySelector(`#settings-analytics-content [aria-controls="${contentId}"]`); if (correspondingTab) { correspondingTab.classList.add('active'); } } if (contentId === 'analytics-financial-summary-content') { loadFinancialSummary(); } else { loadAnalytics(); } }
    function toggleAnalyticsDateInputs() { const mode = document.getElementById('analytics-mode-select').value; document.getElementById('daily-date-input').classList.toggle('hidden', mode !== 'daily'); document.getElementById('range-date-inputs').classList.toggle('hidden', mode !== 'range'); }
    async function loadAnalytics() { 
        const mode = document.getElementById('analytics-mode-select').value; 
        let startDate, endDate; 
        if (mode === 'daily') { startDate = endDate = document.getElementById('analytics-single-date').value; } else { startDate = document.getElementById('analytics-from-date').value; endDate = document.getElementById('analytics-to-date').value; } 
        if (!startDate || !endDate || dayjs(startDate).isAfter(dayjs(endDate))) return; 
        
        const reportsSnapshot = await db.collection('reports').where('date', '>=', startDate).where('date', '<=', endDate).get(); 
        let totalSales = 0, totalProfit = 0, numDays = reportsSnapshot.size; 
        const productPerformance = {}; 
        shopProducts.forEach(p => productPerformance[p.id] = { sold: 0, sales: 0, profit: 0, name: p.name, category: p.category }); 
        
        reportsSnapshot.forEach(doc => { 
            const report = doc.data(); 
            const discount = report?.discountAmount || 0; 
            
            for (const productId in report.data) { 
                const item = report.data[productId]; 
                const product = shopProducts.find(p => p.id === productId);
                const effectiveCost = item.cost !== undefined ? item.cost : (product ? product.cost : 0);

                const sold = (item.begin + item.newStock) - (item.openedSacks || 0) - item.end; 
                if (sold > 0) { 
                    const effectiveProfitMargin = item.profitMargin !== undefined ? item.profitMargin : (product ? product.profitMargin : 0);
                    const calculatedSellingPrice = effectiveCost + effectiveProfitMargin;

                    const sales = sold * calculatedSellingPrice; 
                    const profit = sales - (sold * effectiveCost); 
                    totalSales += sales; 
                    totalProfit += profit; 
                    if (productPerformance[productId]) { 
                        productPerformance[productId].sold += sold; 
                        productPerformance[productId].sales += sales; 
                        productPerformance[productId].profit += profit; 
                    } 
                } 
            } 
            totalSales -= discount; 
            totalProfit -= discount; 
        }); 
        numDays = numDays || 1; 
        document.getElementById('analytics-total-sales').textContent = `₱${formatCurrency(totalSales)}`; 
        document.getElementById('analytics-total-profit').textContent = `₱${formatCurrency(totalProfit)}`; 
        document.getElementById('analytics-avg-sales').textContent = `₱${formatCurrency(totalSales / numDays)}`; 
        document.getElementById('analytics-avg-margin').textContent = `${formatCurrency((totalSales > 0 ? (totalProfit / totalSales) * 100 : 0))}%`; 
        renderTopPerformingProducts(productPerformance); 
    }
    function renderTopPerformingProducts(productPerformance) { const container = document.getElementById('analytics-top-products'); const topProducts = Object.values(productPerformance).filter(p => p.sales > 0).sort((a, b) => b.sales - a.sales).slice(0, 10); if (topProducts.length === 0) { container.innerHTML = '<p class="text-center text-slate-500 py-4">No sales data for this period.</p>'; return; } container.innerHTML = topProducts.map((p, i) => `<div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg"><div><div class="font-medium">${p.name} <span class="text-sm text-slate-400">(${p.category})</span></div><div class="text-sm text-slate-500">${p.sold} sold</div></div><div class="text-right"><div class="font-semibold">₱${formatCurrency(p.sales)}</div><div class="text-sm text-green-600">₱${formatCurrency(p.profit)} profit</div></div></div>`).join(''); }
    async function loadFinancialSummary() { 
        const monthValue = document.getElementById('financial-month-select').value; 
        if (!monthValue) return; 
        const startDate = dayjs(monthValue).startOf('month').format('YYYY-MM-DD'); 
        const endDate = dayjs(monthValue).endOf('month').format('YYYY-MM-DD'); 
        let totalSales = 0, totalCOGS = 0, totalExpenses = 0, totalNewStockCost = 0; 
        const dailyFlow = {}; 
        
        const reportsSnapshot = await db.collection('reports').where('date', '>=', startDate).where('date', '<=', endDate).get(); 
        const expensesSnapshot = await db.collection('expenses').where('date', '>=', startDate).where('date', '<=', endDate).get(); 
        
        reportsSnapshot.forEach(doc => { 
            const report = doc.data(); 
            const discount = report?.discountAmount || 0; 
            let dailyNetProfit = 0; 
            let dailyNewStockCost = 0; 
            
            for (const productId in report.data) { 
                const item = report.data[productId]; 
                const product = shopProducts.find(p => p.id === productId); 
                const effectiveCost = item.cost !== undefined ? item.cost : (product ? product.cost : 0);

                const sold = (item.begin + item.newStock) - (item.openedSacks || 0) - item.end; 
                if (sold > 0) { 
                    const effectiveProfitMargin = item.profitMargin !== undefined ? item.profitMargin : (product ? product.profitMargin : 0);
                    const calculatedSellingPrice = effectiveCost + effectiveProfitMargin;

                    const sales = sold * calculatedSellingPrice; 
                    const cogs = sold * effectiveCost; 
                    totalSales += sales; 
                    totalCOGS += cogs; 
                    dailyNetProfit += (sales - cogs); 
                } 
                if (item.newStock > 0) { 
                    const newStockCost = item.newStock * effectiveCost; 
                    totalNewStockCost += newStockCost; 
                    dailyNewStockCost += newStockCost; 
                } 
            } 
            dailyNetProfit -= discount; 
            totalSales -= discount; 

            dailyFlow[report.date] = { profit: dailyNetProfit, reinvested: dailyNewStockCost }; 
        }); 
        expensesSnapshot.forEach(doc => { 
            const expense = doc.data(); 
            totalExpenses += expense.amount; 
            if (dailyFlow[expense.date]) { 
                dailyFlow[expense.date].profit -= expense.amount; 
            } 
        }); 
        const grossProfit = totalSales - totalCOGS; 
        const netProfit = grossProfit - totalExpenses; 
        document.getElementById('fs-total-sales').textContent = `₱${formatCurrency(totalSales)}`; 
        document.getElementById('fs-total-cogs').textContent = `₱${formatCurrency(totalCOGS)}`; 
        document.getElementById('fs-gross-profit').textContent = `₱${formatCurrency(grossProfit)}`; 
        document.getElementById('fs-total-expenses').textContent = `₱${formatCurrency(totalExpenses)}`; 
        document.getElementById('fs-new-stock-cost').textContent = `₱${formatCurrency(totalNewStockCost)}`; 
        document.getElementById('fs-net-profit').textContent = `₱${formatCurrency(netProfit)}`; 
        renderMoneyFlowChart(dailyFlow); 
    }
    function renderMoneyFlowChart(data) { if (moneyFlowChartInstance) moneyFlowChartInstance.destroy(); const ctx = document.getElementById('moneyFlowChart').getContext('2d'); const sortedDates = Object.keys(data).sort(); const labels = sortedDates.map(date => dayjs(date).format('MMM D')); const profitData = sortedDates.map(date => data[date].profit); const reinvestedData = sortedDates.map(date => data[date].reinvested); moneyFlowChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Net Profit', data: profitData, backgroundColor: 'rgba(16, 185, 129, 0.7)', }, { label: 'Capital Reinvested', data: reinvestedData, backgroundColor: 'rgba(59, 130, 246, 0.7)', }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { callback: value => `₱${value.toLocaleString()}` } } }, plugins: { tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ₱${formatCurrency(c.raw)}` } } } } }); }
    async function renderExpensesView(dateString) { document.getElementById('expenses-title').textContent = `Expenses for ${dayjs(dateString).format('MMMM D, YYYY')}`; document.getElementById('expense-form-title').textContent = `Add Expense for Today`; clearExpenseForm(); const container = document.getElementById('expense-list-container'); container.innerHTML = '<div class="loader"></div>'; const query = db.collection('expenses').where('date', '==', dateString); if (typeof expensesListener === 'function') expensesListener(); expensesListener = query.onSnapshot(snapshot => { const expenses = snapshot.docs.map(doc => doc.data()); if (expenses.length === 0) { container.innerHTML = '<p class="text-center text-slate-500 py-8">No expenses recorded for today.</p>'; } else { container.innerHTML = expenses.map(expense => `<div class="flex justify-between items-center p-3 bg-white rounded-lg border border-slate-200"><div><p class="font-medium">${expense.description}</p><p class="text-sm text-slate-500">₱${formatCurrency(expense.amount)}</p></div><div class="no-print"><button onclick="editExpense('${expense.id}')" class="text-xs text-blue-600 mr-2 hover:underline">Edit</button><button onclick="deleteExpense('${expense.id}')" class="text-xs text-red-600 hover:underline">Delete</button></div></div>`).join(''); } const totalExpenses = expenses.reduce((acc, expense) => acc + expense.amount, 0); document.getElementById('total-expenses-display').textContent = `₱${formatCurrency(totalExpenses)}`; }, error => { console.error("Error fetching expenses: ", error); container.innerHTML = `<p class="text-center text-red-500 py-8">${handleFirestoreError(error)}</p>`; }); }
    async function saveExpense() { const saveBtn = document.getElementById('save-expense-btn'); const descriptionInput = document.getElementById('expense-description'); const amountInput = document.getElementById('expense-amount'); const expenseId = document.getElementById('expense-id').value; const description = descriptionInput.value.trim(); const amount = parseFloat(amountInput.value); if (!description || isNaN(amount) || amount <= 0) { Toast.fire({ icon: 'error', title: 'Invalid description or amount.' }); return; } toggleButtonLoading(saveBtn, true); try { const docId = expenseId || 'exp_' + Date.now(); const expenseData = { id: docId, description, amount, date: todayDateString }; await db.collection('expenses').doc(docId).set(expenseData); Toast.fire({ icon: 'success', title: expenseId ? 'Expense updated!' : 'Expense added!' }); clearExpenseForm(); } catch (error) { Toast.fire({ icon: 'error', title: handleFirestoreError(error) }); } finally { toggleButtonLoading(saveBtn, false); } }
    function clearExpenseForm() { document.getElementById('expense-id').value = ''; document.getElementById('expense-description').value = ''; document.getElementById('expense-amount').value = ''; document.getElementById('expense-form-title').textContent = `Add Expense for Today`; document.getElementById('save-expense-btn').textContent = 'Save Expense'; }
    async function editExpense(id) { try { const expense = (await db.collection('expenses').doc(id).get()).data(); if (expense) { document.getElementById('expense-id').value = expense.id; document.getElementById('expense-description').value = expense.description; document.getElementById('expense-amount').value = expense.amount; document.getElementById('expense-form-title').textContent = 'Edit Expense'; document.getElementById('save-expense-btn').textContent = 'Update Expense'; } } catch (error) { Toast.fire({ icon: 'error', title: handleFirestoreError(error) }); } }
    async function deleteExpense(expenseId) { const { isConfirmed } = await Swal.fire({ title: 'Delete Expense?', icon: 'warning', showCancelButton: true }); if (isConfirmed) { try { await db.collection('expenses').doc(expenseId).delete(); Toast.fire({ icon: 'success', title: 'Expense deleted!' }); } catch (error) { Toast.fire({ icon: 'error', title: handleFirestoreError(error) }); } } }
    
    // --- SETTINGS PANEL FUNCTIONS ---
    
    function showSettingsTab(contentId) { 
        document.querySelectorAll('.settings-tab-content').forEach(c => c.classList.add('hidden')); 
        document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active')); 
        document.getElementById(contentId).classList.remove('hidden'); 
        document.querySelector(`[aria-controls="${contentId}"]`).classList.add('active'); 
        
        if (contentId === 'settings-analytics-content') {
            showAnalyticsSubTab('analytics-overview-content');
        } else if (contentId === 'settings-performance-content') {
            renderPerformanceBreakdown();
        } else if (contentId === 'settings-profit-margin-content') { 
            renderProfitMarginManagement();
        }
    }

    function openSettingsPanel() { document.getElementById('settings-panel').classList.add('open'); }
    function closeSettingsPanel() { document.getElementById('settings-panel').classList.remove('open'); }
    async function openSettingsWithPassword() { 
        const password = await getPassword(); 
        if (password.success) {
            openSettingsPanel();
        }
    }

    // NEW: Function to open profit margin settings directly (without password)
    function openQuickProfitMarginModal(preselectCategory = null) {
        document.getElementById('quick-profit-modal-overlay').classList.add('open');
        const categorySelect = document.getElementById('quick-profit-category-select');
        if (preselectCategory && RICE_CATEGORIES.includes(preselectCategory)) {
            categorySelect.value = preselectCategory;
            renderQuickProfitMarginProducts(preselectCategory);
        } else {
            categorySelect.value = ''; // Reset category selection
            document.getElementById('quick-profit-products-container').innerHTML = '<p class="text-center text-slate-500">Select a category to view products.</p>';
        }
    }

    function closeQuickProfitMarginModal() {
        document.getElementById('quick-profit-modal-overlay').classList.remove('open');
    }

    // NEW: Helper to update selling price display in modals dynamically
    function updateModalSellingPrice(productId, isQuickModal = false) {
        // Correctly target inputs based on whether it's the quick modal or main settings modal
        const prefix = isQuickModal ? 'quick-' : '';
        const costInput = document.getElementById(`${prefix}cost-${productId}`);
        const profitInput = document.getElementById(`${prefix}profit-margin-${productId}`);
        const sellingPriceSpan = document.getElementById(`${prefix}selling-price-${productId}`);

        if (costInput && profitInput && sellingPriceSpan) {
            const cost = parseFloat(costInput.value) || 0;
            const profit = parseFloat(profitInput.value) || 0;
            const calculatedSellingPrice = cost + profit;
            sellingPriceSpan.textContent = formatCurrency(calculatedSellingPrice);
        }
    }


    // NEW: Render products in the quick profit margin modal (IMPROVED LAYOUT)
    async function renderQuickProfitMarginProducts(category) {
        const container = document.getElementById('quick-profit-products-container');
        container.innerHTML = '<div class="loader"></div>';
        await loadProducts(); // Ensure products are up-to-date

        if (!category) {
            container.innerHTML = '<p class="text-center text-slate-500">Select a category to view products.</p>';
            return;
        }

        const productsInCategory = shopProducts
            .filter(p => p.category === category)
            .sort((a, b) => a.name.localeCompare(b.name));

        if (productsInCategory.length === 0) {
            container.innerHTML = `<p class="text-center text-slate-500 py-4">No products found in ${category}.</p>`;
            return;
        }

        let html = '<div class="space-y-3">'; // Consistent spacing between product rows
        productsInCategory.forEach(p => {
            const currentSellingPrice = (p.cost || 0) + (p.profitMargin || 0);
            html += `
            <div class="grid grid-cols-1 md:grid-cols-5 gap-2 items-center bg-white p-3 rounded shadow-sm border border-slate-200">
                <div class="font-medium text-slate-800 md:col-span-1">${p.name}</div>
                <div class="flex items-center gap-1 md:col-span-1">
                    <label for="quick-cost-${p.id}" class="text-sm text-slate-600">Cost:</label>
                    <input type="number" id="quick-cost-${p.id}" data-product-id="${p.id}" 
                        value="${formatCurrency(p.cost || 0)}" 
                        class="cost-input w-20 text-right text-sm" 
                        step="0.01" oninput="validateNumberInput(this); updateModalSellingPrice('${p.id}', true);">
                </div>
                <div class="flex items-center gap-1 md:col-span-1">
                    <label for="quick-profit-margin-${p.id}" class="text-sm text-slate-600">Profit:</label>
                    <input type="number" id="quick-profit-margin-${p.id}" data-product-id="${p.id}" 
                        value="${formatCurrency(p.profitMargin || 0)}" 
                        class="profit-margin-input w-20 text-right text-sm" 
                        step="0.01" oninput="validateNumberInput(this); updateModalSellingPrice('${p.id}', true);">
                </div>
                <div class="font-semibold text-blue-600 text-right md:col-span-2">Sell: ₱<span id="quick-selling-price-${p.id}">${formatCurrency(currentSellingPrice)}</span></div>
            </div>`;
        });
        html += '</div>';
        container.innerHTML = html;
    }

    // --- UPDATED FUNCTION ---
    // NEW: Save profit margins and costs from the quick access modal
    async function saveQuickProfitMarginsFromModal() {
        const saveBtn = document.querySelector('#quick-profit-modal-overlay .btn-primary');
        toggleButtonLoading(saveBtn, true);

        try {
            const productBatch = db.batch(); // Batch for updating the 'products' collection
            const reportUpdatePayload = {}; // Object for updating today's report document
            let hasErrors = false;
            let errorMessages = [];

            // --- Step 1: Validation ---
            document.querySelectorAll('#quick-profit-products-container input[data-product-id]').forEach(input => {
                const productId = input.dataset.productId;
                if (input.classList.contains('invalid')) {
                    hasErrors = true;
                    const productName = shopProducts.find(p => p.id === productId)?.name || 'Unknown Product';
                    const label = input.id.includes('cost') ? 'Cost' : 'Profit';
                    errorMessages.push(`Invalid ${label} for "${productName}".`);
                }
            });

            if (hasErrors) {
                Swal.fire({
                    icon: 'error',
                    title: 'Validation Error',
                    html: `Please correct the highlighted input fields before saving:<br><ul>${errorMessages.map(msg => `<li>${msg}</li>`).join('')}</ul>`,
                    confirmButtonText: 'Understood'
                });
                return; // Stop execution
            }

            // --- Step 2: Prepare updates for both 'products' and today's 'report' ---
            const productInputs = Array.from(document.querySelectorAll('#quick-profit-products-container input[data-product-id]'));
            const productIdsToUpdate = [...new Set(productInputs.map(input => input.dataset.productId))];

            productIdsToUpdate.forEach(productId => {
                const costInput = document.getElementById(`quick-cost-${productId}`);
                const profitInput = document.getElementById(`quick-profit-margin-${productId}`);
                const newCost = parseFloat(costInput.value) || 0;
                const newProfitMargin = parseFloat(profitInput.value) || 0;

                // Prepare update for the main 'products' collection
                const productRef = db.collection('products').doc(productId);
                productBatch.update(productRef, { cost: newCost, profitMargin: newProfitMargin });

                // Prepare update for today's 'reports' document using dot notation
                reportUpdatePayload[`data.${productId}.cost`] = newCost;
                reportUpdatePayload[`data.${productId}.profitMargin`] = newProfitMargin;
            });

            // --- Step 3: Execute the updates concurrently if there's anything to update ---
            if (Object.keys(reportUpdatePayload).length > 0) {
                const reportRef = db.collection('reports').doc(todayDateString);
                await Promise.all([
                    productBatch.commit(),
                    reportRef.update(reportUpdatePayload)
                ]);
            }

            // --- Step 4: Refresh global data and close modal ---
            await loadProducts();
            Toast.fire({ icon: 'success', title: 'Prices updated successfully!' });
            closeQuickProfitMarginModal();
            // The UI will update automatically because of the real-time listener on the report.

        } catch (error) {
            Swal.fire('Error', handleFirestoreError(error), 'error');
        } finally {
            toggleButtonLoading(saveBtn, false);
        }
    }
    
    function renderProductList() { 
        const container = document.getElementById('product-list-container'); 
        if (shopProducts.length === 0) { 
            container.innerHTML = '<p class="text-center text-slate-500 py-4">No products yet.</p>'; 
            return; 
        } 
        container.innerHTML = shopProducts.map(p => {
            const calculatedSellingPrice = (p.cost || 0) + (p.profitMargin || 0);
            return `<div class="flex justify-between items-center p-2 bg-slate-100 rounded"><div><span class="font-medium">${p.name}</span> <span class="text-xs text-slate-500">(${p.category})</span> <span class="text-xs text-slate-400">Cost: ₱${formatCurrency(p.cost || 0)}</span> <span class="text-xs text-slate-400">Profit: ₱${formatCurrency(p.profitMargin || 0)}</span> <span class="text-xs font-semibold text-blue-600">Sell: ₱${formatCurrency(calculatedSellingPrice)}</span></div><div><button onclick="editProduct('${p.id}')" class="text-xs text-blue-600 mr-2 hover:underline">Edit</button><button onclick="deleteProduct('${p.id}')" class="text-xs text-red-600 hover:underline">Delete</button></div></div>`
        }).join(''); 
    }

    // This is the password-protected Profit Margin Management in Settings
    async function renderProfitMarginManagement() {
        const container = document.getElementById('profit-margin-list-container');
        container.innerHTML = '<div class="text-center p-4"><div class="loader"></div></div>';
        await loadProducts(); 

        if (shopProducts.length === 0) {
            container.innerHTML = '<p class="text-center text-slate-500 py-4">No products available to manage profit margins.</p>';
            return;
        }

        const groupedProducts = {};
        RICE_CATEGORIES.forEach(cat => groupedProducts[cat] = []);
        shopProducts.forEach(p => {
            if (!groupedProducts[p.category]) groupedProducts[p.category] = [];
            groupedProducts[p.category].push(p)
        });

        let html = '';
        RICE_CATEGORIES.forEach(cat => {
            const productsInCategory = groupedProducts[cat]?.sort((a, b) => a.name.localeCompare(b.name));
            if (productsInCategory && productsInCategory.length > 0) {
                const cleanCatClass = cat.replace(/\s+/g, '-');
                html += `<div class="card p-4 shadow-sm border-t-4 border-${cleanCatClass.toLowerCase()}">
                            <h4 class="font-bold text-lg text-${cleanCatClass.toLowerCase()}-700 mb-3">${cat}</h4>
                            <div class="space-y-2">`;
                productsInCategory.forEach(p => {
                    const currentSellingPrice = (p.cost || 0) + (p.profitMargin || 0);
                    html += `
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-2 items-center py-2 border-b last:border-b-0">
                        <span class="font-medium text-slate-700 md:col-span-1">${p.name}</span>
                        <div class="flex items-center gap-1">
                            <label for="cost-${p.id}" class="text-sm text-slate-600">Cost:</label>
                            <input type="number" id="cost-${p.id}" data-product-id="${p.id}" 
                                value="${formatCurrency(p.cost || 0)}" 
                                class="cost-input w-20 text-right text-sm" 
                                step="0.01" oninput="validateNumberInput(this); updateModalSellingPrice('${p.id}');">
                        </div>
                        <div class="flex items-center gap-1">
                            <label for="profit-margin-${p.id}" class="text-sm text-slate-600">Profit:</label>
                            <input type="number" id="profit-margin-${p.id}" data-product-id="${p.id}" 
                                value="${formatCurrency(p.profitMargin || 0)}" 
                                class="profit-margin-input w-20 text-right text-sm" 
                                step="0.01" oninput="validateNumberInput(this); updateModalSellingPrice('${p.id}');">
                        </div>
                        <span class="font-semibold text-blue-600 text-right">Sell: ₱<span id="selling-price-${p.id}">${formatCurrency(currentSellingPrice)}</span></span>
                    </div>`;
                });
                html += `   </div>
                        </div>`;
            }
        });
        container.innerHTML = html;
    }

    // --- UPDATED FUNCTION ---
    // This is the password-protected Save All Profit Margins in Settings
    async function saveAllProfitMargins() {
        const saveBtn = document.querySelector('#settings-profit-margin-content .btn-primary');
        toggleButtonLoading(saveBtn, true);

        try {
            const productBatch = db.batch(); // Batch for updating the 'products' collection
            const reportUpdatePayload = {}; // Object for updating today's report document
            let hasErrors = false;
            let errorMessages = [];

            // --- Step 1: Validation ---
            document.querySelectorAll('#profit-margin-list-container input[data-product-id]').forEach(input => {
                if (input.classList.contains('invalid')) {
                    hasErrors = true;
                    const productId = input.dataset.productId;
                    const productName = shopProducts.find(p => p.id === productId)?.name || 'Unknown Product';
                    const label = input.id.includes('cost') ? 'Cost' : 'Profit';
                    errorMessages.push(`Invalid ${label} for "${productName}".`);
                }
            });

            if (hasErrors) {
                Swal.fire({
                    icon: 'error',
                    title: 'Validation Error',
                    html: `Please correct the highlighted input fields before saving:<br><ul>${errorMessages.map(msg => `<li>${msg}</li>`).join('')}</ul>`,
                    confirmButtonText: 'Understood'
                });
                return; // Stop execution
            }

            // --- Step 2: Prepare updates for both 'products' and today's 'report' ---
            const productInputs = Array.from(document.querySelectorAll('#profit-margin-list-container input[data-product-id]'));
            const productIdsToUpdate = [...new Set(productInputs.map(input => input.dataset.productId))];

            productIdsToUpdate.forEach(productId => {
                const costInput = document.getElementById(`cost-${productId}`);
                const profitInput = document.getElementById(`profit-margin-${productId}`);
                const newCost = parseFloat(costInput.value) || 0;
                const newProfitMargin = parseFloat(profitInput.value) || 0;

                // Prepare update for the main 'products' collection
                const productRef = db.collection('products').doc(productId);
                productBatch.update(productRef, { cost: newCost, profitMargin: newProfitMargin });

                // Prepare update for today's 'reports' document using dot notation
                reportUpdatePayload[`data.${productId}.cost`] = newCost;
                reportUpdatePayload[`data.${productId}.profitMargin`] = newProfitMargin;
            });
            
            // --- Step 3: Execute the updates concurrently if there's anything to update ---
            if (Object.keys(reportUpdatePayload).length > 0) {
                const reportRef = db.collection('reports').doc(todayDateString);
                await Promise.all([
                    productBatch.commit(),
                    reportRef.update(reportUpdatePayload)
                ]);
            }

            // --- Step 4: Refresh global data and UI ---
            await loadProducts();
            Toast.fire({ icon: 'success', title: 'Prices updated successfully!' });
            renderProfitMarginManagement(); // Re-render the settings view

        } catch (error) {
            Swal.fire('Error', handleFirestoreError(error), 'error');
        } finally {
            toggleButtonLoading(saveBtn, false);
        }
    }


    function clearProductForm() { 
        document.getElementById('product-form-title').textContent = 'Add New Product'; 
        ['product-id', 'product-name', 'product-cost', 'product-profit-margin', 'product-minstock'].forEach(id => document.getElementById(id).value = ''); 
        document.getElementById('save-product-btn').textContent = 'Save Product'; 
    }

    async function saveProduct() { 
        const saveBtn = document.getElementById('save-product-btn'); 
        const nameInput = document.getElementById('product-name'); 
        const costInput = document.getElementById('product-cost'); 
        const profitMarginInput = document.getElementById('product-profit-margin'); 
        const minStockInput = document.getElementById('product-minstock'); 

        if (!nameInput.value.trim() || !costInput.value || !profitMarginInput.value) { 
            Toast.fire({ icon: 'error', title: 'Name, Cost, and Profit Margin are required.'}); 
            return; 
        } 
        if (costInput.classList.contains('invalid') || profitMarginInput.classList.contains('invalid')) {
            Toast.fire({ icon: 'error', title: 'Please correct invalid number inputs.'});
            return;
        }

        toggleButtonLoading(saveBtn, true); 
        try { 
            const productId = document.getElementById('product-id').value; 
            const docId = productId || 'prod_' + Date.now(); 
            const productData = { 
                id: docId, 
                name: nameInput.value.trim().toUpperCase(), 
                cost: parseFloat(costInput.value), 
                profitMargin: parseFloat(profitMarginInput.value), 
                category: document.getElementById('product-category').value, 
                minStock: parseInt(minStockInput.value) || 0 
            }; 
            await db.collection('products').doc(docId).set(productData); 
            Toast.fire({ icon: 'success', title: productId ? 'Product updated!' : 'Product added!' }); 
            await loadProducts(); 
            renderProductList(); 
            clearProductForm(); 
        } catch(error) { 
            Toast.fire({ icon: 'error', title: handleFirestoreError(error) }); 
        } finally { 
            toggleButtonLoading(saveBtn, false); 
        } 
    }

    function editProduct(id) { 
        const product = shopProducts.find(p => p.id === id); 
        if (product) { 
            document.getElementById('product-form-title').textContent = `Edit Product: ${product.name}`; 
            document.getElementById('product-id').value = product.id; 
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-cost').value = product.cost; 
            document.getElementById('product-profit-margin').value = product.profitMargin; 
            document.getElementById('product-minstock').value = product.minStock; 
            document.getElementById('product-category').value = product.category; 
            document.getElementById('save-product-btn').textContent = 'Update Product'; 
        } 
    }

    async function deleteProduct(id) { const { isConfirmed } = await Swal.fire({ title: 'Are you sure?', text: 'This product will be permanently deleted.', icon: 'warning', showCancelButton: true }); if (isConfirmed) { try { await db.collection('products').doc(id).delete(); Toast.fire({ icon: 'success', title: 'Product deleted!' }); await loadProducts(); renderProductList(); } catch (error) { Toast.fire({ icon: 'error', title: handleFirestoreError(error) }); } } }
    async function savePassword() { const saveBtn = document.getElementById('save-password-btn'); const current = document.getElementById('currentPassword').value; const newPass = document.getElementById('newPassword').value; const confirm = document.getElementById('confirmPassword').value; toggleButtonLoading(saveBtn, true); try { const securityDoc = await db.collection('settings').doc('security').get(); const storedPasswordHash = securityDoc.exists ? securityDoc.data().passwordHash : null; if (storedPasswordHash && hashPassword(current) !== storedPasswordHash) { Swal.fire('Error', 'Current password incorrect.', 'error'); return; } if (newPass.length < 4) { Swal.fire('Error', 'New password must be at least 4 characters.', 'error'); return; } if (newPass !== confirm) { Swal.fire('Error', 'New passwords do not match.', 'error'); return; } await db.collection('settings').doc('security').set({ passwordHash: hashPassword(newPass) }); Swal.fire('Success', 'Password changed!', 'success'); ['currentPassword', 'newPassword', 'confirmPassword'].forEach(id => document.getElementById(id).value = ''); } catch (error) { Swal.fire('Error', handleFirestoreError(error), 'error'); } finally { toggleButtonLoading(saveBtn, false); } }
    
    // Modified `promptForCategoryThenEdit` to open the quick profit modal for 'price'
    async function promptForCategoryThenEdit(editType, targetCategory = null) { 
        if (editType === 'price') { 
            openQuickProfitMarginModal(targetCategory); // Pass category to the quick modal
            return;
        }

        let selectedCategory = targetCategory;

        if (!selectedCategory) { // Only prompt if no targetCategory is provided (e.g., from global header)
            const { value: swalSelectedCategory } = await Swal.fire({
                title: 'Select a Category to Edit',
                input: 'select',
                inputOptions: {
                    all: 'All Categories',
                    ...Object.fromEntries(RICE_CATEGORIES.map(cat => [cat, cat]))
                },
                showCancelButton: true
            });
            if (!swalSelectedCategory) return;
            selectedCategory = swalSelectedCategory;
        }

        if (editType === 'begin' && selectedCategory) {
            editBeginningStock(selectedCategory);
        }
    }

    async function editBeginningStock(categoryFilter) { const password = await getPassword(); if (!password.success) return; const products = categoryFilter === 'all' ? shopProducts : shopProducts.filter(p => p.category === categoryFilter); const reportDoc = await db.collection('reports').doc(todayDateString).get(); if (!reportDoc.exists) return; const initialReport = reportDoc.data(); let modalHtml = '<div class="max-h-[60vh] overflow-y-auto p-2">'; products.forEach(p => { modalHtml += `<div class="grid grid-cols-2 gap-x-4 items-center mb-2" data-product-id="${p.id}"><label class="font-medium text-right">${p.name}</label><input type="number" value="${initialReport.data[p.id]?.begin || 0}" class="border p-1 w-full rounded"></div>`; }); modalHtml += '</div>'; const { isConfirmed } = await Swal.fire({ title: `Edit Beginning Stock`, html: modalHtml, showCancelButton: true, confirmButtonText: 'Update All' }); if (isConfirmed) { try { const updatePayload = {}; document.querySelectorAll('.swal2-html-container [data-product-id]').forEach(row => { const productId = row.dataset.productId; const newBegin = parseInt(row.querySelector('input').value) || 0; const diff = newBegin - (initialReport.data[productId]?.begin || 0); updatePayload[`data.${productId}.begin`] = newBegin; updatePayload[`data.${productId}.end`] = firebase.firestore.FieldValue.increment(diff); }); await db.collection('reports').doc(todayDateString).update(updatePayload); Toast.fire({ icon: 'success', title: 'Beginning stock updated!' }); } catch(error) { Toast.fire({ icon: 'error', title: handleFirestoreError(error) }); } } }
    
    async function renderPerformanceBreakdown() { 
        const tbody = document.getElementById('performance-tbody');
        tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4"><div class="loader"></div></td></tr>'; 
        
        try {
            const reportsSnapshot = await db.collection('reports').orderBy('date', 'desc').get();
            let tableHtml = '';
            for (const doc of reportsSnapshot.docs) { 
                const report = doc.data();
                const summary = calculateDailySummaryFromData(report); 
                const cashOnHand = report.cashOnHand || 0;
                const difference = cashOnHand - summary.totalSales; 
                
                let differenceHtml;
                if (!report.isFinalized && summary.totalSales === 0 && report.discountAmount === 0) { 
                    differenceHtml = '<span>-</span>';
                } else if (difference < 0) {
                    differenceHtml = `<span class="cash-short font-semibold">(₱${formatCurrency(Math.abs(difference))})</span>`;
                } else if (difference > 0) {
                    differenceHtml = `<span class="cash-over font-semibold">+₱${formatCurrency(difference)}</span>`;
                } else {
                    differenceHtml = `<span class="cash-balanced font-semibold">Balanced</span>`;
                }

                tableHtml += `
                <tr class="bg-white border-b"> 
                    <td class="py-4 px-6 font-medium text-slate-900">${dayjs(report.date).format('MMM D, YYYY')}</td> 
                    <td class="py-4 px-6 text-right">₱${formatCurrency(summary.totalSales)}</td> 
                    <td class="py-4 px-6 text-right text-green-600">₱${formatCurrency(summary.totalProfit)}</td> 
                    <td class="py-4 px-6 text-right">₱${formatCurrency(cashOnHand)}</td> 
                    <td class="py-4 px-6 text-right">${differenceHtml}</td>
                </tr>`; 
            } 
            tbody.innerHTML = tableHtml || '<tr><td colspan="5" class="text-center p-4">No reports found.</td></tr>'; 
        } catch (error) {
            console.error("Error rendering performance breakdown:", error);
            tbody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-red-500">${handleFirestoreError(error)}</td></tr>`; 
        }
    }
    
    async function backupAllData() {
        Swal.fire({ 
            title: 'Backing up data...', 
            html: 'Please wait while your data is prepared for download.',
            didOpen: () => Swal.showLoading(), 
            allowOutsideClick: false, 
            allowEscapeKey: false 
        });
        try {
            const backupData = {};
            for (const collectionName of COLLECTIONS_TO_BACKUP) {
                const snapshot = await db.collection(collectionName).get();
                backupData[collectionName] = {};
                snapshot.forEach(doc => {
                    backupData[collectionName][doc.id] = doc.data();
                });
            }
            const jsonString = JSON.stringify(backupData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `rice-inventory-backup-${dayjs().format('YYYY-MM-DD_HH-mm-ss')}.json`;
            document.body.appendChild(a); 
            a.click();
            document.body.removeChild(a); 
            URL.revokeObjectURL(url);
            Swal.close();
            Toast.fire({ icon: 'success', title: 'Backup successful! Check your downloads.' });
        } catch (error) {
            console.error("Backup failed:", error);
            Swal.fire('Backup Failed', handleFirestoreError(error), 'error');
        }
    }

    function restoreDataFromFile() { 
        document.getElementById('import-file-input').click(); 
    }

    async function handleFileSelect(event) { 
        const file = event.target.files[0]; 
        if (!file) return; 
        
        const { isConfirmed } = await Swal.fire({ 
            title: 'ARE YOU SURE?', 
            text: `This will permanently overwrite ALL current data with the selected backup file. This cannot be undone.`, 
            icon: 'warning', 
            showCancelButton: true, 
            confirmButtonColor: '#d33', 
            confirmButtonText: 'Yes, Overwrite Data!'
        }); 

        if (!isConfirmed) {
            event.target.value = null; 
            return;
        }

        const reader = new FileReader(); 
        reader.onload = async (e) => { 
            try { 
                const backupData = JSON.parse(e.target.result); 
                Swal.fire({ title: 'Restoring data...', text: 'Deleting old data...', didOpen: () => Swal.showLoading(), allowOutsideClick: false, allowEscapeKey: false }); 
                
                for (const collectionName of COLLECTIONS_TO_BACKUP) { 
                    const snapshot = await db.collection(collectionName).get(); 
                    if (!snapshot.empty) { 
                        const batch = db.batch(); 
                        snapshot.docs.forEach(doc => batch.delete(doc.ref)); 
                        await batch.commit(); 
                    } 
                } 
                
                Swal.update({ text: 'Uploading new data...' }); 
                
                for (const collectionName of COLLECTIONS_TO_BACKUP) { 
                    const collectionData = backupData[collectionName]; 
                    if (collectionData && Object.keys(collectionData).length > 0) { 
                        const batch = db.batch(); 
                        for (const docId in collectionData) { 
                            batch.set(db.collection(collectionName).doc(docId), collectionData[docId]); 
                        } 
                        await batch.commit(); 
                    } 
                } 
                await Swal.fire('Restore Complete', 'Page will now reload.', 'success'); 
                location.reload(); 
            } catch (error) { 
                console.error("Restore Failed:", error);
                Swal.fire('Restore Failed', error.message || 'Error restoring data. Ensure the backup file is valid.', 'error'); 
            } 
        }; 
        reader.readAsText(file); 
        event.target.value = null; 
    }

    async function factoryReset() { 
        const { isConfirmed } = await Swal.fire({ 
            title: 'ARE YOU SURE?', 
            text: `This action will permanently delete ALL data from the database. This cannot be undone.`, 
            icon: 'warning', 
            showCancelButton: true, 
            confirmButtonColor: '#d33', 
            confirmButtonText: 'Yes, Delete EVERYTHING!'
        }); 

        if (isConfirmed) { 
            Swal.fire({ title: 'Deleting all data...', didOpen: () => Swal.showLoading(), allowOutsideClick: false, allowEscapeKey: false }); 
            try {
                for (const collectionName of COLLECTIONS_TO_BACKUP) { 
                    const snapshot = await db.collection(collectionName).get(); 
                    if (!snapshot.empty) { 
                        const batch = db.batch(); 
                        snapshot.docs.forEach(doc => batch.delete(doc.ref)); 
                        await batch.commit(); 
                    } 
                } 
                await Swal.fire('Factory Reset Complete', 'All data has been deleted. The page will reload.', 'success'); 
                location.reload(); 
            } catch (error) {
                console.error("Factory Reset Failed:", error);
                Swal.fire('Factory Reset Failed', handleFirestoreError(error), 'error');
            }
        } 
    }

    async function resetSalesData() { const { isConfirmed } = await Swal.fire({ title: 'Reset Sales Data?', html: `Deletes all <strong>reports</strong> and <strong>expenses</strong>. Products and settings are kept.`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33' }); if (isConfirmed) { Swal.fire({ title: 'Resetting...', didOpen: () => Swal.showLoading() }); for (const collectionName of ['reports', 'expenses']) { const snapshot = await db.collection(collectionName).get(); if (!snapshot.empty) { const batch = db.batch(); snapshot.docs.forEach(doc => batch.delete(doc.ref)); await batch.commit(); } } await Swal.fire('Reset Complete', 'Page will reload.', 'success'); location.reload(); } }
    
    async function getExpensesForDate(dateString) { const expensesSnapshot = await db.collection('expenses').where('date', '==', dateString).get(); return expensesSnapshot.docs.reduce((acc, doc) => acc + doc.data().amount, 0); }
    async function getMonthlySummary(dateString) { 
        const startOfMonth = dayjs(dateString).startOf('month').format('YYYY-MM-DD'); 
        const endOfMonth = dayjs(dateString).endOf('month').format('YYYY-MM-DD'); 
        let totalProfit = 0; 
        let totalExpenses = 0; 
        
        const reportsSnapshot = await db.collection('reports').where('date', '>=', startOfMonth).where('date', '<=', endDate).get(); 
        
        reportsSnapshot.forEach(doc => { 
            const reportData = doc.data();
            const dailySummary = calculateDailySummaryFromData(reportData); 
            totalProfit += dailySummary.totalProfit;
        }); 

        const expensesSnapshot = await db.collection('expenses').where('date', '>=', startOfMonth).where('date', '<=', endDate).get(); 
        expensesSnapshot.forEach(doc => { 
            totalExpenses += doc.data().amount; 
        }); 
        
        return { monthlyNetProfit: totalProfit - totalExpenses }; 
    }

    /**
     * Toggles the visibility of product rows within a given category.
     * @param {string} categoryId The data-category-id of the category header row.
     */
    function toggleCategoryRows(categoryId) {
        const categoryHeader = document.querySelector(`tr[data-category-id="${categoryId}"]`);
        if (!categoryHeader) return;

        const toggleIcon = categoryHeader.querySelector('.toggle-icon');
        const isExpanded = !categoryHeader.classList.contains('collapsed'); // Assuming not having 'collapsed' means expanded

        if (isExpanded) {
            categoryHeader.classList.add('collapsed');
            toggleIcon.classList.add('rotated');
        } else {
            categoryHeader.classList.remove('collapsed');
            toggleIcon.classList.remove('rotated');
        }

        // Select all direct children rows of this category, including the sub-header and total row
        const childRows = document.querySelectorAll(`#inventory-tbody tr[data-category-child-of="${categoryId}"]`);
        
        childRows.forEach(row => {
            row.classList.toggle('hidden', isExpanded);
        });
    }


    // --- GLOBAL EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', initializeApp);
    const inventoryTbody = document.getElementById('inventory-tbody');
    inventoryTbody.addEventListener('focusin', (event) => { if (event.target.matches('input')) { event.target.closest('tr')?.classList.add('active-row'); } });
    inventoryTbody.addEventListener('focusout', (event) => { if (event.target.matches('input')) { event.target.closest('tr')?.classList.remove('active-row'); } });
    inventoryTbody.addEventListener('keydown', (event) => { const target = event.target; if (!target.matches('.new-stock-input, .end-input')) return; const currentTR = target.closest('tr'); let nextTR; let targetClass = target.classList.contains('new-stock-input') ? 'new-stock-input' : 'end-input'; if (event.key === 'ArrowDown' || event.key === 'Enter') { event.preventDefault(); nextTR = currentTR.nextElementSibling; while(nextTR && (!nextTR.querySelector(`.${targetClass}`) || nextTR.classList.contains('hidden'))) nextTR = nextTR.nextElementSibling; } else if (event.key === 'ArrowUp') { event.preventDefault(); nextTR = currentTR.previousElementSibling; while(nextTR && (!nextTR.querySelector(`.${targetClass}`) || nextTR.classList.contains('hidden'))) nextTR = nextTR.previousElementSibling; } if (nextTR) { const nextInput = nextTR.querySelector(`.${targetClass}`); if (nextInput && !nextInput.disabled) { nextInput.focus(); nextInput.select(); } } });
  </script>
</body>
</html>
``````
